<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - Gesti√≥n Municipal</title>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #1a1a1a; font-family: 'Segoe UI', Roboto, sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        /* 1. RADIO MINIMALISTA */
        #radio-control {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(0, 0, 0, 0.8); border: 2px solid #ffd700;
            border-radius: 30px; padding: 10px 20px; display: flex; align-items: center; gap: 15px;
            color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: 0.3s;
        }
        #radio-control i { cursor: pointer; font-size: 20px; }
        #radio-control:hover { transform: scale(1.05); }
        #volumen-slider { width: 80px; accent-color: #ffd700; cursor: pointer; }

        /* ESTADO GPS */
        #gps-status {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(0, 255, 0, 0.2); color: #00ff00;
            padding: 8px 15px; border-radius: 8px; border: 1px solid #00ff00;
            font-weight: bold; font-size: 14px; pointer-events: none;
        }

        /* BARRA DE HERRAMIENTAS */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 100;
        }
        .btn-tool {
            background: rgba(255, 255, 255, 0.9); border: none; padding: 15px;
            border-radius: 50%; width: 60px; height: 60px; font-size: 24px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.2s;
        }
        .btn-tool:active { transform: scale(0.9); }
        .btn-reporte { background: #ff3333; color: white; width: 70px; height: 70px; font-size: 28px; border: 3px solid white; animation: pulso 2s infinite; }
        
        @keyframes pulso { 0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 51, 51, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }

        /* 3. M√ìDULO DE REPORTE UNIFICADO (Overlay) */
        #modal-reporte {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-card {
            background: #222; width: 90%; max-width: 500px; padding: 25px;
            border-radius: 20px; border: 1px solid #444; text-align: center; color: white;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .modal-card h2 { color: #ffd700; margin-top: 0; }
        .input-field {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #555;
            background: #333; color: white; font-size: 16px; box-sizing: border-box;
        }
        /* VISOR DE C√ÅMARA REAL */
        #camera-feed {
            width: 100%; height: 250px; background: #000; margin: 15px 0;
            border-radius: 10px; border: 2px solid #ffd700; object-fit: cover;
        }
        #btn-capture { background: #ffd700; color: black; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; margin-top: 10px; cursor: pointer; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

    <div id="gps-status"><i class="fas fa-satellite-dish"></i> GPS: Buscando se√±al...</div>

    <div id="radio-control">
        <i class="fas fa-play" id="play-btn" onclick="toggleRadio()"></i>
        <input type="range" id="volumen-slider" min="0" max="1" step="0.1" value="0.5" oninput="ajustarVolumen(this.value)">
        <i class="fas fa-volume-up"></i>
    </div>

    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn-tool" onclick="camaraSerenito()"><i class="fas fa-walking"></i></button>
        <button class="btn-tool btn-reporte" onclick="abrirModal()"><i class="fas fa-camera"></i></button>
        <button class="btn-tool" onclick="camaraAerea()"><i class="fas fa-helicopter"></i></button>
    </div>

    <div id="modal-reporte">
        <div class="modal-card">
            <span class="close-modal" onclick="cerrarModal()">&times;</span>
            <h2>üö® Reporte Municipal</h2>
            <p id="direccion-detectada" style="color: #bbb; font-size: 14px;">üìç Ubicando...</p>
            
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="photo-canvas" style="display:none;"></canvas>
            
            <input type="text" id="mensaje-reporte" class="input-field" placeholder="Describe el problema (Ej: Bache, Basura)">
            <input type="email" id="email-vecino" class="input-field" placeholder="Tu correo (para copia de respaldo)">
            
            <button id="btn-capture" onclick="capturarYEnviar()">
                <i class="fas fa-paper-plane"></i> CAPTURAR Y ENVIAR
            </button>
        </div>
    </div>

    <script>
        // === 1. CONFIGURACI√ìN FIREBASE ===
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // === 2. L√ìGICA DE RADIO (Sin Iframe) ===
        const radioAudio = new Audio('https://yesstreaming.com/radio/8000/public');
        let radioPlaying = false;

        function toggleRadio() {
            const btn = document.getElementById('play-btn');
            if (!radioPlaying) {
                radioAudio.play().catch(e => console.log("Error stream:", e));
                btn.className = "fas fa-stop";
                btn.style.color = "#ff3333";
                radioPlaying = true;
            } else {
                radioAudio.pause();
                btn.className = "fas fa-play";
                btn.style.color = "white";
                radioPlaying = false;
            }
        }
        function ajustarVolumen(val) { radioAudio.volume = val; }

        // === 3. MOTOR GR√ÅFICO (SOLUCI√ìN PISO) ===
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, camera, personaje, animCaminar, destinoFinal;

        const crearEscena = function () {
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.05, 0.05, 0.1);
            
            // Gravedad REAL
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;

            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 1.5;
            
            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 140, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            return scene;
        };

        scene = crearEscena();

        // PISO BLINDADO
        const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2500, height: 2500}, scene);
        const matSuelo = new BABYLON.StandardMaterial("matSuelo", scene);
        matSuelo.diffuseTexture = new BABYLON.Texture("mapa.jpg", scene);
        suelo.material = matSuelo;
        suelo.checkCollisions = true; // Fundamental

        // EDIFICIOS
        const cargarEdificio = (file, x, z, scale, rot) => {
            BABYLON.SceneLoader.ImportMesh("", "./", file, scene, (m) => {
                let mesh = m[0];
                mesh.scaling = new BABYLON.Vector3(scale, scale, scale);
                mesh.position = new BABYLON.Vector3(x, 0, z); // Siempre al piso
                mesh.rotation.y = rot;
                mesh.checkCollisions = true;
            });
        };
        cargarEdificio("municipalidad.glb", 610, 160, 2, Math.PI); // Ajusta escala si es necesario
        cargarEdificio("intendencia.glb", 430, 410, 2, 0);

        // SERENITO (Soluci√≥n Definitiva de Altura)
        BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", scene, function (meshes, ps, sk, anims) {
            personaje = meshes[0];
            personaje.scaling = new BABYLON.Vector3(-10, 10, 10);
            
            // POSICI√ìN INICIAL SEGURA (Un poco arriba para que caiga)
            personaje.position = new BABYLON.Vector3(0, 2, 0);
            
            // EL SECRETO: EllipsoidOffset (Sube el centro de colisi√≥n al pecho)
            personaje.ellipsoid = new BABYLON.Vector3(1, 2, 1);
            personaje.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0); 
            
            personaje.checkCollisions = true;
            personaje.applyGravity = true; 
            
            camera.lockedTarget = personaje;
            if (anims && anims.length > 0) { animCaminar = anims[0]; animCaminar.stop(); }
        });

        // MOVIMIENTO CLICK-TO-MOVE
        scene.onPointerDown = (evt, pick) => { if (pick.hit && pick.pickedMesh === suelo) destinoFinal = pick.pickedPoint; };
        scene.onBeforeRenderObservable.add(() => {
            if (!personaje || !destinoFinal) return;
            let diff = destinoFinal.subtract(personaje.position);
            diff.y = 0;
            if (diff.length() > 1) {
                let angulo = Math.atan2(diff.x, diff.z);
                let rotDif = angulo - personaje.rotation.y;
                while (rotDif > Math.PI) rotDif -= Math.PI * 2;
                while (rotDif < -Math.PI) rotDif += Math.PI * 2;
                personaje.rotation.y += rotDif * 0.1;
                
                // Mover con colisiones activas
                let direccion = diff.normalize();
                personaje.moveWithCollisions(direccion.scale(0.8)); // Velocidad
                
                if (animCaminar && !animCaminar.isPlaying) animCaminar.play(true);
            } else {
                if (animCaminar) animCaminar.stop();
                destinoFinal = null;
            }
        });

        // === 4. L√ìGICA DE C√ÅMARA Y REPORTE ===
        const videoFeed = document.getElementById('camera-feed');
        let streamActivo = null;
        let coordsActuales = null;

        function abrirModal() {
            document.getElementById('modal-reporte').style.display = 'flex';
            // ACTIVAR C√ÅMARA
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    streamActivo = stream;
                    videoFeed.srcObject = stream;
                });
            }
            // OBTENER GPS
            navigator.geolocation.getCurrentPosition(pos => {
                coordsActuales = pos.coords;
                // Geocodificaci√≥n Inversa
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('direccion-detectada').innerText = `üìç ${data.address.road || 'Calle'}, ${data.address.house_number || ''}`;
                });
            });
        }

        function cerrarModal() {
            document.getElementById('modal-reporte').style.display = 'none';
            if (streamActivo) {
                streamActivo.getTracks().forEach(track => track.stop());
            }
        }

        function capturarYEnviar() {
            const mensaje = document.getElementById('mensaje-reporte').value;
            const emailVecino = document.getElementById('email-vecino').value;
            
            if (!mensaje) return alert("Por favor describe el problema");

            // 1. CAPTURAR FOTO DEL VIDEO
            const canvasFoto = document.getElementById('photo-canvas');
            canvasFoto.width = videoFeed.videoWidth;
            canvasFoto.height = videoFeed.videoHeight;
            canvasFoto.getContext('2d').drawImage(videoFeed, 0, 0);
            const fotoBase64 = canvasFoto.toDataURL('image/jpeg'); // Foto lista para enviar

            // 2. GUARDAR EN FIREBASE
            db.collection("reportes_finales").add({
                mensaje: mensaje,
                email_contacto: emailVecino,
                lat: coordsActuales ? coordsActuales.latitude : 0,
                lon: coordsActuales ? coordsActuales.longitude : 0,
                fecha: new Date(),
                imagen: "Guardada en Base64 (Simulada)" // Aqu√≠ ir√≠a la subida a Storage si estuviera activo
            }).then(() => {
                // 3. ENVIAR COPIA AL CORREO (Truco mailto para asegurar entrega)
                const asunto = `üö® Nuevo Reporte: ${mensaje.substring(0, 20)}...`;
                const cuerpo = `Hola vecinoslaserenachile@gmail.com,\n\nNuevo reporte ciudadano:\n\nProblema: ${mensaje}\nUbicaci√≥n: https://maps.google.com/?q=${coordsActuales.latitude},${coordsActuales.longitude}\nContacto Vecino: ${emailVecino}\n\n(Adjunta la foto manualmente si es necesario)`;
                
                window.location.href = `mailto:vecinoslaserenachile@gmail.com?cc=${emailVecino}&subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
                
                alert("‚úÖ Reporte registrado en sistema.\nSe abrir√° tu correo para confirmar el env√≠o.");
                cerrarModal();
            });
        }

        window.camaraSerenito = () => { camera.lockedTarget = personaje; camera.radius = 120; }
        window.camaraAerea = () => { camera.lockedTarget = null; camera.setPosition(new BABYLON.Vector3(500, 800, 500)); camera.setTarget(new BABYLON.Vector3(500, 0, 300)); }

        window.addEventListener("resize", () => engine.resize());
        engine.runRenderLoop(() => scene.render());

    </script>
</body>
</html>
