<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - v37 Precisi√≥n Ciudadana</title>
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%22 height=%22100%22 fill=%22red%22/><text x=%2250%%22 y=%2255%%22 font-family=%22Arial%22 font-weight=%22bold%22 font-size=%2250%22 fill=%22white%22 text-anchor=%22middle%22 dominant-baseline=%22middle%22>LS</text></svg>">

    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        .top-ui { position: absolute; top: 20px; width: 94%; left: 3%; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .radio-card { background: rgba(0,0,0,0.9); color: #ffd700; padding: 5px 15px; border-radius: 50px; display: flex; align-items: center; gap: 10px; border: 2px solid #ffd700; pointer-events: auto; }
        .login-card { background: white; color: #333; padding: 8px 15px; border-radius: 50px; font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer; pointer-events: auto; border: 2px solid white; }

        #toolbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; }
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: white; font-size: 24px; cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.3); color: #444; }
        .btn-main { background: #ff3333; color: white; border: 4px solid white; transform: translateY(-10px); }

        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .box { background: #111; width: 90%; max-width: 480px; padding: 20px; border-radius: 20px; color: white; text-align: center; border: 1px solid #333; max-height: 90vh; overflow-y: auto; }
        
        .f-input { width: 100%; padding: 12px; margin: 6px 0; background: #222; border: 1px solid #444; color: white; border-radius: 8px; box-sizing: border-box; font-size: 14px; }
        .f-label { display: block; text-align: left; font-size: 11px; color: #ffd700; margin-top: 5px; text-transform: uppercase; font-weight: bold; }

        .report-card { background: #222; padding: 15px; margin: 12px 0; border-radius: 12px; border-left: 5px solid #ffd700; text-align: left; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }
        .report-img { width: 100%; border-radius: 8px; margin-top: 10px; border: 1px solid #444; }
        #cam { width: 100%; height: 180px; background: #000; border-radius: 12px; margin-bottom: 10px; border: 2px solid #ffd700; object-fit: cover; }
        
        /* ESTILO HORA */
        .time-badge { font-size: 11px; background: #333; color: #ffd700; padding: 2px 8px; border-radius: 4px; margin-left: 10px; border: 1px solid #555; }
    </style>
</head>
<body>

    <div class="top-ui">
        <div class="radio-card">
            <i class="fas fa-play" id="icon-play" onclick="toggleRadio()"></i>
            <span style="font-size:12px; font-weight:bold;">RD MLS</span>
            <input type="range" style="width:50px;" min="0" max="1" step="0.1" value="0.8" oninput="document.getElementById('audio-player').volume=this.value">
        </div>
        <div class="login-card" onclick="login()">
            <img id="u-img" src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" style="width:25px; border-radius:50%;"> 
            <span id="u-name">Acceder</span>
        </div>
    </div>

    <audio id="audio-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>
    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn" onclick="verHistorial()"><i class="fas fa-history"></i></button>
        <button class="btn btn-main" onclick="abrirReporte()"><i class="fas fa-camera"></i></button>
        <button class="btn" onclick="resetCamara()"><i class="fas fa-street-view"></i></button>
    </div>

    <div id="modal-rep" class="modal"><div class="box">
        <h3 style="color:#ffd700; margin:0 0 10px 0;">NUEVO REPORTE</h3>
        <video id="cam" autoplay playsinline muted></video>
        <canvas id="compressor-canvas" style="display:none;"></canvas>
        
        <div style="display: flex; gap: 10px;">
            <div style="flex:1;"><span class="f-label">Nombre</span><input type="text" id="f-nom" class="f-input" placeholder="Nombre"></div>
            <div style="flex:1;"><span class="f-label">Apellido</span><input type="text" id="f-ape" class="f-input" placeholder="Apellido"></div>
        </div>
        
        <span class="f-label">Tel√©fono</span>
        <input type="tel" id="f-tel" class="f-input" placeholder="+56 9 ...">
        
        <span class="f-label">Email Actualizado</span>
        <input type="email" id="f-mail" class="f-input" placeholder="correo@ejemplo.com">
        
        <span class="f-label">¬øQu√© sucede?</span>
        <input type="text" id="f-desc" class="f-input" placeholder="Descripci√≥n breve">

        <button id="btn-env" onclick="enviarReporte()" style="width:100%; padding:16px; background:#ffd700; border:none; font-weight:bold; border-radius:12px; color:black; font-size:16px; margin-top:10px;">ENVIAR AHORA</button>
        <button onclick="cerrarModal('modal-rep')" style="margin-top:15px; background:none; border:none; color:#777; cursor:pointer;">Cancelar</button>
    </div></div>

    <div id="modal-hist" class="modal"><div class="box">
        <h3 style="color:#ffd700;">HISTORIAL DE GESTIONES</h3>
        <div id="lista" style="max-height:60vh; overflow-y:auto; padding-right:10px;"></div>
        <button onclick="document.getElementById('modal-hist').style.display='none'" style="margin-top:20px; background:#444; color:white; padding:12px; border:none; border-radius:10px; width:100%;">Cerrar</button>
    </div></div>

    <script>
        // 1. FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let userActual = null;

        auth.onAuthStateChanged(u => {
            if(u) {
                userActual = u;
                document.getElementById('u-name').innerText = u.displayName.split(' ')[0];
                document.getElementById('u-img').src = u.photoURL;
                document.getElementById('f-nom').value = u.displayName.split(' ')[0] || "";
                document.getElementById('f-mail').value = u.email || "";
            }
        });

        window.login = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        // 2. MOTOR 3D BABYLON
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, camera, serenito, animCaminar, destinoFinal;

        const crearEscena = function () {
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color3(0.53, 0.81, 0.92);
            s.gravity = new BABYLON.Vector3(0, -0.9, 0);
            s.collisionsEnabled = true;
            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 140, BABYLON.Vector3.Zero(), s);
            camera.upperBetaLimit = Math.PI / 2.2; 
            camera.attachControl(canvas, true);
            new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), s);
            const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2500, height: 2500}, s);
            const mat = new BABYLON.StandardMaterial("m", s);
            mat.diffuseTexture = new BABYLON.Texture("mapa.jpg", s);
            suelo.material = mat;
            suelo.checkCollisions = true;

            const load = (f, x, z, sc, r) => {
                BABYLON.SceneLoader.ImportMesh("", "./", f, s, (m) => {
                    let root = new BABYLON.TransformNode("r", s);
                    m[0].parent = root;
                    const b = m[0].getHierarchyBoundingVectors(true);
                    const scale = sc / Math.max(b.max.x-b.min.x, b.max.y-b.min.y, b.max.z-b.min.z);
                    root.scaling = new BABYLON.Vector3(scale, scale, scale);
                    root.rotation.y = r;
                    root.position = new BABYLON.Vector3(x, -b.min.y*scale, z);
                });
            };
            load("municipalidad.glb", 610, 160, 170, Math.PI);
            load("intendencia.glb", 430, 410, 190, 0);

            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m, ps, sk, a) => {
                serenito = m[0];
                serenito.rotationQuaternion = null;
                serenito.scaling = new BABYLON.Vector3(-10, 10, 10);
                serenito.position = new BABYLON.Vector3(0, 5, 0);
                serenito.checkCollisions = true;
                serenito.applyGravity = true;
                camera.lockedTarget = serenito;
                if(a && a.length > 0) { animCaminar = a[0]; animCaminar.stop(); }
            });

            s.onPointerDown = (evt, pick) => { if(pick.hit && pick.pickedMesh === suelo) destinoFinal = pick.pickedPoint; };
            s.onBeforeRenderObservable.add(() => {
                if(!serenito || !destinoFinal) return;
                let diff = destinoFinal.subtract(serenito.position);
                diff.y = 0;
                if(diff.length() > 1.2) {
                    let angleDest = Math.atan2(diff.x, diff.z);
                    let rotDiff = angleDest - serenito.rotation.y;
                    while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
                    while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;
                    if(Math.abs(rotDiff) > 0.05) {
                        serenito.rotation.y += Math.sign(rotDiff) * 0.12;
                        if(animCaminar) animCaminar.stop();
                    } else {
                        serenito.rotation.y = angleDest;
                        serenito.moveWithCollisions(diff.normalize().scale(0.9));
                        if(animCaminar && !animCaminar.isPlaying) animCaminar.play(true);
                    }
                } else { if(animCaminar) animCaminar.stop(); destinoFinal = null; }
            });
            return s;
        };
        scene = crearEscena();
        engine.runRenderLoop(() => scene.render());

        // 3. REPORTES CON HORA Y FECHA
        let streamActivo = null;

        async function abrirReporte() {
            if(!userActual) return alert("Accede con Google primero.");
            document.getElementById('modal-rep').style.display = 'flex';
            try {
                streamActivo = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } });
                document.getElementById('cam').srcObject = streamActivo;
            } catch (err) { alert("Permite el acceso a la c√°mara."); }
        }

        async function enviarReporte() {
            const btn = document.getElementById('btn-env');
            const video = document.getElementById('cam');
            const canvasComp = document.getElementById('compressor-canvas');
            
            const nom = document.getElementById('f-nom').value;
            const ape = document.getElementById('f-ape').value;
            const tel = document.getElementById('f-tel').value;
            const mail = document.getElementById('f-mail').value;
            const desc = document.getElementById('f-desc').value;

            if(!nom || !ape || !tel || !mail || !desc) return alert("Por favor, completa todos los datos de contacto.");

            btn.innerText = "REGISTRANDO...";
            btn.disabled = true;

            // COMPRESI√ìN v35
            canvasComp.width = 640;
            canvasComp.height = 480;
            const ctx = canvasComp.getContext('2d');
            ctx.drawImage(video, 0, 0, 640, 480);
            const fotoComprimida = canvasComp.toDataURL('image/jpeg', 0.5); 

            try {
                await db.collection("incidencias").add({
                    uid: userActual.uid,
                    nombre_real: nom,
                    apellido_real: ape,
                    telefono: tel,
                    email_contacto: mail,
                    descripcion: desc,
                    foto: fotoComprimida,
                    fecha: new Date(), // GUARDA D√çA Y HORA EXACTA
                    estado: "Ingresado"
                });
                alert("¬°Reporte oficial ingresado!");
                cerrarModal('modal-rep');
            } catch (err) { 
                alert("Error: " + err.message); 
            } finally { 
                btn.innerText = "ENVIAR REPORTE"; 
                btn.disabled = false; 
            }
        }

        function verHistorial() {
            if(!userActual) return alert("Accede primero.");
            document.getElementById('modal-hist').style.display = 'flex';
            const lista = document.getElementById('lista');
            lista.innerHTML = "<p style='color:gold;'>Cargando todas tus gestiones...</p>";

            db.collection("incidencias")
                .where("uid", "==", userActual.uid)
                .orderBy("fecha", "desc")
                .get()
                .then(snap => {
                    lista.innerHTML = "";
                    if(snap.empty) { lista.innerHTML = "Sin registros a√∫n."; return; }
                    snap.forEach(doc => {
                        const d = doc.data();
                        const img = d.foto ? `<img src="${d.foto}" class="report-img">` : "";
                        
                        // FORMATEAR FECHA Y HORA
                        const fechaObj = d.fecha.toDate();
                        const fecha = fechaObj.toLocaleDateString();
                        const hora = fechaObj.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});

                        lista.innerHTML += `
                            <div class="report-card">
                                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                                    <b>üìÖ ${fecha} <span class="time-badge">‚è∞ ${hora}</span></b>
                                    <span style="font-size:10px; background:#444; padding:2px 6px; border-radius:4px; color:gold;">${d.estado}</span>
                                </div>
                                <div style="font-size:12px; color:#aaa; margin-bottom:5px;">
                                    <i class="fas fa-id-badge"></i> Vecino: <b>${d.nombre_real} ${d.apellido_real}</b>
                                </div>
                                <span style="font-size:14px; display:block;">${d.descripcion}</span>
                                ${img}
                            </div>`;
                    });
                });
        }

        function cerrarModal(id) { 
            document.getElementById(id).style.display = 'none'; 
            if(streamActivo) streamActivo.getTracks().forEach(t => t.stop()); 
            document.getElementById('f-desc').value = ""; 
        }
        window.toggleRadio = () => { const a = document.getElementById('audio-player'); if(a.paused) a.play(); else a.pause(); };
        window.resetCamara = () => { if(serenito) camera.lockedTarget = serenito; };
        window.addEventListener("resize", () => engine.resize());

    </script>
</body>
</html>
