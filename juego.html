<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VLS - Centro de Control (Estable)</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --serena-red: #e63946; --serena-gold: #ffd700; --dark: #0f0f0f; --panel-bg: #141414; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--dark); color: white; overflow: hidden; }
        
        #master-grid {
            display: grid;
            height: 100vh;
            width: 100vw;
            grid-template-columns: 1fr;
            grid-template-rows: 15% 50% 35%; /* Móvil */
        }

        @media (min-width: 1024px) {
            #master-grid {
                grid-template-columns: 20% 50% 30%; /* Escritorio */
                grid-template-rows: 1fr;
            }
        }

        .panel { background: var(--panel-bg); border-right: 1px solid #333; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* COL IZQ: HUB */
        #panel-hub { padding: 20px; text-align: center; justify-content: center; }
        .radio-widget { background: linear-gradient(135deg, #222, #000); padding: 20px; border-radius: 20px; border: 2px solid var(--serena-red); box-shadow: 0 0 20px rgba(230, 57, 70, 0.2); }
        .btn-play { width: 60px; height: 60px; border-radius: 50%; border: none; background: var(--serena-gold); cursor: pointer; margin-top: 15px; font-size: 24px; color: var(--dark); transition: 0.3s; }
        .btn-play:hover { transform: scale(1.05); box-shadow: 0 0 15px var(--serena-gold); }
        
        /* COL CENTRO: 3D */
        #renderCanvas { width: 100%; height: 100%; outline: none; background: #000; }
        .status-badge { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.8); padding: 8px 20px; border-radius: 30px; font-size: 12px; font-weight: bold; border: 1px solid var(--serena-gold); color: var(--serena-gold); letter-spacing: 1px; }

        /* COL DER: GESTIÓN */
        #map { flex-grow: 1; width: 100%; }
        #gestion-ui { background: #1a1a1a; padding: 20px; border-top: 3px solid var(--serena-red); }
        .f-input { width: 100%; padding: 12px; margin: 8px 0; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; font-size: 14px; }
        .btn-action { width: 100%; padding: 14px; background: var(--serena-red); border: none; color: white; font-weight: bold; border-radius: 10px; cursor: pointer; margin-top: 15px; font-size: 16px; transition: 0.2s; }
        .btn-action:active { transform: scale(0.98); }
        .btn-volver { position: absolute; top: 15px; right: 15px; z-index: 1000; background: white; color: var(--dark); border: none; padding: 10px 15px; border-radius: 30px; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

    <audio id="master-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <div id="master-grid">
        
        <div class="panel" id="panel-hub">
            <div class="radio-widget">
                <i class="fas fa-tower-broadcast fa-3x" style="color:var(--serena-red);"></i>
                <h3 style="margin: 15px 0 5px; color:white; letter-spacing: 1px;">RADIO DIGITAL</h3>
                <small style="color:#888; text-transform: uppercase;">Municipalidad La Serena</small>
                <br>
                <button class="btn-play" onclick="toggleAudio()"><i class="fas fa-play" id="play-icon"></i></button>
            </div>
            </div>

        <div class="panel">
            <canvas id="renderCanvas"></canvas>
            <div class="status-badge" id="status-text"><i class="fas fa-map-pin"></i> CENTRO HISTÓRICO</div>
        </div>

        <div class="panel">
            <div style="position:relative; height:60%;">
                <div id="map"></div>
                <button class="btn-volver" onclick="resetTour()"><i class="fas fa-sync-alt"></i> VOLVER AL CENTRO</button>
            </div>
            
            <div id="gestion-ui">
                <h4 style="margin-top:0; color:var(--serena-gold); text-transform: uppercase;">Reportar Aquí</h4>
                
                <input type="text" id="g-nom" class="f-input" placeholder="Tu Nombre y Apellido">
                <textarea id="g-desc" class="f-input" rows="2" placeholder="Describe la situación..."></textarea>
                
                <label class="btn-action" style="background:#333; border:2px dashed #555; color:#ccc; display:block; text-align:center; padding: 12px; margin-top: 10px; cursor:pointer;">
                    <i class="fas fa-camera"></i> ADJUNTAR FOTO EVIDENCIA
                    <input type="file" id="file-cam" style="display:none" accept="image/*" capture="environment" onchange="alert('Foto seleccionada. Listo para enviar.')">
                </label>

                <button class="btn-action" onclick="enviarReporte()">ENVIAR REPORTE OFICIAL</button>
            </div>
        </div>

    </div>

    <script>
        // CONFIG
        const CENTER = [-29.9027, -71.2520];
        let isTourMode = true;

        // FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // RADIO FUNCIONAL
        const player = document.getElementById("master-player");
        const playIcon = document.getElementById("play-icon");
        function toggleAudio() {
            if(player.paused) { player.play(); playIcon.className = "fas fa-pause"; }
            else { player.pause(); btnIcon.className = "fas fa-play"; }
        }

        // MOTOR 3D (Intento de recuperación de rutas)
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, serenito, muni, intendencia;

        const crearEscena = function() {
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color3(0.08, 0.08, 0.1); 
            const cam = new BABYLON.ArcRotateCamera("c", -Math.PI/2, Math.PI/2.5, 130, BABYLON.Vector3.Zero(), s);
            cam.attachControl(canvas, true);
            
            // Iluminación mejorada
            const hemi = new BABYLON.HemisphericLight("hemi", new BABYLON.Vector3(0, 1, 0), s);
            hemi.intensity = 0.8;
            const dir = new BABYLON.DirectionalLight("dir", new BABYLON.Vector3(-1, -2, -1), s);
            dir.position = new BABYLON.Vector3(20, 40, 20);
            dir.intensity = 0.5;

            // SUELO CON TEXTURA (Clave para la gráfica)
            const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 1500, height: 1500}, s);
            const matSuelo = new BABYLON.StandardMaterial("matSuelo", s);
            // IMPORTANTE: Asegúrate que mapa.jpg esté en la raíz
            matSuelo.diffuseTexture = new BABYLON.Texture("mapa.jpg", s); 
            matSuelo.specularColor = BABYLON.Color3.Black();
            suelo.material = matSuelo;

            // CARGA DE MODELOS (Rutas relativas simples "./")
            BABYLON.SceneLoader.ImportMesh("", "./", "municipalidad.glb", s, (m) => {
                muni = m[0];
                muni.position = new BABYLON.Vector3(50, 0, 50);
                muni.scaling = new BABYLON.Vector3(4,4,4);
                muni.rotation.y = Math.PI;
            });
            BABYLON.SceneLoader.ImportMesh("", "./", "intendencia.glb", s, (m) => {
                intendencia = m[0];
                intendencia.position = new BABYLON.Vector3(-50, 0, -30);
                intendencia.scaling = new BABYLON.Vector3(4,4,4);
            });
            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m) => {
                serenito = m[0];
                serenito.scaling = new BABYLON.Vector3(8, 8, -8); // Espejado para que mire al frente
                cam.lockedTarget = serenito;
            });

            return s;
        };
        scene = crearEscena();
        engine.runRenderLoop(() => scene.render());

        // MAPA Y SINCRONIZACIÓN
        let map, marker;
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView(CENTER, 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            const pinIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', iconSize: [32, 32], iconAnchor: [16, 32] });
            marker = L.marker(CENTER, {draggable: true, icon: pinIcon}).addTo(map);

            marker.on('drag', (e) => sync3D(e.target.getLatLng()));
            map.on('move', () => { const c = map.getCenter(); marker.setLatLng(c); sync3D(c); });
        }
        initMap();

        function sync3D(pos) {
            if(!serenito) return;
            const dist = map.distance(pos, L.latLng(CENTER));
            
            // Mover a Serenito
            const scale = 2; // Factor de escala mapa -> 3D
            serenito.position.x = (pos.lng - CENTER[1]) * 111320 * scale; // Aprox metros
            serenito.position.z = (pos.lat - CENTER[0]) * 111320 * scale;

            // Lógica de Zona (300 metros)
            if(dist > 300 && isTourMode) {
                if(muni) muni.setEnabled(false);
                if(intendencia) intendencia.setEnabled(false);
                document.getElementById("status-text").innerHTML = "<i class='fas fa-city'></i> ZONA URBANA";
                document.getElementById("status-text").style.borderColor = "#ff3333";
                isTourMode = false;
            } else if(dist <= 300 && !isTourMode) {
                if(muni) muni.setEnabled(true);
                if(intendencia) intendencia.setEnabled(true);
                document.getElementById("status-text").innerHTML = "<i class='fas fa-map-pin'></i> CENTRO HISTÓRICO";
                document.getElementById("status-text").style.borderColor = "var(--serena-gold)";
                isTourMode = true;
            }
        }

        window.resetTour = function() { map.setView(CENTER, 16); };

        window.enviarReporte = async function() {
            const data = {
                vecino: document.getElementById('g-nom').value,
                desc: document.getElementById('g-desc').value,
                lat: marker.getLatLng().lat,
                lon: marker.getLatLng().lng,
                fecha: new Date()
                // TODO: Integrar compresión de foto aquí
            };
            if(!data.vecino || !data.desc) return alert("Completa los campos obligatorios.");
            await db.collection("incidencias").add(data);
            alert("¡Reporte enviado exitosamente!");
            location.reload();
        };

        window.addEventListener("resize", () => { engine.resize(); map.invalidateSize(); });
    </script>
</body>
</html>
