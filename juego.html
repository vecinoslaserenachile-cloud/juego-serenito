<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - Smart City</title>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        /* UI SUPERIOR */
        .top-ui { position: absolute; top: 20px; width: 94%; left: 3%; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .pointer { pointer-events: auto; }

        /* RADIO PERFECTA (Compacta) */
        .radio-card {
            background: rgba(0,0,0,0.9); color: #ffd700; padding: 8px 15px; border-radius: 50px;
            display: flex; align-items: center; gap: 10px; border: 2px solid #ffd700;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5); pointer-events: auto; transition: transform 0.2s;
        }
        .radio-card:hover { transform: scale(1.05); }
        
        /* LOGIN USUARIO */
        .login-card {
            background: white; color: #333; padding: 8px 20px; border-radius: 50px;
            font-weight: bold; display: flex; align-items: center; gap: 8px; cursor: pointer;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); pointer-events: auto; border: 2px solid white;
        }
        .user-pic { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; border: 1px solid #ddd; }

        /* BARRA INFERIOR */
        #toolbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; }
        .btn { width: 65px; height: 65px; border-radius: 50%; border: none; background: white; font-size: 24px; cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.3); color: #444; transition: 0.2s; }
        .btn:active { transform: scale(0.9); }
        .btn-main { background: #ff3333; color: white; border: 4px solid white; transform: translateY(-15px); }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .box { background: #222; width: 90%; max-width: 450px; padding: 25px; border-radius: 15px; color: white; text-align: center; border: 1px solid #444; box-shadow: 0 20px 50px rgba(0,0,0,0.8); }
        input { width: 100%; padding: 12px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; box-sizing: border-box; border-radius: 5px; }
    </style>
</head>
<body>

    <div class="top-ui">
        <div class="radio-card">
            <i class="fas fa-play" id="icon-play" onclick="toggleRadio()" style="cursor:pointer; font-size:18px;"></i>
            <span style="font-size:13px; font-weight:bold;">RD MLS</span>
            <input type="range" style="width:60px; accent-color:#ffd700;" min="0" max="1" step="0.1" value="1" oninput="document.getElementById('audio-player').volume=this.value">
        </div>
        
        <div class="login-card" onclick="login()">
            <img id="u-img" src="https://cdn-icons-png.flaticon.com/512/2991/2991148.png" class="user-pic"> 
            <span id="u-name">Acceder</span>
        </div>
    </div>

    <audio id="audio-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn" onclick="verHistorial()" title="Mis Reportes"><i class="fas fa-clipboard-list"></i></button>
        <button class="btn btn-main" onclick="abrirReporte()" title="Reportar"><i class="fas fa-camera"></i></button>
        <button class="btn" onclick="resetCamara()" title="Seguir a Serenito"><i class="fas fa-street-view"></i></button>
    </div>

    <div id="modal-rep" class="modal">
        <div class="box">
            <h2 style="color:gold; margin-top:0;">üì∑ Nuevo Reporte</h2>
            <p id="gps-status" style="font-size:12px; color:#aaa;">üìç Ubicando...</p>
            <video id="cam" autoplay playsinline style="width:100%; height:220px; background:black; margin-bottom:10px; border:2px solid gold; border-radius:8px; object-fit:cover;"></video>
            <canvas id="snap" style="display:none;"></canvas>
            <input type="text" id="desc" placeholder="Describe el problema (Ej: Bache)...">
            <button onclick="enviar()" style="width:100%; padding:15px; background:gold; border:none; font-weight:bold; cursor:pointer; color:black; border-radius:8px;">ENVIAR REPORTE</button>
            <button onclick="document.getElementById('modal-rep').style.display='none'" style="margin-top:15px; background:none; border:none; color:#aaa; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div id="modal-hist" class="modal">
        <div class="box">
            <h3>üìÇ Mis Reportes</h3>
            <div id="lista" style="text-align:left; max-height:300px; overflow-y:auto;">Cargando...</div>
            <button onclick="document.getElementById('modal-hist').style.display='none'" style="margin-top:15px; background:none; border:none; color:#aaa; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <script>
        // === 1. FIREBASE CONFIG ===
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        let userCurrent = null;

        // LOGIN SYSTEM
        auth.onAuthStateChanged(u => {
            if(u) {
                userCurrent = u;
                document.getElementById('u-name').innerText = u.displayName.split(' ')[0];
                document.getElementById('u-img').src = u.photoURL;
            } else {
                userCurrent = null;
                document.getElementById('u-name').innerText = "Acceder";
                document.getElementById('u-img').src = "https://cdn-icons-png.flaticon.com/512/2991/2991148.png";
            }
        });

        window.login = () => {
            if(userCurrent) {
                if(confirm("¬øCerrar sesi√≥n?")) auth.signOut();
            } else {
                const p = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(p).catch(e => alert("‚ö†Ô∏è Activa Google en Firebase Console!\nError: " + e.code));
            }
        };

        // === 2. MOTOR 3D & MOVIMIENTO TANQUE ===
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, camera, personaje, anim;
        let destino = null;

        const createScene = function () {
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color3(0.53, 0.81, 0.92); // CIELO AZUL
            s.gravity = new BABYLON.Vector3(0, -0.9, 0);
            s.collisionsEnabled = true;

            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), s);
            light.intensity = 1.0;

            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 140, BABYLON.Vector3.Zero(), s);
            camera.attachControl(canvas, true);
            
            // PISO
            const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2500, height: 2500}, s);
            const mat = new BABYLON.StandardMaterial("mat", s);
            mat.diffuseTexture = new BABYLON.Texture("mapa.jpg", s);
            suelo.material = mat;
            suelo.checkCollisions = true;

            // EDIFICIOS
            const loadMesh = (file, x, z, scale, rot) => {
                BABYLON.SceneLoader.ImportMesh("", "./", file, s, (m) => {
                    let mesh = m[0];
                    let root = new BABYLON.TransformNode("root", s);
                    mesh.parent = root;
                    const b = mesh.getHierarchyBoundingVectors(true);
                    const f = scale / Math.max(b.max.x-b.min.x, b.max.y-b.min.y, b.max.z-b.min.z);
                    mesh.scaling = new BABYLON.Vector3(f, f, f);
                    root.rotation.y = rot;
                    root.position = new BABYLON.Vector3(x, -b.min.y*f, z);
                });
            };
            loadMesh("municipalidad.glb", 610, 160, 150, Math.PI);
            loadMesh("intendencia.glb", 430, 410, 180, 0);

            // SERENITO (Carga)
            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m, ps, sk, a) => {
                personaje = m[0];
                personaje.scaling = new BABYLON.Vector3(-10, 10, 10);
                personaje.position = new BABYLON.Vector3(0, 5, 0); // Altura segura
                personaje.ellipsoid = new BABYLON.Vector3(1, 2, 1);
                personaje.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0);
                personaje.checkCollisions = true;
                personaje.applyGravity = true;
                camera.lockedTarget = personaje;
                if(a && a.length > 0) { anim = a[0]; anim.stop(); }
            });

            // L√ìGICA MOVIMIENTO TANQUE (GIRAR -> AVANZAR)
            s.onPointerDown = (evt, pick) => { if(pick.hit && pick.pickedMesh === suelo) destino = pick.pickedPoint; };
            
            s.onBeforeRenderObservable.add(() => {
                if(!personaje || !destino) return;
                let diff = destino.subtract(personaje.position);
                diff.y = 0; // Ignorar altura

                if(diff.length() > 1.5) {
                    let angle = Math.atan2(diff.x, diff.z);
                    let rotDiff = angle - personaje.rotation.y;
                    while (rotDiff > Math.PI) rotDiff -= Math.PI * 2;
                    while (rotDiff < -Math.PI) rotDiff += Math.PI * 2;

                    // SI LA DIFERENCIA ES GRANDE, SOLO GIRA
                    if(Math.abs(rotDiff) > 0.1) {
                        personaje.rotation.y += rotDiff * 0.15; // Velocidad de giro
                        if(anim) anim.stop(); // Quieto mientras gira
                    } 
                    // SI YA APUNTA, CAMINA
                    else {
                        personaje.rotation.y = angle;
                        personaje.moveWithCollisions(diff.normalize().scale(0.8)); // Velocidad avance
                        if(anim && !anim.isPlaying) anim.play(true);
                    }
                } else {
                    if(anim) anim.stop();
                    destino = null;
                }
            });

            return s;
        };

        scene = createScene();
        engine.runRenderLoop(() => { scene.render(); });
        window.addEventListener("resize", () => engine.resize());

        // 3. UI FUNCTIONS
        window.toggleRadio = () => {
            const aud = document.getElementById('audio-player');
            const icon = document.getElementById('icon-play');
            if(aud.paused) {
                aud.play().then(() => { icon.className = "fas fa-stop"; icon.style.color = "red"; })
                .catch(e => alert("Presiona PLAY de nuevo (Bloqueo navegador)"));
            } else {
                aud.pause();
                icon.className = "fas fa-play";
                icon.style.color = "#ffd700";
            }
        };

        window.resetCamara = () => { if(personaje) { camera.lockedTarget = personaje; camera.radius = 140; } };

        // 4. REPORTES
        let vStream = null;
        let gpsData = null;

        window.abrirReporte = () => {
            if(!userCurrent) return alert("üîí Presiona ACCEDER arriba a la derecha.");
            document.getElementById('modal-rep').style.display = 'flex';
            
            // C√°mara
            navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}}).then(s => {
                vStream = s; document.getElementById('cam').srcObject = s;
            });
            // GPS
            navigator.geolocation.getCurrentPosition(pos => {
                gpsData = pos.coords;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
                .then(r => r.json()).then(d => {
                    document.getElementById('gps-status').innerText = `üìç ${d.display_name.split(',')[0]}`;
                });
            });
        };

        window.enviar = () => {
            const desc = document.getElementById('desc').value;
            const vid = document.getElementById('cam');
            const cv = document.getElementById('snap');
            cv.width = vid.videoWidth; cv.height = vid.videoHeight;
            cv.getContext('2d').drawImage(vid, 0, 0); // Captura foto
            
            db.collection("incidencias").add({
                uid: userCurrent.uid,
                vecino: userCurrent.displayName,
                foto_perfil: userCurrent.photoURL,
                desc: desc,
                lat: gpsData ? gpsData.latitude : 0,
                lon: gpsData ? gpsData.longitude : 0,
                estado: "Ingresado",
                fecha: new Date(),
                fecha_fmt: new Date().toLocaleDateString()
            }).then(() => {
                alert("‚úÖ Reporte guardado!");
                document.getElementById('modal-rep').style.display = 'none';
                if(vStream) vStream.getTracks().forEach(t => t.stop());
            });
        };

        window.verHistorial = () => {
            if(!userCurrent) return alert("üîí Inicia sesi√≥n primero.");
            document.getElementById('modal-hist').style.display = 'flex';
            const l = document.getElementById('lista');
            l.innerHTML = "Cargando...";
            
            db.collection("incidencias").where("uid", "==", userCurrent.uid).orderBy("fecha", "desc").get()
            .then(snap => {
                l.innerHTML = "";
                if(snap.empty) l.innerHTML = "<p>No tienes reportes.</p>";
                snap.forEach(d => {
                    const data = d.data();
                    l.innerHTML += `<div style="background:#333; padding:10px; margin-bottom:5px; border-radius:8px;">
                        <b>üìÖ ${data.fecha_fmt}</b><br>${data.desc}
                        <div style="margin-top:5px;"><span style="background:gold; color:black; padding:2px 8px; border-radius:10px; font-size:12px;">${data.estado}</span></div>
                    </div>`;
                });
            });
        };
    </script>
</body>
</html>
