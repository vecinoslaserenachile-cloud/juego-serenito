<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - Smart City</title>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #87CEEB; font-family: 'Segoe UI', sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        /* ESTADO DE CARGA (Para saber qu√© pasa con Serenito) */
        #debug-status {
            position: absolute; top: 15px; left: 15px; z-index: 100;
            background: rgba(0, 0, 0, 0.7); color: #00ff00;
            padding: 10px; border-radius: 5px; font-weight: bold; border: 1px solid lime;
            font-size: 14px; pointer-events: none;
        }

        /* CONTROL DE RADIO */
        #radio-panel {
            position: absolute; top: 15px; right: 15px; z-index: 100;
            background: rgba(0,0,0,0.8); border: 2px solid #ffd700; border-radius: 30px;
            padding: 8px 20px; display: flex; align-items: center; gap: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        #btn-play-radio { 
            color: white; font-size: 24px; cursor: pointer; transition: 0.2s; 
        }
        #btn-play-radio:hover { color: #ffd700; transform: scale(1.1); }
        .volumen { width: 80px; accent-color: #ffd700; cursor: pointer; }

        /* BARRA DE HERRAMIENTAS */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 100;
        }
        .btn-tool {
            width: 65px; height: 65px; border-radius: 50%; border: none;
            background: rgba(255,255,255,0.9); font-size: 26px; cursor: pointer;
            box-shadow: 0 5px 10px rgba(0,0,0,0.3); transition: transform 0.2s;
        }
        .btn-tool:active { transform: scale(0.9); }
        .btn-red { background: #ff3333; color: white; border: 3px solid white; animation: latido 2s infinite; }
        @keyframes latido { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }

        /* MODAL REPORTE */
        #modal-reporte {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-content {
            background: #222; width: 90%; max-width: 450px; padding: 20px;
            border-radius: 15px; text-align: center; color: white; border: 1px solid #555;
        }
        #camera-preview { width: 100%; height: 250px; background: black; margin: 10px 0; border: 2px solid #ffd700; object-fit: cover; }
        .input-box { width: 100%; padding: 12px; margin: 5px 0; border-radius: 5px; border: 1px solid #555; background: #333; color: white; }
    </style>
</head>
<body>

    <div id="debug-status">‚è≥ Iniciando Sistema...</div>

    <audio id="audio-stream" src="https://az11.yesstreaming.net/radio/8040/radio.mp3" preload="none" crossorigin="anonymous"></audio>

    <div id="radio-panel">
        <i class="fas fa-play" id="btn-play-radio" onclick="controlarRadio()"></i>
        <input type="range" class="volumen" min="0" max="1" step="0.1" value="1" oninput="document.getElementById('audio-stream').volume = this.value">
    </div>

    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn-tool" onclick="resetCamara()"><i class="fas fa-street-view"></i></button>
        <button class="btn-tool btn-red" onclick="abrirReporte()"><i class="fas fa-camera"></i></button>
        <button class="btn-tool" onclick="vistaAerea()"><i class="fas fa-helicopter"></i></button>
    </div>

    <div id="modal-reporte">
        <div class="modal-content">
            <div style="text-align:right;"><i class="fas fa-times" onclick="cerrarReporte()" style="cursor:pointer; font-size:24px;"></i></div>
            <h2 style="color:#ffd700; margin-top:0;">üì∑ Reporte Ciudadano</h2>
            <p id="geo-info" style="color:#aaa; font-size:14px;">üìç Buscando ubicaci√≥n...</p>
            
            <video id="camera-preview" autoplay playsinline></video>
            <canvas id="foto-canvas" style="display:none;"></canvas>
            
            <input type="text" id="desc-problema" class="input-box" placeholder="¬øQu√© sucede? (Ej: Bache, Luz mala)">
            <input type="email" id="email-contacto" class="input-box" placeholder="Tu correo (Opcional)">
            
            <button onclick="enviarReporte()" style="background:#ffd700; color:black; font-weight:bold; width:100%; padding:15px; margin-top:10px; border:none; border-radius:5px; font-size:16px; cursor:pointer;">
                ENVIAR AHORA
            </button>
        </div>
    </div>

    <script>
        // 1. FIREBASE
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. L√ìGICA DE RADIO
        const audioEl = document.getElementById('audio-stream');
        const btnRadio = document.getElementById('btn-play-radio');
        let sonando = false;

        function controlarRadio() {
            if (!sonando) {
                audioEl.play().then(() => {
                    sonando = true;
                    btnRadio.className = "fas fa-stop";
                    btnRadio.style.color = "#ff3333";
                }).catch(e => alert("Dale play otra vez (bloqueo de navegador)"));
            } else {
                audioEl.pause();
                sonando = false;
                btnRadio.className = "fas fa-play";
                btnRadio.style.color = "white";
            }
        }

        // 3. MOTOR 3D
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        const statusDiv = document.getElementById("debug-status");
        let scene, camera, personaje, animCaminar, destinoFinal;

        const crearEscena = function () {
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.53, 0.81, 0.92); // CIELO AZUL
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;

            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 1.0;

            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 140, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.checkCollisions = true;
            return scene;
        };

        scene = crearEscena();

        // PISO
        const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2500, height: 2500}, scene);
        const matSuelo = new BABYLON.StandardMaterial("matSuelo", scene);
        matSuelo.diffuseTexture = new BABYLON.Texture("mapa.jpg", scene);
        suelo.material = matSuelo;
        suelo.checkCollisions = true;

        // EDIFICIOS (Muni e Intendencia)
        BABYLON.SceneLoader.ImportMesh("", "./", "municipalidad.glb", scene, (m) => {
            let mesh = m[0];
            let box = new BABYLON.TransformNode("rootMuni", scene);
            mesh.parent = box;
            const b = mesh.getHierarchyBoundingVectors(true);
            const f = 150 / Math.max(b.max.x-b.min.x, b.max.y-b.min.y, b.max.z-b.min.z);
            mesh.scaling = new BABYLON.Vector3(f, f, f);
            box.rotation.y = Math.PI; // GIRO 180
            box.position = new BABYLON.Vector3(610, (-b.min.y*f), 160);
            statusDiv.innerText += " | Muni OK";
        });

        BABYLON.SceneLoader.ImportMesh("", "./", "intendencia.glb", scene, (m) => {
            let mesh = m[0];
            const b = mesh.getHierarchyBoundingVectors(true);
            const f = 180 / Math.max(b.max.x-b.min.x, b.max.y-b.min.y, b.max.z-b.min.z);
            mesh.scaling = new BABYLON.Vector3(f, f, f);
            mesh.position = new BABYLON.Vector3(430, (-b.min.y*f), 410);
            statusDiv.innerText += " | Intendencia OK";
        });

        // === SERENITO (Carga y Movimiento Tanque) ===
        statusDiv.innerText = "‚è≥ Cargando a Serenito...";
        
        BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", scene, function (meshes, ps, sk, anims) {
            personaje = meshes[0];
            statusDiv.innerText = "‚úÖ Serenito Listo";
            
            // ESCALA ESPEJO (Tu configuraci√≥n original)
            personaje.scaling = new BABYLON.Vector3(-10, 10, 10);
            
            // POSICI√ìN DE SEGURIDAD (Cae del cielo para no quedar atrapado)
            personaje.position = new BABYLON.Vector3(0, 10, 0); 
            
            // COLISIONES (Pecho como centro)
            personaje.ellipsoid = new BABYLON.Vector3(1, 2, 1);
            personaje.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0); 
            personaje.checkCollisions = true;
            personaje.applyGravity = true; 
            
            // ENFOCAR C√ÅMARA
            camera.lockedTarget = personaje;
            
            // ANIMACI√ìN
            if (anims && anims.length > 0) { 
                animCaminar = anims[0]; 
                animCaminar.stop(); 
            }
        }, function () {
            // Mientras carga
        }, function (scene, message) {
            // Si falla
            statusDiv.innerText = "‚ùå ERROR: No encuentro 'serenito.glb'";
            statusDiv.style.color = "red";
        });

        // === MOVIMIENTO TANQUE (L√≥gica Restaurada) ===
        scene.onPointerDown = (evt, pick) => { 
            if (pick.hit && pick.pickedMesh === suelo) {
                destinoFinal = pick.pickedPoint;
            }
        };

        scene.onBeforeRenderObservable.add(() => {
            if (!personaje || !destinoFinal) return;

            let diff = destinoFinal.subtract(personaje.position);
            diff.y = 0; // Ignorar altura

            if (diff.length() > 1.5) {
                let anguloObjetivo = Math.atan2(diff.x, diff.z);
                let actual = personaje.rotation.y;
                let diferencia = anguloObjetivo - actual;

                // Corregir salto de √°ngulo (-PI a PI)
                while (diferencia > Math.PI) diferencia -= Math.PI * 2;
                while (diferencia < -Math.PI) diferencia += Math.PI * 2;

                // 1. PRIMERO GIRA (Tanque)
                if (Math.abs(diferencia) > 0.15) {
                    personaje.rotation.y += diferencia * 0.1; // Velocidad de giro
                    if (animCaminar) animCaminar.stop(); // No camina mientras gira
                } 
                // 2. LUEGO CAMINA
                else {
                    personaje.rotation.y = anguloObjetivo;
                    let direccion = diff.normalize();
                    personaje.moveWithCollisions(direccion.scale(0.9)); // Velocidad
                    if (animCaminar && !animCaminar.isPlaying) animCaminar.play(true);
                }
            } else {
                if (animCaminar) animCaminar.stop();
                destinoFinal = null;
            }
        });

        // FUNCIONES DE UI
        window.resetCamara = () => { if(personaje) { camera.lockedTarget = personaje; camera.radius = 140; } };
        window.vistaAerea = () => { camera.lockedTarget = null; camera.setPosition(new BABYLON.Vector3(500, 800, 500)); camera.setTarget(new BABYLON.Vector3(500, 0, 300)); };

        // === C√ÅMARA Y REPORTE ===
        let streamVideo = null;
        let gpsData = null;

        window.abrirReporte = () => {
            document.getElementById('modal-reporte').style.display = 'flex';
            // Activar c√°mara
            navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } }).then(s => {
                streamVideo = s;
                document.getElementById('camera-preview').srcObject = s;
            });
            // GPS
            navigator.geolocation.getCurrentPosition(pos => {
                gpsData = pos.coords;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
                .then(r => r.json()).then(d => {
                    document.getElementById('geo-info').innerText = `üìç ${d.display_name.split(',')[0]}`;
                });
            });
        };

        window.cerrarReporte = () => {
            document.getElementById('modal-reporte').style.display = 'none';
            if(streamVideo) streamVideo.getTracks().forEach(t => t.stop());
        };

        window.enviarReporte = () => {
            const desc = document.getElementById('desc-problema').value;
            const mail = document.getElementById('email-contacto').value;
            
            // Foto simulada (Snapshot)
            const cv = document.getElementById('foto-canvas');
            const vid = document.getElementById('camera-preview');
            cv.width = vid.videoWidth; cv.height = vid.videoHeight;
            cv.getContext('2d').drawImage(vid, 0, 0);

            db.collection("reportes_pro").add({
                problema: desc,
                contacto: mail,
                lat: gpsData ? gpsData.latitude : 0,
                lon: gpsData ? gpsData.longitude : 0,
                fecha: new Date()
            }).then(() => {
                const body = `Problema: ${desc}\nUbicaci√≥n: https://maps.google.com/?q=${gpsData.latitude},${gpsData.longitude}`;
                window.location.href = `mailto:vecinoslaserenachile@gmail.com?cc=${mail}&subject=ALERTA VECINAL&body=${encodeURIComponent(body)}`;
                alert("‚úÖ Reporte enviado correctamente");
                cerrarReporte();
            });
        };

        window.addEventListener("resize", () => engine.resize());
        engine.runRenderLoop(() => scene.render());

    </script>
</body>
</html>
