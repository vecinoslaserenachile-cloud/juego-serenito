<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vecinos La Serena - SuperApp v38</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --serena-red: #e63946; --serena-gold: #ffd700; --dark: #0f0f0f; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', sans-serif; background: var(--dark); color: white; overflow: hidden; }
        
        /* AUDIO PERSISTENTE */
        #main-audio { display: none; }

        /* VISTAS (SPA) */
        .view { position: absolute; top: 0; left: 0; width: 100%; height: calc(100% - 70px); display: none; }
        .active-view { display: block; }

        /* 1. DISEÑO RADIO PRO */
        #view-radio { background: radial-gradient(circle, #1a1a1a 0%, #000 100%); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .radio-visualizer { width: 180px; height: 180px; border-radius: 50%; border: 4px solid var(--serena-red); display: flex; align-items: center; justify-content: center; margin-bottom: 20px; box-shadow: 0 0 25px rgba(230, 57, 70, 0.4); position: relative; }
        .radio-visualizer img { width: 85%; border-radius: 50%; }
        .btn-play-master { width: 70px; height: 70px; background: var(--serena-red); border-radius: 50%; border: none; color: white; font-size: 25px; cursor: pointer; transition: 0.3s; }
        .btn-play-master:active { transform: scale(0.9); }

        /* 2. MUNDO 3D */
        #renderCanvas { width: 100%; height: 100%; outline: none; touch-action: none; }

        /* 3. MAPA GPS (UBER STYLE) */
        #map { width: 100%; height: 100%; }
        .map-ui { position: absolute; bottom: 90px; left: 5%; width: 90%; background: rgba(20,20,20,0.95); padding: 15px; border-radius: 15px; border: 1px solid #333; display: none; z-index: 1000; }
        .f-input { width: 100%; padding: 12px; margin: 5px 0; background: #222; border: 1px solid #444; color: white; border-radius: 10px; box-sizing: border-box; }

        /* NAVEGACIÓN UNIVERSAL */
        #nav-bar { position: fixed; bottom: 0; width: 100%; height: 70px; background: #000; display: flex; justify-content: space-around; align-items: center; border-top: 1px solid #222; z-index: 9999; }
        .nav-item { color: #666; font-size: 10px; text-align: center; cursor: pointer; transition: 0.3s; }
        .nav-item i { font-size: 24px; display: block; margin-bottom: 4px; }
        .nav-item.active { color: var(--serena-red); transform: translateY(-5px); }
    </style>
</head>
<body>

    <audio id="master-audio" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <div id="view-radio" class="view active-view">
        <div class="radio-visualizer">
            <img src="logo_radio.png" alt="Logo">
        </div>
        <h2 style="color:var(--serena-gold); margin:5px 0;">RADIO DIGITAL</h2>
        <p style="color:#666; margin-bottom:25px;">MUNICIPALIDAD LA SERENA</p>
        <button class="btn-play-master" onclick="toggleAudio()">
            <i class="fas fa-play" id="play-icon"></i>
        </button>
    </div>

    <div id="view-3d" class="view">
        <canvas id="renderCanvas"></canvas>
    </div>

    <div id="view-map" class="view">
        <div id="map"></div>
        <div id="form-gps" class="map-ui">
            <h4 style="color:var(--serena-gold); margin-top:0;">NUEVA GESTIÓN TERRITORIAL</h4>
            <input type="text" id="g-nom" class="f-input" placeholder="Nombre y Apellido">
            <input type="tel" id="g-tel" class="f-input" placeholder="Teléfono +56 9...">
            <textarea id="g-desc" class="f-input" placeholder="¿Qué sucede aquí?"></textarea>
            <button onclick="enviarReporteGPS()" style="width:100%; padding:14px; background:var(--serena-red); border:none; color:white; border-radius:10px; font-weight:bold;">ENVIAR AHORA</button>
        </div>
        <button onclick="toggleMapUI()" style="position:absolute; top:20px; right:20px; width:55px; height:55px; background:var(--serena-red); border:none; border-radius:50%; color:white; font-size:22px; z-index:1001; box-shadow:0 4px 10px rgba(0,0,0,0.5);"><i class="fas fa-plus"></i></button>
    </div>

    <div id="nav-bar">
        <div class="nav-item active" id="n-radio" onclick="changeView('radio')">
            <i class="fas fa-microphone-lines"></i>RADIO
        </div>
        <div class="nav-item" id="n-3d" onclick="changeView('3d')">
            <i class="fas fa-cubes"></i>MUNDO 3D
        </div>
        <div class="nav-item" id="n-map" onclick="changeView('map')">
            <i class="fas fa-map-location-dot"></i>MAPA GPS
        </div>
    </div>

    <script>
        // 1. FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. AUDIO PERSISTENTE
        const audio = document.getElementById("master-audio");
        const playIcon = document.getElementById("play-icon");
        function toggleAudio() {
            if(audio.paused) {
                audio.play();
                playIcon.className = "fas fa-pause";
            } else {
                audio.pause();
                playIcon.className = "fas fa-play";
            }
        }

        // 3. NAVEGACIÓN SIN RECARGA
        function changeView(name) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active-view'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            
            document.getElementById('view-' + name).classList.add('active-view');
            document.getElementById('n-' + name).classList.add('active');

            if(name === '3d') initBabylon();
            if(name === 'map') setTimeout(() => { map.invalidateSize(); }, 300);
        }

        // 4. MUNDO 3D (BLINDADO v37)
        let engine, scene, serenito, camera;
        function initBabylon() {
            if(engine) return;
            const canvas = document.getElementById("renderCanvas");
            engine = new BABYLON.Engine(canvas, true);
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color3(0.1, 0.1, 0.1);
            
            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 150, BABYLON.Vector3.Zero(), s);
            camera.attachControl(canvas, true);
            new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0,1,0), s);

            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m) => {
                serenito = m[0];
                serenito.scaling = new BABYLON.Vector3(10, 10, 10);
                camera.lockedTarget = serenito;
            });
            engine.runRenderLoop(() => s.render());
        }

        // 5. MAPA GPS REAL (UBER STYLE)
        let map, marker;
        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([-29.9027, -71.2520], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
            
            // Cursor de Serenito en el Mapa
            const serenaIcon = L.icon({
                iconUrl: 'serenito_marker.png',
                iconSize: [45, 45],
                iconAnchor: [22, 45]
            });
            marker = L.marker([-29.9027, -71.2520], {icon: serenaIcon}).addTo(map);

            if(navigator.geolocation) {
                navigator.geolocation.watchPosition(p => {
                    const lat = p.coords.latitude;
                    const lon = p.coords.longitude;
                    marker.setLatLng([lat, lon]);
                    map.setView([lat, lon]);
                });
            }
        }
        initMap();

        function toggleMapUI() {
            const ui = document.getElementById('form-gps');
            ui.style.display = ui.style.display === 'block' ? 'none' : 'block';
        }

        async function enviarReporteGPS() {
            const data = {
                nombre: document.getElementById('g-nom').value,
                telefono: document.getElementById('g-tel').value,
                descripcion: document.getElementById('g-desc').value,
                coords: marker.getLatLng(),
                fecha: new Date(),
                estado: "Nuevo"
            };
            if(!data.nombre || !data.descripcion) return alert("Completa los datos.");
            await db.collection("incidencias").add(data);
            alert("¡Gestión territorial enviada!");
            toggleMapUI();
        }
    </script>
</body>
</html>
