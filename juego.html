<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Vecinos La Serena - v41 Fase 1</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --serena-red: #e63946; --serena-gold: #ffd700; --dark: #0f0f0f; --panel-bg: #141414; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Segoe UI', Roboto, sans-serif; background: var(--dark); color: white; overflow: hidden; }
        
        /* LAYOUT MAESTRO (3 COLUMNAS) */
        #master-grid {
            display: grid;
            height: 100vh;
            width: 100vw;
            grid-template-columns: 1fr;
            grid-template-rows: 20% 40% 40%; /* M贸vil */
        }

        @media (min-width: 1024px) {
            #master-grid {
                grid-template-columns: 20% 50% 30%; /* Escritorio: Izq | Centro (Grande) | Der */
                grid-template-rows: 1fr;
            }
        }

        .panel { background: var(--panel-bg); border-right: 1px solid #333; position: relative; overflow: hidden; display: flex; flex-direction: column; }

        /* --- COLUMNA IZQUIERDA: HUB DE INFO --- */
        #panel-hub { padding: 15px; overflow-y: auto; text-align: center; }
        .radio-widget { background: linear-gradient(135deg, #222, #000); padding: 15px; border-radius: 15px; border: 1px solid var(--serena-red); margin-bottom: 15px; }
        .info-card { background: #222; padding: 10px; border-radius: 10px; margin-bottom: 10px; text-align: left; border-left: 3px solid var(--serena-gold); }
        .info-title { font-size: 10px; color: #888; text-transform: uppercase; font-weight: bold; }
        .info-value { font-size: 14px; font-weight: bold; }
        
        /* --- COLUMNA CENTRAL: 3D (VISOR) --- */
        #renderCanvas { width: 100%; height: 100%; outline: none; background: #000; }
        .status-overlay { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); background: rgba(0,0,0,0.7); padding: 5px 15px; border-radius: 20px; font-size: 12px; pointer-events: none; border: 1px solid #555; }

        /* --- COLUMNA DERECHA: MAPA Y GESTIN --- */
        #map { flex-grow: 1; width: 100%; height: 50%; }
        #gestion-ui { height: 50%; background: #1a1a1a; padding: 15px; overflow-y: auto; border-top: 2px solid var(--serena-red); }
        
        .f-input { width: 100%; padding: 10px; margin: 5px 0; background: #2a2a2a; border: 1px solid #444; color: white; border-radius: 8px; }
        .btn-action { width: 100%; padding: 12px; background: var(--serena-red); border: none; color: white; font-weight: bold; border-radius: 8px; cursor: pointer; margin-top: 10px; }
        .btn-reset { position: absolute; top: 10px; right: 10px; z-index: 1000; background: white; color: black; border: none; padding: 8px 12px; border-radius: 20px; font-size: 11px; font-weight: bold; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.3); }

    </style>
</head>
<body>

    <audio id="master-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <div id="master-grid">
        
        <div class="panel" id="panel-hub">
            <div class="radio-widget">
                <i class="fas fa-tower-broadcast fa-2x" style="color:var(--serena-red); margin-bottom:10px;"></i>
                <h4 style="margin:0; color:white;">RADIO MUNICIPAL</h4>
                <small style="color:#888;">EN VIVO 24/7</small>
                <br>
                <button onclick="toggleAudio()" style="margin-top:10px; width:40px; height:40px; border-radius:50%; border:none; background:var(--serena-gold); cursor:pointer;"><i class="fas fa-play" id="play-btn"></i></button>
            </div>

            <div class="info-card">
                <div class="info-title">CLIMA (LA SERENA)</div>
                <div class="info-value"><i class="fas fa-sun" style="color:gold"></i> 18掳C Despejado</div>
            </div>

            <div class="info-card">
                <div class="info-title">BIBLIOTECA VLS</div>
                <div style="font-size:11px; margin-top:5px;"><a href="#" style="color:#aaa;"> Plan Regulador</a></div>
                <div style="font-size:11px; margin-top:5px;"><a href="#" style="color:#aaa;"> Mapas Tur铆sticos</a></div>
            </div>

             <div class="info-card" style="border-left-color: var(--serena-red);">
                <div class="info-title">RUTAS INTERURBANAS</div>
                <table style="width:100%; font-size:11px; margin-top:5px; color:#ccc;">
                    <tr><td>Santiago</td><td style="text-align:right">472 km</td></tr>
                    <tr><td>Coquimbo</td><td style="text-align:right">12 km</td></tr>
                    <tr><td>Vicu帽a</td><td style="text-align:right">62 km</td></tr>
                </table>
            </div>
        </div>

        <div class="panel" id="panel-3d">
            <canvas id="renderCanvas"></canvas>
            <div class="status-overlay" id="status-text"> CENTRO HISTRICO</div>
        </div>

        <div class="panel">
            <div style="position:relative; height:50%;">
                <div id="map"></div>
                <button class="btn-reset" onclick="resetTour()"><i class="fas fa-sync"></i> VOLVER AL CENTRO</button>
            </div>
            
            <div id="gestion-ui">
                <h4 style="margin-top:0; color:var(--serena-gold);">REPORTAR EN ESTA UBICACIN</h4>
                <p style="font-size:11px; color:#888; margin-bottom:10px;">Mueve el mapa para ajustar la posici贸n exacta.</p>
                
                <input type="text" id="g-nom" class="f-input" placeholder="Tu Nombre">
                <textarea id="g-desc" class="f-input" rows="3" placeholder="Descripci贸n de la incidencia..."></textarea>
                
                <button class="btn-action" style="background:#333; border:1px dashed #666; color:#ccc;" onclick="document.getElementById('file-cam').click()">
                    <i class="fas fa-camera"></i> ADJUNTAR EVIDENCIA
                </button>
                <input type="file" id="file-cam" style="display:none" capture="environment">

                <button class="btn-action" onclick="enviarReporte()">ENVIAR REPORTE</button>
            </div>
        </div>

    </div>

    <script>
        // CONFIG GLOBAL
        const CENTER_LAT = -29.9027;
        const CENTER_LON = -71.2520; // Plaza de Armas La Serena
        let isTourMode = true;

        // 1. FIREBASE
        const firebaseConfig = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // 2. RADIO
        const player = document.getElementById("master-player");
        const btnIcon = document.getElementById("play-btn");
        function toggleAudio() {
            if(player.paused) { player.play(); btnIcon.className = "fas fa-pause"; }
            else { player.pause(); btnIcon.className = "fas fa-play"; }
        }

        // 3. MOTOR 3D BABYLON (Sincronizado)
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, serenito, edificioMuni, edificioIntendencia;

        const crearEscena = function() {
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color3(0.1, 0.1, 0.15); // Cielo nocturno
            const cam = new BABYLON.ArcRotateCamera("c", -Math.PI/2, Math.PI/3, 120, BABYLON.Vector3.Zero(), s);
            cam.attachControl(canvas, true);
            new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0, 1, 0), s);

            // Suelo
            const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2000, height: 2000}, s);
            const mat = new BABYLON.StandardMaterial("m", s);
            mat.diffuseColor = new BABYLON.Color3(0.2, 0.2, 0.2);
            suelo.material = mat;

            // Cargar Edificios (Se guardan en variables para ocultarlos luego)
            BABYLON.SceneLoader.ImportMesh("", "./", "municipalidad.glb", s, (m) => {
                edificioMuni = m[0];
                m[0].position = new BABYLON.Vector3(60, 0, 40); // Ajuste relativo
                m[0].scaling = new BABYLON.Vector3(5,5,5);
            });
            BABYLON.SceneLoader.ImportMesh("", "./", "intendencia.glb", s, (m) => {
                edificioIntendencia = m[0];
                m[0].position = new BABYLON.Vector3(-60, 0, -40);
                m[0].scaling = new BABYLON.Vector3(5,5,5);
            });

            // Serenito (El protagonista)
            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m) => {
                serenito = m[0];
                serenito.scaling = new BABYLON.Vector3(-8, 8, 8); // Ajuste escala
                cam.lockedTarget = serenito;
            });

            return s;
        };
        scene = crearEscena();
        engine.runRenderLoop(() => scene.render());

        // 4. MAPA LEAFLET + SINCRONIZACIN
        let map, marker;

        function initMap() {
            map = L.map('map', { zoomControl: false }).setView([CENTER_LAT, CENTER_LON], 16);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

            // Icono personalizado
            const pinIcon = L.icon({
                iconUrl: 'https://cdn-icons-png.flaticon.com/512/684/684908.png', // Pin gen茅rico por ahora
                iconSize: [30, 30],
                iconAnchor: [15, 30]
            });

            marker = L.marker([CENTER_LAT, CENTER_LON], {draggable: true, icon: pinIcon}).addTo(map);

            // EVENTO MGICO: AL MOVER EL MARCADOR
            marker.on('drag', function(e) {
                const pos = marker.getLatLng();
                actualizarMundo3D(pos.lat, pos.lng);
            });
            
            // Tambi茅n al mover el mapa
            map.on('move', function() {
                const center = map.getCenter();
                marker.setLatLng(center); // El marcador siempre al centro en m贸vil
                actualizarMundo3D(center.lat, center.lng);
            });
        }
        initMap();

        // 5. LGICA DE SINCRONIZACIN (EL PUENTE)
        function actualizarMundo3D(lat, lon) {
            if(!serenito) return;

            // Calcular distancia del centro hist贸rico (simple pit谩goras lat/lon)
            const dist = Math.sqrt(Math.pow(lat - CENTER_LAT, 2) + Math.pow(lon - CENTER_LON, 2));
            
            // Factor de escala (inventado para efecto visual: 1 grado ~ 10000 unidades 3D)
            const scaleFactor = 8000; 
            const x = (lon - CENTER_LON) * scaleFactor;
            const z = (lat - CENTER_LAT) * scaleFactor;

            // Mover a Serenito
            serenito.position.x = x;
            serenito.position.z = z;

            // L贸gica de Zona (Geofencing simple)
            // Si te alejas m谩s de ~0.003 grados (aprox 300 metros), ocultar edificios
            if(dist > 0.003) {
                if(isTourMode) {
                    if(edificioMuni) edificioMuni.setEnabled(false);
                    if(edificioIntendencia) edificioIntendencia.setEnabled(false);
                    document.getElementById("status-text").innerText = " ZONA URBANA (FUERA DEL CENTRO)";
                    document.getElementById("status-text").style.background = "rgba(200, 0, 0, 0.7)";
                    isTourMode = false;
                }
            } else {
                if(!isTourMode) {
                    if(edificioMuni) edificioMuni.setEnabled(true);
                    if(edificioIntendencia) edificioIntendencia.setEnabled(true);
                    document.getElementById("status-text").innerText = " CENTRO HISTRICO";
                    document.getElementById("status-text").style.background = "rgba(0, 0, 0, 0.7)";
                    isTourMode = true;
                }
            }
        }

        // RESETEAR AL TURISMO
        window.resetTour = function() {
            map.setView([CENTER_LAT, CENTER_LON], 16);
            marker.setLatLng([CENTER_LAT, CENTER_LON]);
            actualizarMundo3D(CENTER_LAT, CENTER_LON);
        };

        // ENVIAR REPORTE
        window.enviarReporte = async function() {
            const data = {
                vecino: document.getElementById('g-nom').value,
                desc: document.getElementById('g-desc').value,
                lat: marker.getLatLng().lat,
                lon: marker.getLatLng().lng,
                fecha: new Date()
            };
            if(!data.vecino) return alert("Falta tu nombre.");
            await db.collection("incidencias").add(data);
            alert("Reporte enviado. Serenito agradece tu ayuda.");
            location.reload();
        };

        window.addEventListener("resize", () => { engine.resize(); map.invalidateSize(); });
    </script>
</body>
</html>
