<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VLS - Lógica & Legado v49</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --serena-red: #b71c1c; --serena-gold: #ffd700; --dark: #121212; }
        body, html { margin: 0; padding: 0; height: 100%; font-family: 'Roboto', sans-serif; background: var(--dark); overflow: hidden; }

        /* LAYOUT */
        #main-layout {
            display: grid; width: 100vw; height: 100vh;
            grid-template-columns: 320px 1fr; grid-template-rows: 1fr;
        }
        @media (max-width: 1023px) {
            #main-layout { display: flex; flex-direction: column; height: auto; min-height: 100vh; overflow-y: auto; }
        }

        /* --- IZQUIERDA: HUB --- */
        #sidebar {
            background: linear-gradient(180deg, #d32f2f 0%, #8e0000 100%);
            padding: 20px; display: flex; flex-direction: column; gap: 15px;
            color: white; z-index: 50; box-shadow: 4px 0 15px rgba(0,0,0,0.5);
        }
        
        .digital-clock { font-family: 'Orbitron', sans-serif; font-size: 28px; text-align: center; }
        .widget-box { background: rgba(0,0,0,0.25); padding: 15px; border-radius: 12px; border-left: 4px solid var(--serena-gold); }

        /* Calculadora Rutas */
        .route-select { width: 100%; padding: 8px; border-radius: 5px; border: none; margin-bottom: 8px; }
        .route-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 11px; margin-top: 10px; }
        .route-item { display: flex; align-items: center; gap: 6px; color: #eee; background: rgba(0,0,0,0.2); padding: 5px; border-radius: 4px; }

        /* --- CENTRO: MAPA REAL + SERENITO OVERLAY --- */
        #stage-area { position: relative; flex-grow: 1; min-height: 60vh; }
        #map { width: 100%; height: 100%; z-index: 1; }
        #renderCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; outline: none; }
        
        /* BOTÓN PASEO HISTÓRICO */
        .btn-tour-3d {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: linear-gradient(45deg, var(--serena-gold), #ffeb3b);
            color: #333; font-weight: bold; border: 2px solid white;
            padding: 10px 20px; border-radius: 30px; cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px;
            transition: transform 0.2s;
        }
        .btn-tour-3d:hover { transform: scale(1.05); }

        /* --- DERECHA: USUARIO & REPORTE --- */
        #form-container {
            position: absolute; bottom: 20px; right: 20px; width: 320px;
            background: #1a1a1a; padding: 20px; border-radius: 15px; border: 1px solid #333;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8); z-index: 30; color: white;
        }
        @media (max-width: 1023px) {
            #form-container { position: relative; bottom: auto; right: auto; width: auto; margin: 0; border-radius: 0; }
        }

        .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .user-avatar { width: 35px; height: 35px; border-radius: 50%; }
        .login-btn { width: 100%; padding: 8px; background: #4285F4; color: white; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        
        .f-input { width: 100%; padding: 10px; margin-bottom: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; }
        .btn-red { width: 100%; padding: 12px; background: var(--serena-red); color: white; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; }

        /* --- MODAL PASEO HISTÓRICO (Tanque Mode) --- */
        #modal-tour {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; z-index: 9999;
        }
        #tour-canvas { width: 100%; height: 100%; outline: none; }
        .tour-ui { position: absolute; top: 20px; right: 20px; z-index: 10000; }
        .close-tour { background: #333; color: white; border: 1px solid #555; padding: 10px 15px; cursor: pointer; border-radius: 5px; }

    </style>
</head>
<body>

    <div id="main-layout">

        <div id="sidebar">
            <div class="digital-clock" id="clock">00:00:00</div>
            
            <div style="text-align:center;">
                <button onclick="toggleRadio()" style="width:50px; height:50px; border-radius:50%; border:none; background:white; color:var(--serena-red); font-size:20px; cursor:pointer;"><i class="fas fa-play" id="icon-play"></i></button>
                <div style="font-size:10px; margin-top:5px;">RADIO VLS</div>
                <input type="range" style="width:80%; margin-top:5px;" min="0" max="1" step="0.1" oninput="document.getElementById('audio-player').volume=this.value">
            </div>

            <div class="widget-box">
                <div style="font-size:10px; color:var(--serena-gold); margin-bottom:5px;">PLANIFICADOR DE VIAJES</div>
                
                <select id="route-dest" class="route-select" onchange="calcularRuta()">
                    <option value="">Selecciona Destino...</option>
                    <option value="coquimbo" data-coords="-29.9533,-71.3436" data-sea="true">Coquimbo</option>
                    <option value="vicuna" data-coords="-30.0319,-70.7081" data-sea="false">Vicuña (Valle Elqui)</option>
                    <option value="ovalle" data-coords="-30.6015,-71.2003" data-sea="false">Ovalle</option>
                    <option value="santiago" data-coords="-33.4489,-70.6693" data-sea="false">Santiago</option>
                    <option value="arica" data-coords="-18.4783,-70.3126" data-sea="true">Arica</option>
                    <option value="mendoza" data-coords="-32.8895,-68.8458" data-sea="false">Mendoza (ARG)</option>
                </select>

                <div class="route-grid" id="route-res">
                    <div style="grid-column: span 2; font-size:10px; color:#ccc; text-align:center;">Selecciona un destino para ver tiempos.</div>
                </div>
            </div>

            <div class="widget-box">
                <div style="font-size:10px; color:var(--serena-gold);">CLIMA ACTUAL</div>
                <div style="font-size:20px; font-weight:bold;"><i class="fas fa-sun"></i> <span id="w-temp">--</span>°C</div>
            </div>
        </div>

        <div id="stage-area">
            <div id="map"></div>
            <canvas id="renderCanvas"></canvas> <button class="btn-tour-3d" onclick="openTourMode()">
                <i class="fas fa-cube"></i> PASEO HISTÓRICO 3D
            </button>
        </div>

        <div id="form-container">
            <div class="user-header" id="user-ui">
                <button class="login-btn" onclick="loginGoogle()"><i class="fab fa-google"></i> Acceder</button>
            </div>

            <div id="report-form" style="opacity:0.5; pointer-events:none;">
                <h4 style="margin:0 0 10px 0; color:var(--serena-gold);">REPORTE CIUDADANO</h4>
                <input type="text" id="r-dir" class="f-input" readonly style="color:var(--serena-gold);" placeholder="Ubicación Detectada">
                <input type="text" id="r-desc" class="f-input" placeholder="Descripción...">
                <button class="btn-red" onclick="alert('Reporte enviado')">ENVIAR</button>
            </div>
        </div>

    </div>

    <div id="modal-tour">
        <div class="tour-ui">
            <button class="close-tour" onclick="closeTourMode()">CERRAR PASEO <i class="fas fa-times"></i></button>
        </div>
        <canvas id="tour-canvas"></canvas>
    </div>

    <audio id="audio-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <script>
        // CONFIG
        const LS_COORDS = [-29.9027, -71.2520];

        // 1. CÁLCULO RUTAS INTELIGENTE
        const map = L.map('map', { zoomControl: false }).setView(LS_COORDS, 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        let currentPolyline = null;

        function calcularRuta() {
            const sel = document.getElementById('route-dest');
            const opt = sel.options[sel.selectedIndex];
            if(!opt.value) return;

            const coordsStr = opt.getAttribute('data-coords');
            const hasSea = opt.getAttribute('data-sea') === 'true';
            const [lat, lon] = coordsStr.split(',').map(Number);
            
            // Haversine
            const R = 6371; 
            const dLat = (lat - LS_COORDS[0]) * Math.PI/180;
            const dLon = (lon - LS_COORDS[1]) * Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(LS_COORDS[0]*Math.PI/180)*Math.cos(lat*Math.PI/180) * Math.sin(dLon/2)**2;
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            const dist = R * c; 
            const distRuta = dist * 1.3; // Carretera

            // Tiempos
            const tPie = (distRuta / 5).toFixed(1) + " h";
            const tBici = (distRuta / 15).toFixed(1) + " h"; // 15km/h bici promedio
            const tAuto = (distRuta / 90).toFixed(1) + " h";
            const tBus = (distRuta / 70).toFixed(1) + " h";
            
            let html = `
                <div class="route-item"><i class="fas fa-walking"></i> ${tPie}</div>
                <div class="route-item"><i class="fas fa-bicycle"></i> ${tBici}</div>
                <div class="route-item"><i class="fas fa-car"></i> ${tAuto}</div>
                <div class="route-item"><i class="fas fa-bus"></i> ${tBus}</div>
            `;

            if(hasSea) {
                const tBarco = (distRuta / 30).toFixed(1) + " h"; // Barco lento
                html += `<div class="route-item"><i class="fas fa-ship"></i> ${tBarco}</div>`;
            }

            if(dist > 300) {
                 const tAvion = (dist / 800 + 2).toFixed(1) + " h";
                 html += `<div class="route-item"><i class="fas fa-plane"></i> ${tAvion}</div>`;
            }

            html += `<div style="grid-column:span 2; text-align:center; margin-top:5px; color:gold;">Distancia Aprox: ${Math.round(distRuta)} km</div>`;
            document.getElementById('route-res').innerHTML = html;

            // DIBUJAR RUTA EN MAPA
            if(currentPolyline) map.removeLayer(currentPolyline);
            currentPolyline = L.polyline([LS_COORDS, [lat, lon]], {color: '#b71c1c', weight: 4, opacity: 0.7, dashArray: '10, 10'}).addTo(map);
            map.fitBounds(currentPolyline.getBounds(), {padding: [50,50]});
        }

        // 2. MOTOR 3D PRINCIPAL (Overlay)
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        const createScene = function() {
            const s = new BABYLON.Scene(engine);
            s.clearColor = new BABYLON.Color4(0,0,0,0);
            const cam = new BABYLON.ArcRotateCamera("c", Math.PI/2, Math.PI/2.5, 100, BABYLON.Vector3.Zero(), s);
            new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0,1,0), s).intensity = 1.2;
            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m) => {
                let ser = m[0]; ser.scaling = new BABYLON.Vector3(12,12,-12); ser.position.y = -22;
                cam.lockedTarget = ser;
                s.registerBeforeRender(() => { ser.rotation.y = Math.PI; });
                
                // Dinámica: Pequeño al mover, Grande al parar
                map.on('movestart', () => ser.scaling = new BABYLON.Vector3(5,5,-5));
                map.on('moveend', () => ser.scaling = new BABYLON.Vector3(12,12,-12));
            });
            return s;
        };
        const scene = createScene();
        engine.runRenderLoop(() => scene.render());

        // 3. PASEO HISTÓRICO (MODAL TANQUE)
        let tourEngine, tourScene;
        function openTourMode() {
            document.getElementById('modal-tour').style.display = 'block';
            if(!tourEngine) initTourEngine();
        }
        function closeTourMode() {
            document.getElementById('modal-tour').style.display = 'none';
        }

        function initTourEngine() {
            const tc = document.getElementById('tour-canvas');
            tourEngine = new BABYLON.Engine(tc, true);
            const s = new BABYLON.Scene(tourEngine);
            s.clearColor = new BABYLON.Color3(0.5, 0.6, 0.8);
            
            const cam = new BABYLON.ArcRotateCamera("tc", -Math.PI/2, Math.PI/2.5, 120, BABYLON.Vector3.Zero(), s);
            cam.attachControl(tc, true);
            new BABYLON.HemisphericLight("tl", new BABYLON.Vector3(0,1,0), s);

            // SUELO JPG (EL LEGADO)
            const ground = BABYLON.MeshBuilder.CreateGround("g", {width:1000, height:1000}, s);
            const mat = new BABYLON.StandardMaterial("m", s);
            mat.diffuseTexture = new BABYLON.Texture("mapa.jpg", s);
            mat.specularColor = BABYLON.Color3.Black();
            ground.material = mat;

            // EDIFICIOS
            BABYLON.SceneLoader.ImportMesh("", "./", "municipalidad.glb", s, (m)=>{ m[0].scaling=new BABYLON.Vector3(5,5,5); m[0].position.x=60; });
            BABYLON.SceneLoader.ImportMesh("", "./", "intendencia.glb", s, (m)=>{ m[0].scaling=new BABYLON.Vector3(5,5,5); m[0].position.x=-60; });

            // SERENITO TANQUE
            let tourSerenito, dest;
            BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m)=>{ 
                tourSerenito = m[0]; 
                tourSerenito.scaling = new BABYLON.Vector3(10,10,-10);
                cam.lockedTarget = tourSerenito;
            });

            // LOGICA CAMINAR POR CLIC (TANQUE)
            s.onPointerDown = (evt, pick) => {
                if(pick.hit && pick.pickedMesh === ground) dest = pick.pickedPoint;
            };
            s.onBeforeRenderObservable.add(() => {
                if(!tourSerenito || !dest) return;
                let diff = dest.subtract(tourSerenito.position);
                diff.y = 0;
                if(diff.length() > 1) {
                    tourSerenito.lookAt(dest);
                    tourSerenito.rotation.y += Math.PI; 
                    tourSerenito.position.addInPlace(diff.normalize().scale(0.8));
                } else dest = null;
            });

            tourEngine.runRenderLoop(() => s.render());
            window.addEventListener("resize", () => tourEngine.resize());
        }

        // 4. FIREBASE AUTH & EXTRAS
        const firebaseConfig = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        
        function loginGoogle() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('user-ui').innerHTML = `<img src="${u.photoURL}" class="user-avatar"> <b>${u.displayName}</b>`;
                document.getElementById('report-form').style.opacity = "1";
                document.getElementById('report-form').style.pointerEvents = "auto";
            }
        });

        // Reloj & Clima
        setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('es-CL'), 1000);
        async function w() { try { let d = await (await fetch("https://api.open-meteo.com/v1/forecast?latitude=-29.90&longitude=-71.25&current_weather=true")).json(); document.getElementById('w-temp').innerText = d.current_weather.temperature; } catch(e){} }
        w();

        // Audio
        const player = document.getElementById('audio-player');
        function toggleRadio() { player.paused ? player.play() : player.pause(); }

        window.addEventListener("resize", () => { engine.resize(); map.invalidateSize(); });
    </script>
</body>
</html>
