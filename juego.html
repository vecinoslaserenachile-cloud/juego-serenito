scene.onBeforeRenderObservable.add(() => {
    if (!personaje || !destinoFinal) return;

    let velocidad = 0.8; // Ajusta según la escala de tu mapa
    let diferencia = destinoFinal.subtract(personaje.position);
    diferencia.y = 0; // Mantener siempre el nivel del suelo

    // Si la distancia es mayor a un umbral mínimo, seguimos moviendo
    if (diferencia.length() > 0.2) { 
        diferencia.normalize();
        personaje.moveWithCollisions(diferencia.scale(velocidad));
        
        // Rotación fluida hacia el destino
        let anguloDeseado = Math.atan2(diferencia.x, diferencia.z);
        personaje.rotation.y = anguloDeseado;
        
        // Ejecutar animación de caminata si existe
        if (animCaminar && !animCaminar.isPlaying) animCaminar.play(true);
    } 
    else {
        // AJUSTE FINAL: Forzamos la posición exacta del clic para evitar desfases
        personaje.position.x = destinoFinal.x;
        personaje.position.z = destinoFinal.z;
        
        // Detener movimiento y animación
        destinoFinal = null; 
        if (animCaminar) animCaminar.stop();
    }
});
