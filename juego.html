<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - Gesti√≥n Municipal</title>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #87CEEB; font-family: 'Segoe UI', Roboto, sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        /* 1. RADIO MUNICIPAL (Conectada Real) */
        #radio-control {
            position: absolute; top: 20px; right: 20px; z-index: 100;
            background: rgba(0, 0, 0, 0.8); border: 2px solid #ffd700;
            border-radius: 30px; padding: 10px 20px; display: flex; align-items: center; gap: 15px;
            color: white; box-shadow: 0 4px 15px rgba(0,0,0,0.5); transition: 0.3s;
        }
        #radio-control i { cursor: pointer; font-size: 20px; }
        #radio-control:hover { transform: scale(1.05); }
        #volumen-slider { width: 80px; accent-color: #ffd700; cursor: pointer; }

        /* ESTADO GPS */
        #gps-status {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(0, 255, 0, 0.2); color: #00ff00;
            padding: 8px 15px; border-radius: 8px; border: 1px solid #00ff00;
            font-weight: bold; font-size: 14px; pointer-events: none;
        }

        /* BARRA DE HERRAMIENTAS (Iconos que te gustaron) */
        #toolbar {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; z-index: 100;
        }
        .btn-tool {
            background: rgba(255, 255, 255, 0.9); border: none; padding: 15px;
            border-radius: 50%; width: 60px; height: 60px; font-size: 24px;
            cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: transform 0.2s, background 0.2s;
        }
        .btn-tool:active { transform: scale(0.9); }
        .btn-reporte { background: #ff3333; color: white; width: 70px; height: 70px; font-size: 28px; border: 3px solid white; animation: pulso 2s infinite; }
        
        @keyframes pulso { 0% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0.7); } 70% { box-shadow: 0 0 0 15px rgba(255, 51, 51, 0); } 100% { box-shadow: 0 0 0 0 rgba(255, 51, 51, 0); } }

        /* M√ìDULO DE REPORTE (C√°mara Funcional) */
        #modal-reporte {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.9); z-index: 2000; align-items: center; justify-content: center;
        }
        .modal-card {
            background: #222; width: 90%; max-width: 500px; padding: 25px;
            border-radius: 20px; border: 1px solid #444; text-align: center; color: white;
            position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.8);
        }
        .modal-card h2 { color: #ffd700; margin-top: 0; }
        .input-field {
            width: 100%; padding: 12px; margin: 10px 0; border-radius: 8px; border: 1px solid #555;
            background: #333; color: white; font-size: 16px; box-sizing: border-box;
        }
        #camera-feed {
            width: 100%; height: 250px; background: #000; margin: 15px 0;
            border-radius: 10px; border: 2px solid #ffd700; object-fit: cover;
        }
        #btn-capture { background: #ffd700; color: black; font-weight: bold; width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 18px; margin-top: 10px; cursor: pointer; }
        .close-modal { position: absolute; top: 15px; right: 20px; font-size: 24px; cursor: pointer; color: #aaa; }
    </style>
</head>
<body>

    <div id="gps-status"><i class="fas fa-satellite-dish"></i> GPS: Conectando...</div>

    <div id="radio-control">
        <i class="fas fa-play" id="play-btn" onclick="toggleRadio()"></i>
        <input type="range" id="volumen-slider" min="0" max="1" step="0.1" value="0.8" oninput="ajustarVolumen(this.value)">
        <i class="fas fa-volume-up"></i>
    </div>

    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn-tool" onclick="camaraSerenito()"><i class="fas fa-walking"></i></button>
        <button class="btn-tool btn-reporte" onclick="abrirModal()"><i class="fas fa-camera"></i></button>
        <button class="btn-tool" onclick="camaraAerea()"><i class="fas fa-helicopter"></i></button>
    </div>

    <div id="modal-reporte">
        <div class="modal-card">
            <span class="close-modal" onclick="cerrarModal()">√ó</span>
            <h2>üö® Reporte Municipal</h2>
            <p id="direccion-detectada" style="color: #bbb; font-size: 14px;">üìç Ubicando...</p>
            
            <video id="camera-feed" autoplay playsinline></video>
            <canvas id="photo-canvas" style="display:none;"></canvas>
            
            <input type="text" id="mensaje-reporte" class="input-field" placeholder="Describe el problema...">
            <input type="email" id="email-vecino" class="input-field" placeholder="Tu correo (Opcional)">
            
            <button id="btn-capture" onclick="capturarYEnviar()">
                <i class="fas fa-paper-plane"></i> CAPTURAR Y ENVIAR
            </button>
        </div>
    </div>

    <script>
        // === 1. FIREBASE (Cerebro) ===
        const firebaseConfig = {
            apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
            authDomain: "laserena-d1263.firebaseapp.com",
            projectId: "laserena-d1263",
            storageBucket: "laserena-d1263.firebasestorage.app",
            messagingSenderId: "283725387947",
            appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // === 2. RADIO (Conexi√≥n Real) ===
        // Usamos el stream directo si es posible, o la URL p√∫blica
        const radioUrl = "https://az11.yesstreaming.net/radio/8040/radio.mp3"; // Intent√© derivar el stream directo .mp3
        // Nota: Si no suena el directo, usa la url de la p√°gina: "https://az11.yesstreaming.net/public/radio-digital-municipal-la-serena"
        const radioAudio = new Audio(radioUrl);
        let radioPlaying = false;

        function toggleRadio() {
            const btn = document.getElementById('play-btn');
            if (!radioPlaying) {
                radioAudio.play().then(() => {
                    btn.className = "fas fa-stop";
                    btn.style.color = "#ff3333";
                    radioPlaying = true;
                }).catch(e => {
                    console.log("Error stream:", e);
                    alert("Haz clic de nuevo para iniciar la radio (Bloqueo de navegador)");
                });
            } else {
                radioAudio.pause();
                btn.className = "fas fa-play";
                btn.style.color = "white";
                radioPlaying = false;
            }
        }
        function ajustarVolumen(val) { radioAudio.volume = val; }

        // === 3. MOTOR GR√ÅFICO (Restauraci√≥n Total) ===
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        let scene, camera, personaje, animCaminar, destinoFinal;

        const crearEscena = function () {
            scene = new BABYLON.Scene(engine);
            scene.clearColor = new BABYLON.Color3(0.53, 0.81, 0.92); // CIELO AZUL RECUPERADO
            scene.gravity = new BABYLON.Vector3(0, -0.9, 0);
            scene.collisionsEnabled = true;

            const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), scene);
            light.intensity = 1.2;
            
            camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 140, BABYLON.Vector3.Zero(), scene);
            camera.attachControl(canvas, true);
            camera.checkCollisions = true; // C√°mara no atraviesa el piso
            return scene;
        };

        scene = crearEscena();

        // PISO
        const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2500, height: 2500}, scene);
        const matSuelo = new BABYLON.StandardMaterial("matSuelo", scene);
        matSuelo.diffuseTexture = new BABYLON.Texture("mapa.jpg", scene);
        suelo.material = matSuelo;
        suelo.checkCollisions = true; 

        // === EDIFICIOS RECUPERADOS ===
        // Municipalidad (Giro 180¬∞ y Escala)
        BABYLON.SceneLoader.ImportMesh("", "./", "municipalidad.glb", scene, function (meshes) {
            let mesh = meshes[0];
            let cajaPadre = new BABYLON.TransformNode("cajaMuni", scene);
            mesh.parent = cajaPadre;
            
            const bound = mesh.getHierarchyBoundingVectors(true);
            const size = bound.max.subtract(bound.min);
            const factor = 150 / Math.max(size.x, size.y, size.z);
            mesh.scaling = new BABYLON.Vector3(factor, factor, factor);
            
            cajaPadre.rotation.y = Math.PI; // GIRO CORRECTO
            let nivelSuelo = -bound.min.y * factor;
            cajaPadre.position = new BABYLON.Vector3(610, nivelSuelo, 160); // POSICI√ìN CORRECTA
            
            mesh.getChildMeshes().forEach(m => m.checkCollisions = true);
        });

        // Intendencia
        BABYLON.SceneLoader.ImportMesh("", "./", "intendencia.glb", scene, function (meshes) {
            let mesh = meshes[0];
            const bound = mesh.getHierarchyBoundingVectors(true);
            const size = bound.max.subtract(bound.min);
            const factor = 180 / Math.max(size.x, size.y, size.z);
            mesh.scaling = new BABYLON.Vector3(factor, factor, factor);
            
            let nivelSuelo = -bound.min.y * factor;
            mesh.position = new BABYLON.Vector3(430, nivelSuelo, 410); // POSICI√ìN CORRECTA
            mesh.getChildMeshes().forEach(m => m.checkCollisions = true);
        });

        // === SERENITO (Movimiento Natural Restaurado) ===
        BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", scene, function (meshes, ps, sk, anims) {
            personaje = meshes[0];
            personaje.rotationQuaternion = null; 
            personaje.scaling = new BABYLON.Vector3(-10, 10, 10); // Espejo
            personaje.position = new BABYLON.Vector3(0, 2, 0); 
            
            // Fix de Altura
            personaje.ellipsoid = new BABYLON.Vector3(1, 2, 1);
            personaje.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0); 
            
            personaje.checkCollisions = true;
            personaje.applyGravity = true; 
            
            camera.lockedTarget = personaje;
            if (anims && anims.length > 0) { animCaminar = anims[0]; animCaminar.stop(); }
        });

        // MOVIMIENTO "TANQUE" (Giro -> Avance) - RECUPERADO
        scene.onPointerDown = (evt, pick) => { if (pick.hit && pick.pickedMesh === suelo) destinoFinal = pick.pickedPoint; };
        
        scene.onBeforeRenderObservable.add(() => {
            if (!personaje || !destinoFinal) return;
            let diff = destinoFinal.subtract(personaje.position);
            diff.y = 0;

            if (diff.length() > 1.5) {
                let anguloObjetivo = Math.atan2(diff.x, diff.z);
                let diferencia = anguloObjetivo - personaje.rotation.y;
                
                // Normalizar √°ngulo
                while (diferencia > Math.PI) diferencia -= Math.PI * 2;
                while (diferencia < -Math.PI) diferencia += Math.PI * 2;

                // L√ìGICA DE MOVIMIENTO NATURAL
                if (Math.abs(diferencia) > 0.1) {
                    // Si el √°ngulo es grande, solo gira
                    personaje.rotation.y += diferencia * 0.15;
                    if (animCaminar) animCaminar.stop();
                } else {
                    // Si ya mira al objetivo, camina
                    personaje.rotation.y = anguloObjetivo;
                    diff.normalize();
                    personaje.moveWithCollisions(diff.scale(1.0)); // Velocidad ajustada
                    if (animCaminar && !animCaminar.isPlaying) animCaminar.play(true);
                }
            } else {
                if (animCaminar) animCaminar.stop();
                destinoFinal = null;
            }
        });

        // === 4. C√ÅMARA Y REPORTE ===
        const videoFeed = document.getElementById('camera-feed');
        let streamActivo = null;
        let coordsActuales = null;

        function abrirModal() {
            document.getElementById('modal-reporte').style.display = 'flex';
            if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
                .then(stream => {
                    streamActivo = stream;
                    videoFeed.srcObject = stream;
                });
            }
            navigator.geolocation.getCurrentPosition(pos => {
                coordsActuales = pos.coords;
                fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${pos.coords.latitude}&lon=${pos.coords.longitude}`)
                .then(r => r.json())
                .then(data => {
                    document.getElementById('direccion-detectada').innerText = `üìç ${data.address.road || 'Calle'}, ${data.address.house_number || ''}`;
                });
            });
        }

        function cerrarModal() {
            document.getElementById('modal-reporte').style.display = 'none';
            if (streamActivo) { streamActivo.getTracks().forEach(track => track.stop()); }
        }

        function capturarYEnviar() {
            const mensaje = document.getElementById('mensaje-reporte').value;
            const emailVecino = document.getElementById('email-vecino').value;
            
            const canvasFoto = document.getElementById('photo-canvas');
            canvasFoto.width = videoFeed.videoWidth;
            canvasFoto.height = videoFeed.videoHeight;
            canvasFoto.getContext('2d').drawImage(videoFeed, 0, 0);
            
            db.collection("reportes_finales").add({
                mensaje: mensaje || "Reporte R√°pido",
                contacto: emailVecino,
                lat: coordsActuales ? coordsActuales.latitude : 0,
                lon: coordsActuales ? coordsActuales.longitude : 0,
                fecha: new Date()
            }).then(() => {
                const asunto = `üö® Reporte Ciudadano`;
                const cuerpo = `Detalle: ${mensaje}\nUbicaci√≥n: https://maps.google.com/?q=${coordsActuales.latitude},${coordsActuales.longitude}`;
                window.location.href = `mailto:vecinoslaserenachile@gmail.com?cc=${emailVecino}&subject=${encodeURIComponent(asunto)}&body=${encodeURIComponent(cuerpo)}`;
                alert("‚úÖ Reporte Enviado Correctamente");
                cerrarModal();
            });
        }

        window.camaraSerenito = () => { camera.lockedTarget = personaje; camera.radius = 120; }
        window.camaraAerea = () => { camera.lockedTarget = null; camera.setPosition(new BABYLON.Vector3(500, 800, 500)); camera.setTarget(new BABYLON.Vector3(500, 0, 300)); }

        window.addEventListener("resize", () => engine.resize());
        engine.runRenderLoop(() => scene.render());

    </script>
</body>
</html>
