<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>LA‚ù§Ô∏èSERENA - Sistema de Recuperaci√≥n</title>
    
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">

    <style>
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; background-color: #87CEEB; font-family: sans-serif; }
        #renderCanvas { width: 100%; height: 100%; touch-action: none; outline: none; }
        
        /* CONSOLA DE DIAGN√ìSTICO (Para ver errores en pantalla) */
        #debug-console {
            position: absolute; top: 0; left: 0; width: 100%; background: rgba(255,0,0,0.8); 
            color: white; padding: 5px; font-size: 12px; z-index: 9999; display: none;
        }

        /* UI SUPERIOR */
        .top-ui { position: absolute; top: 40px; left: 15px; right: 15px; display: flex; justify-content: space-between; z-index: 100; pointer-events: none; }
        .pointer { pointer-events: auto; }

        /* Tarjeta Radio */
        .card { background: rgba(0,0,0,0.8); color: white; padding: 10px 15px; border-radius: 30px; display: flex; align-items: center; gap: 10px; border: 1px solid gold; box-shadow: 0 4px 10px rgba(0,0,0,0.5); }
        
        /* Toolbar */
        #toolbar { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 15px; z-index: 100; }
        .btn { width: 60px; height: 60px; border-radius: 50%; border: none; background: white; font-size: 24px; cursor: pointer; box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .btn-main { background: #ff3333; color: white; border: 3px solid white; transform: translateY(-10px); }

        /* Modales */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 2000; align-items: center; justify-content: center; }
        .box { background: #222; width: 90%; max-width: 400px; padding: 20px; border-radius: 15px; color: white; text-align: center; border: 1px solid #444; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #333; border: 1px solid #555; color: white; box-sizing: border-box; }
    </style>
</head>
<body>

    <div id="debug-console"></div>

    <div class="top-ui">
        <div class="card pointer">
            <i class="fas fa-play" id="icon-play" onclick="toggleRadio()" style="cursor:pointer;"></i>
            <span>RADIO MUNI</span>
        </div>
        <div class="card pointer" onclick="login()" id="btn-login-ui">
            <i class="fab fa-google"></i> <span id="txt-login">Acceder</span>
        </div>
    </div>

    <audio id="audio-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <canvas id="renderCanvas"></canvas>

    <div id="toolbar">
        <button class="btn" onclick="verHistorial()"><i class="fas fa-list"></i></button>
        <button class="btn btn-main" onclick="abrirReporte()"><i class="fas fa-camera"></i></button>
        <button class="btn" onclick="resetCamara()"><i class="fas fa-walking"></i></button>
    </div>

    <div id="modal-rep" class="modal">
        <div class="box">
            <h2 style="color:gold;">üì∑ Reporte</h2>
            <video id="cam" autoplay playsinline style="width:100%; height:200px; background:black; margin-bottom:10px;"></video>
            <canvas id="snap" style="display:none;"></canvas>
            <input type="text" id="desc" placeholder="Describe el problema...">
            <button onclick="enviar()" style="width:100%; padding:15px; background:gold; border:none; font-weight:bold; cursor:pointer;">ENVIAR</button>
            <button onclick="document.getElementById('modal-rep').style.display='none'" style="margin-top:10px; background:none; border:none; color:#aaa; cursor:pointer;">Cancelar</button>
        </div>
    </div>

    <div id="modal-hist" class="modal">
        <div class="box">
            <h3>üìÇ Mis Reportes</h3>
            <div id="lista" style="text-align:left; max-height:300px; overflow-y:auto;">Cargando...</div>
            <button onclick="document.getElementById('modal-hist').style.display='none'" style="margin-top:10px; background:none; border:none; color:#aaa; cursor:pointer;">Cerrar</button>
        </div>
    </div>

    <script>
        // === SISTEMA DE DIAGN√ìSTICO ===
        function logError(msg) {
            const consoleDiv = document.getElementById('debug-console');
            consoleDiv.style.display = 'block';
            consoleDiv.innerHTML += "‚ö†Ô∏è " + msg + "<br>";
            console.error(msg);
        }

        try {
            // 1. FIREBASE INIT
            const firebaseConfig = {
                apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4",
                authDomain: "laserena-d1263.firebaseapp.com",
                projectId: "laserena-d1263",
                storageBucket: "laserena-d1263.firebasestorage.app",
                messagingSenderId: "283725387947",
                appId: "1:283725387947:web:898aa22c80c2fadbe8bfee"
            };
            firebase.initializeApp(firebaseConfig);
            const db = firebase.firestore();
            const auth = firebase.auth();
            let userCurrent = null;

            // Auth Listener
            auth.onAuthStateChanged(u => {
                if(u) {
                    userCurrent = u;
                    document.getElementById('txt-login').innerText = u.displayName.split(' ')[0];
                } else {
                    userCurrent = null;
                    document.getElementById('txt-login').innerText = "Acceder";
                }
            });

            window.login = () => {
                const p = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(p).catch(e => logError("Login Error: " + e.message));
            };

            // 2. MOTOR 3D
            const canvas = document.getElementById("renderCanvas");
            if (!BABYLON) throw new Error("BabylonJS no carg√≥.");
            
            const engine = new BABYLON.Engine(canvas, true);
            let scene, camera, personaje, anim;
            let destino = null;

            const createScene = function () {
                const s = new BABYLON.Scene(engine);
                s.clearColor = new BABYLON.Color3(0.53, 0.81, 0.92);
                s.gravity = new BABYLON.Vector3(0, -0.9, 0);
                s.collisionsEnabled = true;

                const light = new BABYLON.HemisphericLight("light", new BABYLON.Vector3(0, 1, 0), s);
                light.intensity = 1.0;

                camera = new BABYLON.ArcRotateCamera("cam", -Math.PI/2, Math.PI/3, 150, BABYLON.Vector3.Zero(), s);
                camera.attachControl(canvas, true);
                
                // PISO
                const suelo = BABYLON.MeshBuilder.CreateGround("suelo", {width: 2000, height: 2000}, s);
                const mat = new BABYLON.StandardMaterial("mat", s);
                mat.diffuseTexture = new BABYLON.Texture("mapa.jpg", s);
                suelo.material = mat;
                suelo.checkCollisions = true;

                // EDIFICIOS (Con manejo de error)
                const loadMesh = (file, x, z, scale, rot) => {
                    BABYLON.SceneLoader.ImportMesh("", "./", file, s, (m) => {
                        let mesh = m[0];
                        let root = new BABYLON.TransformNode("root", s);
                        mesh.parent = root;
                        
                        // Normalizar escala
                        const b = mesh.getHierarchyBoundingVectors(true);
                        const size = b.max.subtract(b.min);
                        const factor = scale / Math.max(size.x, size.y, size.z);
                        mesh.scaling = new BABYLON.Vector3(factor, factor, factor);
                        
                        root.rotation.y = rot;
                        root.position = new BABYLON.Vector3(x, -b.min.y*factor, z);
                    }, null, (e) => logError("Error cargando " + file));
                };

                loadMesh("municipalidad.glb", 610, 160, 150, Math.PI);
                loadMesh("intendencia.glb", 430, 410, 180, 0);

                // SERENITO
                BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", s, (m, ps, sk, a) => {
                    personaje = m[0];
                    personaje.scaling = new BABYLON.Vector3(-10, 10, 10);
                    personaje.position = new BABYLON.Vector3(0, 5, 0);
                    personaje.ellipsoid = new BABYLON.Vector3(1, 2, 1);
                    personaje.ellipsoidOffset = new BABYLON.Vector3(0, 2, 0);
                    personaje.checkCollisions = true;
                    personaje.applyGravity = true;
                    camera.lockedTarget = personaje;
                    if(a && a.length > 0) { anim = a[0]; anim.stop(); }
                }, null, (e) => logError("Error cargando Serenito"));

                // MOVIMIENTO
                s.onPointerDown = (evt, pick) => { if(pick.hit && pick.pickedMesh === suelo) destino = pick.pickedPoint; };
                
                s.onBeforeRenderObservable.add(() => {
                    if(!personaje || !destino) return;
                    let diff = destino.subtract(personaje.position);
                    diff.y = 0;
                    if(diff.length() > 1.5) {
                        let angle = Math.atan2(diff.x, diff.z);
                        let rotData = angle - personaje.rotation.y;
                        while (rotData > Math.PI) rotData -= Math.PI * 2;
                        while (rotData < -Math.PI) rotData += Math.PI * 2;
                        
                        // Giro suave
                        personaje.rotation.y += rotData * 0.1;
                        
                        // Avance
                        if(Math.abs(rotData) < 0.5) {
                            personaje.moveWithCollisions(diff.normalize().scale(1.0));
                            if(anim && !anim.isPlaying) anim.play(true);
                        }
                    } else {
                        if(anim) anim.stop();
                        destino = null;
                    }
                });

                return s;
            };

            scene = createScene();
            
            engine.runRenderLoop(() => { scene.render(); });
            window.addEventListener("resize", () => engine.resize());

            // 3. FUNCIONES DE UI
            window.toggleRadio = () => {
                const aud = document.getElementById('audio-player');
                const icon = document.getElementById('icon-play');
                if(aud.paused) {
                    aud.play().then(() => { icon.className = "fas fa-stop"; icon.style.color = "red"; })
                    .catch(e => alert("Navegador bloque√≥ audio. Dale click de nuevo."));
                } else {
                    aud.pause();
                    icon.className = "fas fa-play";
                    icon.style.color = "white";
                }
            };

            window.resetCamara = () => { if(personaje) { camera.lockedTarget = personaje; camera.radius = 150; } };

            let videoStream = null;
            window.abrirReporte = () => {
                if(!userCurrent) return alert("Debes ACCEDER primero.");
                document.getElementById('modal-rep').style.display = 'flex';
                navigator.mediaDevices.getUserMedia({video: {facingMode: "environment"}}).then(s => {
                    videoStream = s;
                    document.getElementById('cam').srcObject = s;
                });
            };

            window.enviar = () => {
                const desc = document.getElementById('desc').value;
                const vid = document.getElementById('cam');
                const cv = document.getElementById('snap');
                cv.width = vid.videoWidth; cv.height = vid.videoHeight;
                cv.getContext('2d').drawImage(vid, 0, 0);

                db.collection("incidencias").add({
                    uid: userCurrent.uid,
                    vecino: userCurrent.displayName,
                    desc: desc,
                    estado: "Ingresado",
                    fecha: new Date(),
                    fecha_str: new Date().toLocaleDateString()
                }).then(() => {
                    alert("Enviado!");
                    document.getElementById('modal-rep').style.display = 'none';
                    if(videoStream) videoStream.getTracks().forEach(t => t.stop());
                });
            };

            window.verHistorial = () => {
                if(!userCurrent) return alert("Accede primero.");
                document.getElementById('modal-hist').style.display = 'flex';
                const list = document.getElementById('lista');
                list.innerHTML = "Cargando...";
                db.collection("incidencias").where("uid", "==", userCurrent.uid).orderBy("fecha", "desc").get()
                .then(snap => {
                    list.innerHTML = "";
                    snap.forEach(d => {
                        const data = d.data();
                        list.innerHTML += `<div style="background:#333; padding:10px; margin-bottom:5px; border-radius:5px;"><b>${data.fecha_str}</b>: ${data.desc} <br><small style="color:gold">${data.estado}</small></div>`;
                    });
                });
            };

        } catch (error) {
            logError("CRASH CR√çTICO: " + error.message);
        }
    </script>
</body>
</html>
