<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Serenito IA | Consultor Municipal 2026</title>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <style>
        body { margin: 0; font-family: 'Roboto', sans-serif; background: #0f0f0f; color: white; height: 100vh; display: flex; flex-direction: column; }
        #chat { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 12px; }
        .msg { padding: 12px 16px; border-radius: 18px; max-width: 85%; font-size: 14px; line-height: 1.5; }
        .serenito { background: #1e1e1e; align-self: flex-start; border-left: 4px solid #ffd700; color: #f0f0f0; }
        .vecino { background: #b71c1c; align-self: flex-end; color: white; }
        .ia-form { background: #000; padding: 15px; border-radius: 10px; margin-top: 10px; border: 1px solid #ffd700; }
        .ia-form input, .ia-form textarea { width: 100%; margin-bottom: 8px; background: #222; border: 1px solid #444; color: white; padding: 10px; border-radius: 5px; box-sizing: border-box; }
        .ia-form button { width: 100%; background: #2e7d32; color: white; border: none; padding: 10px; border-radius: 5px; font-weight: bold; cursor: pointer; }
        #input-area { background: #1a1a1a; padding: 15px; display: flex; gap: 10px; border-top: 1px solid #333; }
        input#user-in { flex: 1; background: #000; border: 1px solid #444; color: white; padding: 14px; border-radius: 25px; outline: none; }
        button#send-btn { background: #ffd700; border: none; color: black; padding: 0 20px; border-radius: 25px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div id="chat">
        <div class="msg serenito">üåü ¬°Hola! Soy **Serenito IA**. Hoy es **22 de febrero de 2026**. Estoy capacitado con los √∫ltimos manuales de procedimientos municipales para ayudarte con Patentes, Inspecciones y tr√°mites de Verano. ¬øEn qu√© puedo orientarte?</div>
    </div>
    <div id="input-area">
        <input type="text" id="user-in" placeholder="Dime tu tr√°mite o consulta..." onkeypress="if(event.key==='Enter')procesar()">
        <button id="send-btn" onclick="procesar()">ENVIAR</button>
    </div>

    <script>
        const firebaseConfig = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // MOTOR DE CONOCIMIENTO ACTUALIZADO (INCLUYE NUEVOS MANUALES)
        const BRAIN = [
            {
                keys: ["patente", "comercial", "industrial", "profesional", "emprender"],
                resp: "üè¢ **Tramitaci√≥n de Patentes:** Para obtener tu patente comercial o industrial, el Departamento de Rentas requiere: 1. Acreditaci√≥n de domicilio, 2. Iniciaci√≥n de actividades ante el SII y 3. Verificaci√≥n de zonificaci√≥n. ¬øQuieres que abra un ticket para que el equipo de Rentas revise tu caso?",
                hasForm: true, type: "Rentas/Patentes"
            },
            {
                keys: ["denuncia", "denunciar", "ruidos", "ilegal", "inspector", "inspecci√≥n"],
                resp: "‚öñÔ∏è **Procedimiento de Inspecci√≥n:** Toda denuncia formal se ingresa por la Oficina de Partes. Un inspector visitar√° el lugar y, de detectar una infracci√≥n, notificar√° al Juzgado de Polic√≠a Local. Para agilizar, puedo derivar tus datos ahora mismo a la **Unidad de Inspecci√≥n Municipal**:",
                hasForm: true, type: "Inspecci√≥n/Fiscalizaci√≥n"
            },
            {
                keys: ["permiso", "circulaci√≥n", "pagar", "patente", "vehiculo"],
                resp: "üöó **Permiso de Circulaci√≥n 2026:** ¬°√öltimas semanas! Puntos habilitados en CCU, Polideportivo Las Compa√±√≠as y Outlet Pe√±uelas. Atendemos este s√°bado de 09:00 a 14:00.",
                hasForm: true, type: "Tr√°nsito"
            },
            {
                keys: ["historia", "fundada", "pirata", "san francisco"],
                resp: "üèõÔ∏è La Serena (1544) es la segunda m√°s antigua de Chile. Sobrevivimos al pirata Bartholomew Sharp en 1680. Nuestra arquitectura actual se rige por el **'Plan Serena'** neocolonial."
            },
            {
                keys: ["bienestar", "funcionario", "reembolso"],
                resp: "üè• **Servicio de Bienestar:** Si eres funcionario municipal, recuerda que las solicitudes de reembolso m√©dico deben incluir los comprobantes originales y el informe del m√©dico tratante seg√∫n el manual vigente."
            }
        ];

        function procesar() {
            const inpt = document.getElementById('user-in');
            const txt = inpt.value.trim().toLowerCase();
            if(!txt) return;
            addMsg(inpt.value, 'vecino'); inpt.value = "";
            
            setTimeout(() => {
                let match = BRAIN.find(k => k.keys.some(key => txt.includes(key)));
                let res = match ? match.resp : "Entiendo tu requerimiento. üßê Para darte una soluci√≥n oficial, lo derivar√© a nuestro **Back-office Municipal**. Por favor, completa los detalles para que un funcionario te contacte:";
                let html = res;
                if(match?.hasForm || !match) {
                    html += `<div class="ia-form">
                        <input id="f-nom" placeholder="Tu Nombre">
                        <textarea id="f-det" placeholder="Explica detalladamente tu caso para el funcionario..."></textarea>
                        <button onclick="enviarTicket('${match?.type || 'Consulta General'}')">ENVIAR A GESTI√ìN</button>
                    </div>`;
                }
                addMsg(html, 'serenito');
            }, 450);
        }

        function addMsg(t, c) { const d = document.getElementById('chat'); d.innerHTML += `<div class="msg ${c}">${t}</div>`; d.scrollTop = d.scrollHeight; }

        async function enviarTicket(tipo) {
            const n = document.getElementById('f-nom').value || "An√≥nimo";
            const m = document.getElementById('f-det').value;
            if(!m) return alert("Por favor, escribe el detalle.");
            await db.collection("tickets_ia").add({ nombre: n, mensaje: m, tipo: tipo, fecha: new Date(), estado: "Pendiente" });
            addMsg("‚úÖ **Serenito:** ¬°Excelente! He enviado tu caso a la bandeja del funcionario municipal. Recibir√°s respuesta pronto.", "serenito");
        }
    </script>
</body>
</html>
