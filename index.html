<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDMLS | La Serena 2026</title>
    
    <link rel="icon" id="dynamic-favicon" type="image/png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --serena-red: #b71c1c; --serena-gold: #ffd700; --dark: #0f0f0f; --panel: #111; }
        
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--dark); color: white; width: 100%; height: 100%; overflow: hidden; }

        /* --- LAYOUTS --- */
        @media (min-width: 1024px) {
            body { overflow: hidden; } 
            #main-layout { display: grid; width: 100vw; height: 100vh; grid-template-columns: 360px 1fr 360px; grid-template-rows: 100%; }
            #sidebar-wrapper { background: linear-gradient(180deg, #b71c1c 0%, #5f0000 100%); padding: 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--serena-gold) #222; box-shadow: 4px 0 20px rgba(0,0,0,0.6); z-index: 50; }
            #stage-area { height: 100%; position: relative; border-left: 2px solid var(--serena-gold); border-right: 2px solid var(--serena-gold); }
            #form-panel { background: var(--panel); padding: 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--serena-gold) #222; }
            #mobile-footer { display: none; }
        }

        @media (max-width: 1023px) {
            body { overflow-y: auto; overflow-x: hidden; }
            #main-layout { display: flex; flex-direction: column; width: 100%; min-height: 100vh; }
            #sidebar-wrapper { display: contents; } 
            #sidebar-header { order: 1; padding: 15px; background: linear-gradient(180deg, #b71c1c 0%, #8e0000 100%); text-align: center; z-index: 50; }
            #sidebar-tools { order: 2; padding: 15px; background: #1a1a1a; border-bottom: 1px solid #333; }
            #stage-area { order: 3; height: 50vh !important; width: 100%; position: relative; z-index: 10; border-top: 2px solid var(--serena-gold); border-bottom: 2px solid var(--serena-gold); margin: 0; }
            #form-panel { order: 4; padding: 20px; background: var(--panel); padding-bottom: 80px; margin-top: 0; }
            #mobile-footer { order: 5; display: block; padding: 30px; text-align: center; background: #0f0f0f; border-top: 1px solid #333; }
        }

        /* ESTILOS GENERALES */
        .escudo-img { width: 120px; margin: 0 auto; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }
        .rdmls-sigla { font-family: 'Oswald'; font-size: 42px; margin: 5px 0 0 0; line-height: 1; text-align: center; text-shadow: 2px 2px 0 #000; }
        .clock { font-family: 'Oswald'; font-size: 26px; color: var(--serena-gold); margin-bottom: 10px; text-align: center; }
        
        .route-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-left: 4px solid var(--serena-gold); }
        .search-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .city-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; font-size: 14px; }
        .go-btn { background: var(--serena-gold); color: black; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .chip-container { margin-top: 10px; display: flex; gap: 6px; flex-wrap: wrap; }
        .chip { background: #333; padding: 6px 12px; font-size: 11px; border-radius: 20px; cursor: pointer; border: 1px solid #555; color: #ccc; transition: 0.2s; white-space: nowrap; }
        .chip:hover { border-color: var(--serena-gold); color: white; background: #444; }

        /* ESTILOS DE RESULTADOS DE RUTA (RECUPERADOS) */
        .route-list { margin-top: 15px; display: flex; flex-direction: column; gap: 5px; }
        .trans-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 6px; font-size: 13px; border-bottom: 1px solid #444; }
        .trans-icon { width: 25px; text-align: center; color: var(--serena-gold); margin-right: 10px; font-size: 16px; }

        .weather-card { background: rgba(0,0,0,0.4); border-radius: 12px; padding: 15px; margin-top: 20px; border: 1px solid #444; display: flex; align-items: center; justify-content: space-between; }
        .weather-temp { font-size: 32px; font-family: 'Oswald'; color: white; }
        .weather-detail { font-size: 11px; color: #aaa; text-align: right; }

        #map { width: 100%; height: 100%; z-index: 1; }
        #renderCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .btn-tour { position: absolute; bottom: 20px; left: 20px; z-index: 20; background: var(--serena-gold); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; border: 2px solid white; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }

        /* CRM & ADMIN */
        .crm-box { margin-top: 20px; background: #0a0a0a; padding: 15px; border-radius: 10px; border: 1px solid #333; max-height: 600px; overflow-y: auto; }
        .ticket-card { background: #161616; padding: 12px; border-radius: 6px; border-left: 3px solid #b71c1c; margin-bottom: 10px; font-size: 12px; }
        .ticket-card.respondido { border-left-color: #00e676; }
        .status-pill { float: right; font-size: 9px; padding: 2px 6px; border-radius: 4px; background: #333; color: gold; }
        .ticket-resp { background: #0d2b15; padding: 8px; border-radius: 4px; margin-top: 8px; color: #69f0ae; font-style: italic; border: 1px dashed #2e7d32; }
        .f-input { width: 100%; padding: 12px; margin-bottom: 8px; background: #222; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; font-size: 14px; }
        .btn-red { width: 100%; background: var(--serena-red); color: white; padding: 12px; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; }

        /* MODALES */
        #modal-lupa, #modal-camara, #modal-admin-full { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 30000; align-items: center; justify-content: center; flex-direction: column; padding: 10px; }
        #img-f-zoom { width: auto; max-width: 95%; max-height: 80vh; border: 2px solid white; border-radius: 5px; transition: transform 0.3s ease; cursor: zoom-in; }
        .close-lupa { position: absolute; top: 30px; right: 30px; font-size: 40px; color: white; cursor: pointer; background: var(--serena-red); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
        
        #modal-tour-3d { display: none; position: fixed; inset: 0; background: black; z-index: 20000; }
        #success-feedback { display: none; background: #1b5e20; color: white; padding: 15px; border-radius: 8px; text-align: center; margin-top: 10px; font-weight: bold; border: 2px solid #00e676; }
        
        /* CABINA FOTOS MEJORADA */
        #camera-wrapper { position: relative; width: 100%; max-width: 400px; border: 2px solid gold; border-radius: 10px; overflow: hidden; background: #000; background-size: cover; background-position: center; }
        #cam-video { width: 100%; display: block; transform: scaleX(-1); }
        #cam-overlay { position: absolute; bottom: 0; right: 0; width: 50%; max-width: 200px; pointer-events: none; z-index: 10; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); transition: transform 0.1s ease; }
        
        /* CONTROLES CABINA */
        .cabina-ui { width: 100%; max-width: 400px; margin-top: 10px; background: #222; padding: 10px; border-radius: 8px; border: 1px solid #444; }
        .control-row { margin-bottom: 8px; color: gold; font-size: 11px; font-weight: bold; }
        .control-row input, .control-row select { width: 100%; margin-top: 4px; accent-color: gold; }

        /* ADMIN FULL */
        #modal-admin-full { background: #111; overflow-y: auto; display: none; align-items: start; justify-content: start; padding: 0; }
        .admin-panel-container { width: 100%; min-height: 100vh; padding: 20px; box-sizing: border-box; }
        .admin-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid gold; padding-bottom: 20px; margin-bottom: 20px; }
        .btn-logout { background: #d32f2f; color: white; border: none; padding: 5px 10px; border-radius: 4px; font-size: 10px; font-weight: bold; cursor: pointer; margin-left: 10px; }
    </style>
</head>
<body onload="initApp()">

    <div id="main-layout">
        <div id="sidebar-wrapper">
            <div id="sidebar-header">
                <img src="escudo.png" class="escudo-img" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Escudo_de_La_Serena.svg/1200px-Escudo_de_La_Serena.svg.png'">
                <h1 class="rdmls-sigla">RDMLS</h1>
                <div class="clock" id="clock">00:00:00</div>
                <div style="text-align:center;">
                    <button onclick="toggleRadio()" style="background:white; color:var(--serena-red); border:none; width:60px; height:60px; border-radius:50%; cursor:pointer; box-shadow: 0 0 15px rgba(255,255,255,0.3); display:flex; align-items:center; justify-content:center; margin:0 auto;"><i class="fas fa-play" id="play-icon" style="margin-left:4px;"></i></button>
                </div>
            </div>

            <div id="sidebar-tools">
                <div class="route-box">
                    <div style="font-size:11px; color:var(--serena-gold); font-weight:bold; margin-bottom:10px;">PLANIFICADOR DE VIAJES</div>
                    <div class="search-row">
                        <input type="text" id="city-input" class="city-input" placeholder="쮸 d칩nde vamos hoy?">
                        <button class="go-btn" onclick="buscarYCalcular()"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="chip-container">
                        <div class="chip" onclick="calcDirect(-30.0330, -70.7081, 'Vicu침a')">Vicu침a</div>
                        <div class="chip" onclick="calcDirect(-30.2292, -71.0851, 'Andacollo')">Andacollo</div>
                        <div class="chip" onclick="calcDirect(-29.9533, -71.3395, 'Coquimbo')">Coquimbo</div>
                        <div class="chip" onclick="calcDirect(-30.6046, -71.2045, 'Ovalle')">Ovalle</div>
                    </div>
                    <div class="route-list" id="route-output"></div>
                    <button id="btn-reset-route" style="width:100%; background:#ff3d00; color:white; border:none; padding:8px; border-radius:5px; margin-top:10px; cursor:pointer; font-size:12px; font-weight:bold; display:none;" onclick="resetRoute()">CERRAR RUTA</button>
                </div>

                <div class="weather-card">
                    <div>
                        <div style="font-size:10px; color:#aaa; text-transform:uppercase;">Clima La Serena</div>
                        <div class="weather-temp" id="w-temp">--춿</div>
                    </div>
                    <div class="weather-detail">
                        <div id="w-wind">Viento: -- km/h</div>
                        <div id="w-desc">Actualizando...</div>
                    </div>
                    <i class="fas fa-sun" style="font-size:30px; color:gold;"></i>
                </div>

                <div style="margin-top:20px;">
                    <button onclick="abrirCamara()" style="width:100%; background:#222; border:1px solid gold; color:gold; padding:10px; border-radius:8px; cursor:pointer; margin-bottom:15px; font-weight:bold;">
                        <i class="fas fa-camera"></i> SELFIE CON SERENITO
                    </button>
                </div>
            </div>
        </div>

        <div id="stage-area">
            <div id="map"></div>
            <canvas id="renderCanvas"></canvas>
            <button class="btn-tour" onclick="abrirTourReal()"><i class="fas fa-street-view"></i> PASEO 3D</button>
        </div>

        <div id="form-panel">
            <div class="user-header">
                <button id="btn-login-vecino" onclick="login()" style="width:100%; background:#4285f4; color:white; border:none; padding:10px; border-radius:6px; cursor:pointer; font-weight:bold;"><i class="fab fa-google"></i> Acceso Vecino</button>
                <div id="user-info" style="margin-top:10px; display:none; align-items:center; gap:5px;"></div>
            </div>
            
            <div id="panel-vecino">
                <h4 style="color:var(--serena-gold); margin:0 0 10px 0;">CENTRAL DE REQUERIMIENTOS</h4>
                <div style="margin-bottom:15px;">
                    <label style="font-size:11px; color:#aaa;">Ubicaci칩n (Mueve el mapa):</label>
                    <input type="text" id="r-dir" class="f-input" style="color:var(--serena-gold); font-weight:bold; border-color:var(--serena-gold);" readonly placeholder="Geolocalizando...">
                </div>
                <input type="tel" id="r-phone" class="f-input" placeholder="Tel칠fono">
                <input type="text" id="r-asunto" class="f-input" placeholder="Asunto">
                <textarea id="r-desc" class="f-input" rows="3" placeholder="Descripci칩n..."></textarea>
                
                <div style="margin-bottom:10px;">
                    <label style="font-size:11px; color:#aaa;">Evidencia (Foto/Video):</label>
                    <input type="file" id="r-foto" accept="image/*,video/*" capture="environment" style="font-size:11px; color:white; margin-top:5px; width:100%;">
                </div>
                
                <button id="btn-env-rep" onclick="enviarReporteCRM()" class="btn-red">ENVIAR A MUNICIPALIDAD</button>
                <div id="success-feedback">游 춰MUCHAS GRACIAS! Reporte enviado.</div>

                <div id="crm-box" class="crm-box" style="display:none;">
                    <div style="font-size:11px; color:var(--serena-gold); font-weight:bold; margin-bottom:5px;">HISTORIAL DE REPORTES</div>
                    <div id="history-list"></div>
                </div>
            </div>
        </div>
        
        <div id="mobile-footer">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <img src="escudo.png" style="width:50px; opacity:0.8;">
                <i class="fas fa-lock" onclick="loginFuncionario()" style="color:#333; cursor:pointer;"></i>
            </div>
            <h1 class="rdmls-sigla" style="font-size:30px; opacity:0.8;">RDMLS</h1>
        </div>
    </div>

    <div id="modal-lupa" style="display:none;" onclick="closeLupa(event)">
        <div class="close-lupa" onclick="document.getElementById('modal-lupa').style.display='none'">&times;</div>
        <img id="img-f-zoom" src="" onclick="toggleZoom(event)">
        <div id="lupa-caption"></div>
    </div>

    <div id="modal-camara">
        <div class="close-lupa" onclick="cerrarCamara()">&times;</div>
        <div id="camera-wrapper">
            <video id="cam-video" autoplay playsinline></video>
            <img id="cam-overlay" src="serenito.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3660/3660358.png'"> 
        </div>
        
        <div class="cabina-ui">
            <div class="control-row">
                FONDO 
                <select onchange="cambiarFondoCabina(this.value)">
                    <option value="">C치mara Real</option>
                    <option value="faro.jpg">Faro Monumental</option>
                    <option value="plaza.jpg">Plaza de Armas</option>
                    <option value="recova.jpg">La Recova</option>
                </select>
            </div>
            <div class="control-row">
                TAMA칌O SERENITO 
                <input type="range" min="30" max="100" value="50" oninput="document.getElementById('cam-overlay').style.width = this.value + '%'">
            </div>
            <div class="control-row">
                ROTACI칍N
                <input type="range" min="-180" max="180" value="0" oninput="document.getElementById('cam-overlay').style.transform = 'rotate('+this.value+'deg)'">
            </div>
            <button onclick="tomarFoto()" style="margin-top:10px; width:100%; background:gold; color:black; border:none; padding:12px; border-radius:50px; font-weight:bold; font-size:16px; cursor:pointer;">CAPTURAR FOTO</button>
        </div>
        <canvas id="foto-canvas" style="display:none;"></canvas>
    </div>

    <div id="modal-admin-full">
        <div class="admin-panel-container">
            <div class="admin-header">
                <h2 style="color:gold; font-family:'Oswald'; margin:0;">PANEL DE CONTROL MUNICIPAL</h2>
                <button onclick="logoutFuncionario()" class="btn-logout">CERRAR SESI칍N</button>
            </div>
            <div id="admin-ticket-list" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:15px;">Cargando...</div>
        </div>
    </div>

    <div id="modal-tour-3d"><button style="position:absolute; top:20px; right:20px; z-index:21000; background:var(--serena-red); color:white; border:none; padding:10px 25px; border-radius:30px; cursor:pointer; font-weight:bold;" onclick="document.getElementById('modal-tour-3d').style.display='none'">VOLVER</button><canvas id="tour-canvas" style="width:100%; height:100%;"></canvas></div>

    <audio id="radio" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <script>
        // GLOBALES
        let serenitoMesh = null, routePolyline = null, destMarker = null, routeInterval = null, isAdmin = false;
        let sIcon = L.divIcon({ html: `<div id="serenito-body" style="position:relative; width:50px; height:80px;"><img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" style="width:30px; position:absolute; bottom:0; left:10px; z-index:1;"><img src="serenito.png" style="width:50px; position:absolute; bottom:15px; left:0; z-index:2;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3660/3660358.png'"></div>`, className: 'custom-serenito', iconSize: [50, 80], iconAnchor: [25, 80] });
        const ticketIcon = L.icon({ iconUrl: 'https://cdn-icons-png.flaticon.com/512/148/148767.png', iconSize: [40, 40], iconAnchor: [20, 40], popupAnchor: [0, -40] });

        function initApp() {
            crearFavicon(); fetchWeather();
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'), 1000);
            window.addEventListener("resize", () => { engine.resize(); setTimeout(() => map.invalidateSize(), 100); });
        }

        // --- RADIO FIX ---
        async function toggleRadio() {
            const r = document.getElementById('radio');
            const btn = document.getElementById('play-icon');
            if (r.paused) {
                try { await r.play(); btn.className = "fas fa-pause"; } catch (err) { console.error("Radio Error", err); }
            } else {
                r.pause(); btn.className = "fas fa-play";
            }
        }

        // --- TRAYECTOS CON ICONOS Y TIEMPOS ---
        function calcDirect(lat, lon, name) {
            map.invalidateSize();
            if(routeInterval) clearInterval(routeInterval);
            const startPoint = LS; const endPoint = [lat, lon];
            
            // Distancia aproximada
            const dist = (L.latLng(LS).distanceTo([lat, lon]) / 1000) * 1.35; 

            // RENDERIZADO DE TABLA DE RESULTADOS
            document.getElementById('route-output').innerHTML = `
                <div style="text-align:center; color:white; font-weight:bold; margin-bottom:5px;">Hacia: ${name} (${dist.toFixed(0)} km)</div>
                <div class="trans-row"><div style="display:flex;align-items:center;"><i class="fas fa-car trans-icon"></i> Auto</div> <span>${(dist/70).toFixed(1)} h</span></div>
                <div class="trans-row"><div style="display:flex;align-items:center;"><i class="fas fa-bus trans-icon"></i> Bus</div> <span>${(dist/45).toFixed(1)} h</span></div>
                <div class="trans-row"><div style="display:flex;align-items:center;"><i class="fas fa-bicycle trans-icon"></i> Bici</div> <span>${(dist/16).toFixed(1)} h</span></div>
                <div class="trans-row"><div style="display:flex;align-items:center;"><i class="fas fa-walking trans-icon"></i> A Pie</div> <span>${(dist/5).toFixed(1)} h</span></div>
                <div class="trans-row"><div style="display:flex;align-items:center;"><i class="fas fa-plane trans-icon"></i> Avi칩n</div> <span>${(dist/800).toFixed(1)} h</span></div>
            `;
            document.getElementById('btn-reset-route').style.display='block';
            
            // Trazado en mapa
            if(routePolyline) map.removeLayer(routePolyline);
            if(destMarker) map.removeLayer(destMarker);
            routePolyline = L.polyline([startPoint, endPoint], {color:'#b71c1c', weight:4, dashArray:'10,10'}).addTo(map);
            destMarker = L.marker(endPoint, {icon: ticketIcon}).addTo(map);
            map.fitBounds(routePolyline.getBounds(), {padding:[50,50]});
        }

        // --- CABINA FOTOS (LOGICA NUEVA) ---
        let videoStream = null;
        async function abrirCamara() {
            document.getElementById('modal-camara').style.display = 'flex';
            const video = document.getElementById('cam-video');
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                video.srcObject = videoStream;
            } catch (err) { alert("C치mara no disponible."); cerrarCamara(); }
        }
        function cerrarCamara() {
            document.getElementById('modal-camara').style.display = 'none';
            if(videoStream) { videoStream.getTracks().forEach(t => t.stop()); videoStream = null; }
        }
        function cambiarFondoCabina(img) {
            const wrap = document.getElementById('camera-wrapper');
            const video = document.getElementById('cam-video');
            if(img) { wrap.style.backgroundImage = `url('${img}')`; video.style.opacity = '0.5'; }
            else { wrap.style.backgroundImage = 'none'; video.style.opacity = '1'; }
        }
        function tomarFoto() {
            alert("游 Captura RDMLS Guardada.");
            cerrarCamara();
        }

        // --- BASE APP (MAPA, AUTH, ETC) ---
        function crearFavicon() { /* ... */ }
        function fetchWeather() { /* ... */ }
        
        const fbCfg = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(fbCfg);
        const db = firebase.firestore(); const auth = firebase.auth();
        const LS = [-29.9027, -71.2520];
        const map = L.map('map', {zoomControl:false}).setView(LS, 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        serenitoMarker = L.marker(LS, {icon: sIcon, zIndexOffset: 1000}).addTo(map);

        // AUTH
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        function logout() { auth.signOut().then(() => alert("Sesi칩n cerrada.")); }
        
        auth.onAuthStateChanged(u => { 
            if(u){ 
                user=u; 
                document.getElementById('user-info').style.display = 'flex';
                document.getElementById('user-info').innerHTML=`<img src="${u.photoURL}" class="avatar" style="width:30px;border-radius:50%;"> <div style="font-size:12px;"><b>${u.displayName}</b></div><button class="btn-logout" onclick="logout()">Salir</button>`;
                document.getElementById('btn-login-vecino').style.display = 'none';
                document.getElementById('crm-box').style.display = 'block';
                cargarCRM(u.uid); // <--- ESTO CARGA EL HISTORIAL
            } else {
                user = null; 
                document.getElementById('user-info').style.display = 'none';
                document.getElementById('btn-login-vecino').style.display = 'block';
                document.getElementById('crm-box').style.display = 'none';
                document.getElementById('history-list').innerHTML = '';
            }
        });

        function cargarCRM(uid) {
            db.collection("tickets_ia").where("userId", "==", uid).onSnapshot(snap => {
                const h = document.getElementById('history-list'); h.innerHTML = "";
                if(snap.empty) { h.innerHTML = "<div style='color:#888; font-size:12px;'>No tienes incidencias registradas.</div>"; return; }
                snap.forEach(doc => {
                    let d = doc.data();
                    h.innerHTML += `<div class="ticket-card ${d.respuesta ? 'respondido' : ''}">
                        <span class="status-pill">${d.estado}</span><b>${d.asunto}</b><br><small>${d.mensaje}</small>
                        ${d.respuesta ? `<div class="ticket-resp">${d.respuesta}</div>` : ''}
                    </div>`;
                });
            });
        }

        // FUNCIONES DE SOPORTE Y PASEO 3D (Mantenidas del original)
        function resetRoute(){ if(routePolyline) map.removeLayer(routePolyline); if(destMarker) map.removeLayer(destMarker); document.getElementById('btn-reset-route').style.display='none'; document.getElementById('route-output').innerHTML=""; map.flyTo(LS, 17); }
        function buscarYCalcular(){ const q = document.getElementById('city-input').value; if(!q)return; fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`).then(r=>r.json()).then(d=>{ if(d.length) calcDirect(parseFloat(d[0].lat), parseFloat(d[0].lon), d[0].display_name.split(',')[0]); }); }
        
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine); scene.clearColor = new BABYLON.Color4(0,0,0,0);
        const cam = new BABYLON.ArcRotateCamera("c", Math.PI/2, Math.PI/2.5, 100, BABYLON.Vector3.Zero(), scene);
        new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0,1,0), scene);
        BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", scene, (m) => { let s = m[0]; s.scaling = new BABYLON.Vector3(12,12,-12); s.position.y = -25; cam.lockedTarget = s; });
        engine.runRenderLoop(() => scene.render());

        function abrirTourReal() {
            document.getElementById('modal-tour-3d').style.display = 'block';
            if(!tourEngine) {
                const tc = document.getElementById('tour-canvas'); tourEngine = new BABYLON.Engine(tc, true);
                const ts = new BABYLON.Scene(tourEngine); ts.clearColor = new BABYLON.Color3(0.5, 0.7, 1.0);
                const tCam = new BABYLON.ArcRotateCamera("tc", -Math.PI/2, Math.PI/3, 150, BABYLON.Vector3.Zero(), ts);
                tCam.attachControl(tc, true);
                new BABYLON.HemisphericLight("tl", new BABYLON.Vector3(0,1,0), ts);
                BABYLON.MeshBuilder.CreateGround("tg", {width:1000, height:1000}, ts);
                tourEngine.runRenderLoop(() => ts.render());
            }
        }
    </script>
</body>
</html>
