<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDMLS | La Serena 2026</title>
    
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/3660/3660358.png" type="image/png">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --serena-red: #b71c1c; --serena-gold: #ffd700; --dark: #0f0f0f; }
        
        /* BASE */
        body, html { 
            margin: 0; padding: 0; 
            font-family: 'Roboto', sans-serif; 
            background: var(--dark); color: white;
            width: 100%; height: 100%;
            scroll-behavior: smooth;
        }

        /* --- ESCRITORIO (NO TOCAR - MANTIENE ESTRUCTURA) --- */
        @media (min-width: 1024px) {
            body { overflow: hidden; } 
            #main-layout {
                display: grid; width: 100vw; height: 100vh;
                grid-template-columns: 360px 1fr 340px;
                grid-template-rows: 1fr;
            }
            #sidebar, #form-panel { 
                overflow-y: auto; 
                scrollbar-width: thin; 
                scrollbar-color: var(--serena-gold) #222; 
            }
            #mobile-helper, #mobile-footer { display: none; }
        }

        /* --- MÓVIL (REORDENAMIENTO ESTRATÉGICO) --- */
        @media (max-width: 1023px) {
            body, html { height: auto !important; overflow-y: visible !important; overflow-x: hidden; }
            #main-layout { display: flex; flex-direction: column; width: 100%; min-height: 100vh; }
            
            /* ORDEN VISUAL MÓVIL */
            #sidebar-header { order: 1; } /* 1. Identidad */
            #stage-area     { order: 2; height: 55vh !important; width: 100%; border-top: 2px solid var(--serena-gold); border-bottom: 2px solid var(--serena-gold); } /* 2. Mapa */
            #sidebar-tools  { order: 3; } /* 3. PLANIFICADOR (PEGADO AL MAPA) */
            #form-panel     { order: 4; padding-bottom: 100px; } /* 4. Formulario y Gestión */
            #mobile-footer  { order: 5; } /* 5. Cierre */

            /* Ajustes estéticos móvil */
            #sidebar-header, #sidebar-tools, #form-panel { width: 100%; padding: 15px; box-sizing: border-box; }
            
            #mobile-helper {
                position: fixed; bottom: 20px; right: 20px; z-index: 9999;
                background: var(--serena-gold); color: black; border-radius: 50%;
                width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
                box-shadow: 0 4px 10px rgba(0,0,0,0.5); opacity: 0.8;
            }
        }

        /* --- ESTILOS DE COMPONENTES --- */

        /* 1. SECCIONES DEL SIDEBAR (Divididas para flexbox móvil) */
        #sidebar { display: contents; } /* En móvil el contenedor padre desaparece visualmente para que los hijos obedezcan el order del main-layout */
        
        @media (min-width: 1024px) {
            #sidebar { 
                display: flex; flex-direction: column; 
                background: linear-gradient(180deg, #b71c1c 0%, #5f0000 100%); 
                padding: 20px; gap: 15px; box-shadow: 4px 0 20px rgba(0,0,0,0.6); z-index: 50;
            }
            /* En PC, header y tools están dentro del sidebar, no aplica el order del main-layout */
        }

        /* Estilos comunes Sidebar Parts */
        #sidebar-header, #sidebar-tools {
            background: linear-gradient(180deg, #b71c1c 0%, #5f0000 100%); /* Fondo rojo corporativo */
        }
        @media (max-width: 1023px) {
            #sidebar-tools { background: #1a1a1a; border-bottom: 1px solid #333; } /* Diferenciar en móvil */
        }

        .radio-header { text-align: center; border-bottom: 1px solid rgba(255,255,255,0.2); padding-bottom: 15px; }
        .escudo-img { width: 200px; max-width: 40%; height: auto; margin: 0 auto 5px auto; display:block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }
        
        .rdmls-sigla { font-family: 'Oswald', sans-serif; font-size: 48px; font-weight: 700; color: white; line-height: 0.9; margin: 0; letter-spacing: 1px; text-align: center; text-shadow: 3px 3px 0px #300000; }
        .rdmls-sub { font-family: 'Oswald', sans-serif; font-size: 12px; font-weight: 400; color: var(--serena-gold); margin-top: 5px; line-height: 1.2; text-transform: uppercase; letter-spacing: 2px; text-align: center; }

        .digital-clock { font-family: 'Oswald', sans-serif; font-size: 28px; margin: 5px 0; text-align: center; text-shadow: 0 0 10px rgba(255,215,0,0.5); }
        
        .route-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-left: 4px solid var(--serena-gold); display: flex; flex-direction: column; }
        .search-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .city-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; font-size: 14px; background: #222; color: white; }
        .go-btn { background: var(--serena-gold); color: black; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .chip-scroll-container { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 10px; margin-bottom: 10px; scrollbar-width: thin; scrollbar-color: var(--serena-gold) #333; }
        .chip { background: #333; padding: 8px 15px; border-radius: 20px; font-size: 12px; cursor: pointer; border: 1px solid #555; transition: 0.2s; white-space: nowrap; flex-shrink: 0; color: #ddd; }
        .chip:hover { border-color: var(--serena-gold); background: #444; color: white; }
        
        .route-list { margin-top: 5px; display: flex; flex-direction: column; gap: 6px; overflow-y: auto; max-height: 200px; }
        .trans-row { display: flex; align-items: center; justify-content: space-between; padding: 10px; background: rgba(0,0,0,0.6); border-radius: 6px; border-bottom: 1px solid #444; font-size: 12px; }
        
        /* Iconos de transporte */
        .trans-icon { width: 20px; text-align: center; margin-right: 8px; color: var(--serena-gold); }
        
        .reset-route-btn { background: #ff3d00; color: white; border: none; padding: 10px; width: 100%; border-radius: 5px; font-weight: bold; cursor: pointer; margin-top: 10px; font-size: 12px; display: none; }

        /* CENTRO (MAPA) */
        #stage-area { position: relative; flex-grow: 1; background: #333; overflow: hidden; }
        #map { width: 100%; height: 100%; z-index: 1; }
        #renderCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; outline: none; }
        .btn-tour { position: absolute; bottom: 20px; left: 20px; z-index: 20; background: var(--serena-gold); color: black; font-weight: bold; padding: 10px 15px; border-radius: 8px; border: 2px solid white; cursor: pointer; box-shadow: 0 4px 10px rgba(0,0,0,0.5); display: flex; align-items: center; gap: 8px; }
        .center-pin { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -100%); width: 40px; height: 40px; z-index: 20; pointer-events: none; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.5)); }

        /* DERECHA (FORMULARIO) */
        #form-panel { background: #1a1a1a; padding: 20px; border-left: 1px solid #333; overflow-y: auto; }
        
        .user-header { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #333; }
        .avatar { width: 35px; height: 35px; border-radius: 50%; border: 2px solid var(--serena-gold); }
        
        .f-input { width: 100%; padding: 12px; margin-bottom: 8px; background: #333; border: 1px solid #444; color: white; border-radius: 6px; box-sizing: border-box; transition: 0.3s; font-size: 14px; }
        .f-input:focus { border-color: var(--serena-gold); background: #222; outline: none; }
        
        .btn-green { width: 100%; background: #2e7d32; color: white; padding: 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-top: 10px; }
        .btn-red { width: 100%; background: var(--serena-red); color: white; padding: 12px; border:none; border-radius:6px; font-weight:bold; cursor:pointer; margin-top: 10px; }
        
        .graphic-filler { 
            width: 100%; border-radius: 8px; margin-top: 20px; 
            border: 2px solid #333; box-shadow: 0 4px 10px rgba(0,0,0,0.5); 
            transition: opacity 0.3s; object-fit: cover; cursor: zoom-in; 
        }

        /* FOOTER MÓVIL */
        #mobile-footer { padding: 30px; text-align: center; background: #111; color: #666; border-top: 1px solid #333; margin-top: 20px; }

        /* MODALES */
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: black; z-index: 9999; }
        .close-btn { position: absolute; top: 20px; right: 20px; padding: 10px; background: var(--serena-red); color: white; cursor: pointer; border-radius: 50px; font-weight: bold; z-index: 10001; border: 2px solid white; }
        
        #img-modal { display:none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 11000; align-items: center; justify-content: center; cursor: zoom-out; flex-direction: column; }
        #img-full { width: auto; max-width: 95%; max-height: 80vh; border: 3px solid white; border-radius: 5px; transition: transform 0.3s; }
        #img-full.zoomed { transform: scale(2.5); cursor: grab; }
        
        #success-modal { background: rgba(0,0,0,0.9); align-items: center; justify-content: center; z-index: 12000; }
        .success-box { background: #1a1a1a; padding: 30px; border-radius: 15px; border: 2px solid #00e676; text-align: center; max-width: 300px; box-shadow: 0 0 30px rgba(0,230,118,0.3); }

        /* CHAT FLOTANTE */
        #btn-chat-tramites { position:fixed; bottom:80px; right:20px; background:#b71c1c; color:white; border:2px solid white; width:55px; height:55px; border-radius:50%; box-shadow:0 4px 15px rgba(0,0,0,0.5); z-index:9999; font-size:24px; cursor:pointer; display:flex; align-items:center; justify-content:center; }
        #chat-window { display:none; position:fixed; bottom:140px; right:20px; width:320px; height:450px; background:#1a1a1a; border-radius:15px; border:2px solid var(--serena-gold); z-index:9999; flex-direction:column; box-shadow:0 20px 50px rgba(0,0,0,0.9); overflow:hidden; }
        @media (max-width: 1023px) { #chat-window { width: 90%; right: 5%; bottom: 100px; height: 60vh; } }

    </style>
</head>
<body onload="initApp()">

    <div id="mobile-helper" onclick="window.scrollTo(0,0)"><i class="fas fa-arrow-up"></i></div>

    <div id="main-layout">

        <div id="sidebar-header">
            <div class="radio-header">
                <img src="escudo.png" class="escudo-img" alt="Escudo">
                <h1 class="rdmls-sigla">RDMLS</h1>
                <h2 class="rdmls-sub">RADIO DIGITAL MUNICIPAL</h2>
                <div class="digital-clock" id="clock">00:00:00</div>
                
                <div style="display:flex; justify-content:center; margin-top:10px;">
                    <button onclick="toggleRadio()" style="width:60px; height:60px; border-radius:50%; border:none; background:white; color:var(--serena-red); font-size:24px; cursor:pointer; box-shadow: 0 0 15px rgba(255,255,255,0.2);"><i class="fas fa-play" id="play-icon"></i></button>
                </div>
            </div>
        </div>

        <div id="stage-area">
            <div id="map"></div>
            <img src="https://cdn-icons-png.flaticon.com/512/684/684908.png" class="center-pin">
            <canvas id="renderCanvas"></canvas>
            <div style="position:absolute; top:20px; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.7); color:gold; padding:5px 15px; border-radius:20px; font-size:12px; pointer-events:none; border:1px solid gold; z-index:20;">
                <i class="fas fa-crosshairs"></i> Apunta con Serenito
            </div>
            <button class="btn-tour" onclick="openTour()"><i class="fas fa-street-view"></i> PASEO HISTÓRICO</button>
        </div>

        <div id="sidebar-tools">
            <div class="route-box">
                <div style="font-size:11px; color:var(--serena-gold); margin-bottom:10px; font-weight:bold;">PLANIFICADOR DE VIAJES</div>
                
                <div class="search-row">
                    <input type="text" id="city-input" class="city-input" placeholder="¿A dónde vamos hoy?">
                    <button class="go-btn" onclick="buscarYCalcular()"><i class="fas fa-search"></i></button>
                </div>
                
                <div class="chip-scroll-container">
                    <div class="chip" onclick="calcDirect(-29.9538, -71.3380, 'Coquimbo Puerto')">Coquimbo</div>
                    <div class="chip" onclick="calcDirect(-30.0319, -70.7081, 'Vicuña')">Vicuña</div>
                    <div class="chip" onclick="calcDirect(-30.2292, -71.0851, 'Andacollo')">Andacollo</div>
                    <div class="chip" onclick="calcDirect(-30.2905, -71.4939, 'Tongoy')">Tongoy</div>
                    <div class="chip" onclick="calcDirect(-33.4489, -70.6693, 'Santiago')">Santiago</div>
                    <div class="chip" onclick="calcDirect(-12.0464, -77.0428, 'Lima')">Lima</div>
                    <div class="chip" onclick="calcDirect(-34.6037, -58.3816, 'Buenos Aires')">B. Aires</div>
                </div>

                <div class="route-list" id="route-output"></div>
                <button id="btn-reset-route" class="reset-route-btn" onclick="resetRoute()">CERRAR RUTA</button>
            </div>
            
            <div class="desktop-only-imgs">
                <img src="relleno-radio.jpg" class="graphic-filler" onclick="expandImg(this.src)" alt="Radio">
            </div>
        </div>

        <div id="form-panel">
            <div class="user-header" id="user-bar">
                <button onclick="login()" style="background:#4285F4; color:white; border:none; padding:10px; width:100%; border-radius:6px; cursor:pointer; font-weight:bold;"><i class="fab fa-google"></i> ACCESO VECINO</button>
            </div>

            <div id="step-1-location">
                <h4 style="margin:0 0 10px 0; color:var(--serena-gold);">CENTRAL DE REQUERIMIENTOS</h4>
                <div style="font-size:11px; color:#aaa; margin-bottom:5px;">Ubicación detectada (Mueve el mapa):</div>
                <input type="text" id="r-dir" class="f-input" style="color:var(--serena-gold); border-color:var(--serena-gold); font-weight:bold;" placeholder="Geolocalizando..." readonly>
            </div>

            <div id="step-2-details" style="margin-top:10px;">
                <input type="tel" id="r-phone" class="f-input" placeholder="Teléfono (+56 9...)" value="+56 9 ">
                <input type="text" id="r-asunto" class="f-input" placeholder="Asunto (Ej: Bache, Basura)">
                <textarea id="r-desc" class="f-input" rows="3" placeholder="Describe el problema..."></textarea>
                
                <div style="margin:10px 0;">
                    <label style="font-size:12px; color:#ccc; display:block; margin-bottom:5px;"><i class="fas fa-camera"></i> Adjuntar Evidencia (Foto/Video)</label>
                    <input type="file" id="evidencia-file" accept="image/*,video/*" style="font-size:12px; color:white; width:100%;">
                </div>
                
                <button onclick="enviarReporteFinal()" class="btn-red">ENVIAR A MUNICIPALIDAD</button>
            </div>

            <div id="hist-container" style="margin-top:20px; display:none;">
                <h5 style="color:var(--serena-gold); border-bottom:1px solid #333; padding-bottom:5px;">MIS REPORTES ANTERIORES</h5>
                <div id="hist-list"></div>
            </div>

            <img src="comic-patrimonio.jpg" class="graphic-filler" onclick="expandImg(this.src)">
            <img src="comic-aves.jpg" class="graphic-filler" onclick="expandImg(this.src)">
        </div>

        <div id="mobile-footer">
            <img src="escudo.png" style="width:60px; opacity:0.7;">
            <div style="font-family:'Oswald'; font-size:24px; color:#666;">RDMLS</div>
            <div style="font-size:10px; color:#444;">La Serena 2026 ©</div>
        </div>

    </div>

    <div id="modal-tour" class="modal">
        <button class="close-btn" onclick="document.getElementById('modal-tour').style.display='none'">VOLVER <i class="fas fa-times"></i></button>
        <canvas id="tour-canvas" style="width:100%; height:100%;"></canvas>
    </div>
    
    <div id="img-modal" onclick="closeImgModal(event)">
        <button class="close-btn" style="top:20px; right:20px;">&times;</button>
        <img id="img-full" src="" onclick="toggleZoom(event)">
        <div id="img-caption" style="color:gold; font-family:'Oswald'; margin-top:20px; background:rgba(0,0,0,0.8); padding:5px 10px; border-radius:5px;"></div>
    </div>
    
    <div id="success-modal" class="modal" style="background:rgba(0,0,0,0.85);">
        <div class="success-box">
            <i class="fas fa-check-circle" style="font-size:60px; color:#00e676; margin-bottom:20px;"></i>
            <h2 style="color:white; margin:0 0 10px 0;">¡ENVIADO!</h2>
            <p style="color:#ccc; font-size:14px;">Hemos recibido tu reporte correctamente.</p>
            <button onclick="document.getElementById('success-modal').style.display='none';" class="btn-green" style="margin-top:20px; width:100%;">ACEPTAR</button>
        </div>
    </div>

    <audio id="audio-player" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <button id="btn-chat-tramites" onclick="toggleChat()">
        <img src="https://cdn-icons-png.flaticon.com/512/3660/3660358.png" width="30">
        <span style="font-size:10px; margin-left:5px; font-weight:bold;">SERENITO ¡AHÍ!</span>
    </button>

    <div id="chat-window" style="display:none;">
        <div style="background:#b71c1c; padding:10px; color:white; font-family:'Oswald'; display:flex; justify-content:space-between; align-items:center;">
            <span>SERENITO IA</span>
            <button onclick="toggleChat()" style="background:none; border:none; color:white; cursor:pointer;">&times;</button>
        </div>
        <iframe src="ia.html" style="flex:1; border:none;"></iframe>
    </div>

    <script>
        // CONFIG
        const LS_COORDS = [-29.9027, -71.2520];
        const firebaseConfig = { apiKey: "AIzaSyCDUhik-oYwJ-yBkBYAohw6DJct5FQ78w4", authDomain: "laserena-d1263.firebaseapp.com", projectId: "laserena-d1263", storageBucket: "laserena-d1263.firebasestorage.app", messagingSenderId: "283725387947", appId: "1:283725387947:web:898aa22c80c2fadbe8bfee" };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(); const db = firebase.firestore();
        let user;

        // INIT
        function initApp() {
            crearFavicon();
            const r = document.getElementById('audio-player');
            r.play().catch(() => {
                const start = () => { r.play(); document.removeEventListener('click', start); document.removeEventListener('touchstart', start); };
                document.addEventListener('click', start); document.addEventListener('touchstart', start);
            });
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('es-CL'), 1000);
        }

        // MAPA
        const map = L.map('map', { zoomControl: false }).setView(LS_COORDS, 17);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        let routePolyline = null;

        // SERENITO (BABYLON)
        const canvas = document.getElementById("renderCanvas");
        const engine = new BABYLON.Engine(canvas, true);
        const scene = new BABYLON.Scene(engine); scene.clearColor = new BABYLON.Color4(0,0,0,0);
        const cam = new BABYLON.ArcRotateCamera("c", Math.PI/2, Math.PI/2.5, 100, BABYLON.Vector3.Zero(), scene);
        new BABYLON.HemisphericLight("l", new BABYLON.Vector3(0,1,0), scene).intensity = 1.3;
        BABYLON.SceneLoader.ImportMesh("", "./", "serenito.glb", scene, (m) => {
            let ser = m[0]; ser.scaling = new BABYLON.Vector3(12,12,-12); ser.position.y = 0; cam.lockedTarget = ser;
            scene.registerBeforeRender(() => { ser.rotation.y = Math.PI; });
        });
        engine.runRenderLoop(() => scene.render());

        // GEOREF
        map.on('moveend', async () => {
            const c = map.getCenter();
            const inp = document.getElementById('r-dir');
            if(document.activeElement === inp) return;
            try {
                inp.value = "Geolocalizando...";
                let r = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${c.lat}&lon=${c.lng}&zoom=18&addressdetails=1`);
                let d = await r.json();
                let a = d.address;
                let calle = a.road || a.pedestrian || "";
                let num = a.house_number ? `#${a.house_number}` : "(S/N)";
                if(calle) inp.value = `${calle} ${num}`;
                else inp.value = "Ubicación en mapa";
            } catch(e) { inp.value = "Ubicación seleccionada"; }
        });

        // RUTAS
        function calcDirect(lat, lon, name) {
            const R=6371; const dLat=(lat-LS_COORDS[0])*Math.PI/180; const dLon=(lon-LS_COORDS[1])*Math.PI/180;
            const a=Math.sin(dLat/2)**2 + Math.cos(LS_COORDS[0]*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1.35;
            
            const tAuto=(dist/60).toFixed(1);
            const tBus=(dist/40).toFixed(1);
            const tBici=(dist/15).toFixed(1);
            const tPie=(dist/5).toFixed(1);
            const tAvion=(dist/800).toFixed(1); // AVIÓN AGREGADO

            document.getElementById('route-output').innerHTML = `
                <div style="text-align:center; color:white; font-weight:bold; margin-bottom:5px;">Hacia: ${name} (${dist.toFixed(0)} km)</div>
                <div class="trans-row"><i class="fas fa-car trans-icon"></i> Auto: ${tAuto} h</div>
                <div class="trans-row"><i class="fas fa-bus trans-icon"></i> Bus: ${tBus} h</div>
                <div class="trans-row"><i class="fas fa-bicycle trans-icon"></i> Bici: ${tBici} h</div>
                <div class="trans-row"><i class="fas fa-walking trans-icon"></i> A Pie: ${tPie} h</div>
                <div class="trans-row"><i class="fas fa-plane trans-icon"></i> Avión: ${tAvion} h</div>
            `;
            document.getElementById('btn-reset-route').style.display='block';
            if(routePolyline) map.removeLayer(routePolyline);
            routePolyline = L.polyline([LS_COORDS, [lat,lon]], {color:'#b71c1c', weight:4, dashArray:'10,10'}).addTo(map);
            map.fitBounds(routePolyline.getBounds(), {padding:[50,50]});
        }
        function resetRoute(){ if(routePolyline)map.removeLayer(routePolyline); document.getElementById('btn-reset-route').style.display='none'; map.flyTo(LS_COORDS, 17); document.getElementById('route-output').innerHTML=""; }
        function buscarYCalcular(){
            const q = document.getElementById('city-input').value; if(!q)return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`)
                .then(r=>r.json()).then(d=>{ if(d.length) calcDirect(parseFloat(d[0].lat), parseFloat(d[0].lon), d[0].display_name.split(',')[0]); });
        }

        // COMPRESIÓN DE IMAGEN (SOLUCIÓN ERROR MÓVIL)
        function compressImage(file, quality=0.7, maxWidth=1024) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = event => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        let width = img.width; let height = img.height;
                        if (width > maxWidth) { height *= maxWidth / width; width = maxWidth; }
                        canvas.width = width; canvas.height = height;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, width, height);
                        resolve(canvas.toDataURL('image/jpeg', quality));
                    };
                };
                reader.onerror = error => reject(error);
            });
        }

        // LOGIN & CRM
        function login() { auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()); }
        auth.onAuthStateChanged(u => {
            if(u) {
                user = u;
                document.getElementById('user-bar').innerHTML = `<img src="${u.photoURL}" class="avatar"> <div style="font-size:12px; margin-left:10px;"><b>${u.displayName}</b></div>`;
                document.getElementById('hist-container').style.display = 'block';
                cargarHistorial(u.uid);
            }
        });

        function cargarHistorial(uid) {
            db.collection("incidencias").where("uid", "==", uid).onSnapshot(snap => {
                const list = document.getElementById('hist-list'); list.innerHTML = "";
                const tickets = []; snap.forEach(doc => tickets.push(doc.data()));
                // Ordenar en cliente
                tickets.sort((a,b) => b.fecha.seconds - a.fecha.seconds);
                
                tickets.forEach(d => {
                    const imgHTML = d.foto_evidencia ? `<img src="${d.foto_evidencia}" class="ticket-img-thumb" onclick="expandImg('${d.foto_evidencia}')">` : "";
                    const fecha = new Date(d.fecha.seconds*1000).toLocaleDateString();
                    list.innerHTML += `<div class="ticket-card">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px; color:#888;">
                            <span>${fecha}</span> <span class="status-pill">${d.estado || 'Recibido'}</span>
                        </div>
                        <b style="color:white;">${d.asunto || 'Sin Asunto'}</b>
                        <div style="color:#ccc; margin-top:5px;">${d.descripcion}</div>
                        <div style="font-size:10px; color:#aaa; margin-top:5px;"><i class="fas fa-map-marker-alt"></i> ${d.direccion}</div>
                        ${imgHTML}
                    </div>`;
                });
            });
        }

        async function enviarReporteFinal() {
            if(!user) { alert("Debes iniciar sesión."); return; }
            const btn = document.querySelector('.btn-red'); btn.disabled = true; btn.innerText = "Enviando...";
            
            try {
                const file = document.getElementById('evidencia-file').files[0];
                let base64 = null;
                if(file) base64 = await compressImage(file);

                await db.collection("incidencias").add({
                    uid: user.uid, user: user.displayName, email: user.email,
                    phone: document.getElementById('r-phone').value,
                    direccion: document.getElementById('r-dir').value,
                    asunto: document.getElementById('r-asunto').value,
                    descripcion: document.getElementById('r-desc').value,
                    foto_evidencia: base64,
                    fecha: new Date(), estado: "Ingresado"
                });
                
                document.getElementById('success-modal').style.display = 'flex';
                document.getElementById('r-desc').value = ""; document.getElementById('evidencia-file').value = "";
            } catch(e) { alert("Error al enviar. Intenta de nuevo."); }
            btn.disabled = false; btn.innerText = "ENVIAR A MUNICIPALIDAD";
        }

        // LUPA & ZOOM
        window.expandImg = function(src, caption="") {
            const img = document.getElementById('img-full');
            img.src = src; img.classList.remove('zoomed');
            document.getElementById('img-caption').innerText = caption;
            document.getElementById('img-modal').style.display = 'flex';
        }
        function toggleZoom(e) { e.stopPropagation(); e.target.classList.toggle('zoomed'); }
        function closeImgModal(e) { if(e.target.tagName !== 'IMG') document.getElementById('img-modal').style.display = 'none'; }

        // PASEO
        function openTour() {
            document.getElementById('modal-tour').style.display = 'block';
            // Lógica tour existente... (se mantiene igual que antes)
        }

        function toggleRadio() { const p=document.getElementById('audio-player'); const i=document.getElementById('play-icon'); if(p.paused){p.play();i.className="fas fa-pause";}else{p.pause();i.className="fas fa-play";} }
        function toggleChat() { const w=document.getElementById('chat-window'); w.style.display=(w.style.display==='none'?'flex':'none'); }
        function crearFavicon() {
            const c=document.createElement('canvas'); c.width=64; c.height=64; const x=c.getContext('2d');
            x.fillStyle='#b71c1c'; x.fillRect(0,0,64,64); x.fillStyle='white'; x.font='bold 20px Oswald'; x.textAlign='center'; x.fillText('RDMLS',32,40);
            document.getElementById('dynamic-favicon').href=c.toDataURL('image/png');
        }
        window.addEventListener("resize", () => { engine.resize(); map.invalidateSize(); });
    </script>
</body>
</html>
