<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vecinos La Serena</title>
    <style>
        /* ESTILOS BASE */
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f4f6f8; 
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* TARJETA DE LOGIN (Central y limpia) */
        .login-card {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.08);
            width: 100%;
            max-width: 380px;
            text-align: center;
            transition: all 0.3s ease;
        }

        h2 { color: #333; margin-bottom: 5px; font-size: 24px; }
        p.subtitle { color: #888; margin-top: 0; margin-bottom: 30px; font-size: 14px; }

        /* INPUTS Y BOTONES */
        input {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-sizing: border-box; /* Importante para padding */
            font-size: 16px;
        }

        button {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .btn-primary { background-color: #007bff; color: white; }
        .btn-primary:hover { background-color: #0056b3; }

        .btn-success { background-color: #28a745; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }

        /* ENLACE "PIOLA" PARA FUNCIONARIOS */
        .staff-toggle-link {
            display: block;
            margin-top: 25px;
            font-size: 13px;
            color: #aaa;
            text-decoration: none;
            cursor: pointer;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .staff-toggle-link:hover { color: #007bff; }

        /* UTILIDADES DE VISUALIZACIN */
        .hidden { display: none !important; }
        
        /* ESTILOS INTERNOS (DASHBOARD, ETC) */
        #app-container { width: 100%; max-width: 500px; display: none; padding: 20px; }
        .card-item { background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 5px solid #ccc; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .status-pill { float: right; padding: 2px 8px; border-radius: 12px; font-size: 12px; }
        
        /* CMARA FULL SCREEN */
        #camera-view {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: black; z-index: 1000; display: none;
            flex-direction: column; align-items: center; justify-content: center;
        }
        video { width: 100%; height: 100%; object-fit: cover; }
        #serenito-overlay { position: absolute; bottom: 0; right: 0; width: 150px; pointer-events: none; }
        .cam-controls { position: absolute; bottom: 30px; z-index: 1001; display: flex; gap: 20px; }
        .btn-circle { width: 60px; height: 60px; border-radius: 50%; border: 4px solid white; background: rgba(255,255,255,0.2); cursor: pointer; }
    </style>
</head>
<body>

    <div class="login-card" id="login-view">
        <h2 id="login-title">Vecinos La Serena</h2>
        <p class="subtitle" id="login-subtitle">Plataforma de Gesti贸n</p>

        <div id="form-vecino">
            <input type="text" id="rutUser" placeholder="Ingresa tu RUT (ej: 11111111-1)">
            <button class="btn-primary" onclick="ingresarVecino()">Ingresar</button>
            <p style="font-size: 11px; color: #ccc; margin-top: 10px;">* Prueba 11111111-1 para ver usuario BLOQUEADO</p>
        </div>

        <div id="form-staff" class="hidden">
            <input type="text" id="staffUser" placeholder="Usuario Funcionario">
            <input type="password" id="staffPass" placeholder="Contrase帽a">
            <button class="btn-success" onclick="ingresarStaff()">Acceder al Sistema</button>
            <button style="background:none; color:#888; font-weight:normal; font-size:13px; margin-top:10px; width:auto;" onclick="toggleLoginMode(false)">Cancelar / Volver</button>
        </div>

        <a class="staff-toggle-link" id="link-staff" onclick="toggleLoginMode(true)">
            Gesti贸n Municipal
        </a>
    </div>

    <div id="app-container">
        
        <div id="view-dashboard" class="hidden">
            <h2>Hola, <span id="dash-name"></span></h2>
            <button style="background:#ff9800; color:white; margin-bottom:20px;" onclick="abrirCamara()"> Selfie con Serenito</button>
            
            <h3>Mis Requerimientos</h3>
            <div id="list-active-reqs"></div>
            
            <button class="btn-danger" style="margin-top:30px;" onclick="logout()">Cerrar Sesi贸n</button>
        </div>

        <div id="view-blocked" class="hidden">
            <div style="background:#fff3cd; color:#856404; padding:15px; border-radius:8px; margin-bottom:20px; border:1px solid #ffeeba;">
                <strong>锔 Cuenta Restringida</strong><br>
                <small>Estimado <span id="block-name"></span>, no puede ingresar nuevas solicitudes, pero aqu铆 est谩 su historial.</small>
            </div>

            <h3>Historial de Solicitudes</h3>
            <div id="list-history-reqs"></div>

            <button class="btn-danger" style="margin-top:20px;" onclick="logout()">Salir</button>
        </div>

        <div id="view-staff" class="hidden">
            <h2 style="color:#2c3e50;">Panel de Gesti贸n</h2>
            <p>Administraci贸n de Requerimientos</p>
            
            <div id="staff-list" style="margin-top:20px;">
                <div class="card-item" style="border-left-color: green;">
                    <strong>Rodrigo Godoy (Bloqueado)</strong><br>
                    <small>Luminaria - Pendiente revisi贸n</small>
                    <button style="font-size:11px; width:auto; padding:5px; margin-top:5px; float:right;">Responder</button>
                    <div style="clear:both;"></div>
                </div>
            </div>

            <button class="btn-danger" style="margin-top:30px;" onclick="logout()">Cerrar Sistema</button>
        </div>
    </div>

    <div id="camera-view">
        <video id="videoElement" autoplay playsinline></video>
        <img src="serenito.png" id="serenito-overlay" alt="Serenito">
        
        <div class="cam-controls">
            <button style="background:red; width:50px; height:50px; border-radius:50%; color:white; border:none;" onclick="cerrarCamara()">X</button>
            <div class="btn-circle" onclick="tomarFoto()"></div>
        </div>
        <canvas id="canvasFoto" style="display:none;"></canvas>
    </div>

    <script>
        // --- BASE DE DATOS LOCAL (SIMULADA) ---
        const DB = {
            users: [
                { rut: "11111111-1", name: "Rodrigo Godoy", blocked: true, history: [
                    { type: "Luminaria", date: "20-02-2026", status: "Resuelto" },
                    { type: "Aseo", date: "22-02-2026", status: "Pendiente" }
                ]},
                { rut: "22222222-2", name: "Juan P茅rez", blocked: false, history: [] }
            ],
            staff: [
                { user: "admin", pass: "1234" }
            ]
        };

        let currentUser = null;
        let stream = null;

        // --- LGICA DE INTERFAZ (TOGGLE PIOLA) ---
        
        function toggleLoginMode(isStaffMode) {
            const formVecino = document.getElementById('form-vecino');
            const formStaff = document.getElementById('form-staff');
            const link = document.getElementById('link-staff');
            const title = document.getElementById('login-title');

            if (isStaffMode) {
                // Modo Funcionario
                formVecino.classList.add('hidden');
                link.classList.add('hidden'); // Ocultamos el link gatillador
                formStaff.classList.remove('hidden');
                title.innerText = "Acceso Funcionarios";
            } else {
                // Modo Vecino (Normal)
                formStaff.classList.add('hidden');
                formVecino.classList.remove('hidden');
                link.classList.remove('hidden'); // Vuelve el link gatillador
                title.innerText = "Vecinos La Serena";
            }
        }

        function switchView(viewId) {
            // Ocultar login y app container
            document.getElementById('login-view').classList.add('hidden');
            document.getElementById('app-container').style.display = 'block'; // Mostrar contenedor general
            
            // Ocultar vistas internas
            document.getElementById('view-dashboard').classList.add('hidden');
            document.getElementById('view-blocked').classList.add('hidden');
            document.getElementById('view-staff').classList.add('hidden');
            
            // Mostrar la deseada
            document.getElementById(viewId).classList.remove('hidden');
        }

        // --- LOGIN LOGIC ---

        function ingresarVecino() {
            const rut = document.getElementById('rutUser').value;
            const user = DB.users.find(u => u.rut === rut);

            if (user) {
                currentUser = user;
                if (user.blocked) {
                    document.getElementById('block-name').innerText = user.name;
                    renderHistory('list-history-reqs');
                    switchView('view-blocked');
                } else {
                    document.getElementById('dash-name').innerText = user.name;
                    renderHistory('list-active-reqs');
                    switchView('view-dashboard');
                }
            } else {
                alert("Usuario no encontrado (Prueba 11111111-1)");
            }
        }

        function ingresarStaff() {
            const u = document.getElementById('staffUser').value;
            const p = document.getElementById('staffPass').value;
            const staff = DB.staff.find(s => s.user === u && s.pass === p);

            if (staff) {
                switchView('view-staff');
            } else {
                alert("Error de credenciales (Prueba: admin / 1234)");
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('app-container').style.display = 'none';
            document.getElementById('login-view').classList.remove('hidden');
            
            // Limpiar campos
            document.getElementById('rutUser').value = '';
            document.getElementById('staffUser').value = '';
            document.getElementById('staffPass').value = '';
            
            // Volver al modo vecino por defecto
            toggleLoginMode(false);
        }

        // --- RENDERIZADO DE HISTORIAL ---
        function renderHistory(elementId) {
            const container = document.getElementById(elementId);
            container.innerHTML = '';
            const history = currentUser.history || [];

            if (history.length === 0) {
                container.innerHTML = '<p style="color:#999; text-align:center;">Sin historial.</p>';
                return;
            }

            history.forEach(item => {
                let color = item.status === 'Resuelto' ? '#d4edda' : '#fff3cd';
                container.innerHTML += `
                    <div class="card-item" style="border-left-color: ${item.status === 'Resuelto' ? 'green' : 'orange'};">
                        <strong>${item.type}</strong>
                        <span class="status-pill" style="background:${color}">${item.status}</span>
                        <br><small style="color:#666">${item.date}</small>
                    </div>
                `;
            });
        }

        // --- CMARA & SELFIE ---
        async function abrirCamara() {
            document.getElementById('camera-view').style.display = 'flex';
            const video = document.getElementById('videoElement');
            try {
                stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                video.srcObject = stream;
            } catch (e) {
                alert("Error c谩mara: " + e);
                cerrarCamara();
            }
        }

        function cerrarCamara() {
            if (stream) stream.getTracks().forEach(t => t.stop());
            document.getElementById('camera-view').style.display = 'none';
        }

        function tomarFoto() {
            const video = document.getElementById('videoElement');
            const canvas = document.getElementById('canvasFoto');
            const img = document.getElementById('serenito-overlay');
            const ctx = canvas.getContext('2d');

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;

            // Foto
            ctx.drawImage(video, 0, 0);
            
            // Overlay
            const sW = canvas.width * 0.4; // 40% del ancho
            const sH = (img.naturalHeight / img.naturalWidth) * sW;
            ctx.drawImage(img, canvas.width - sW - 20, canvas.height - sH - 20, sW, sH);

            alert("隆Foto Guardada! (Simulaci贸n)");
            cerrarCamara();
        }

    </script>
</body>
</html>
