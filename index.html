<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDMLS | Radio Digital Municipal La Serena</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --serena-red: #b71c1c; --serena-gold: #ffd700; --dark: #0f0f0f; --panel: #111; }
        
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--dark); color: white; width: 100%; height: 100%; overflow: hidden; }

        /* --- LAYOUT ESCRITORIO FANT√ÅSTICO --- */
        #main-layout {
            display: grid; width: 100vw; height: 100vh;
            grid-template-columns: 360px 1fr 360px;
            grid-template-rows: 100%;
        }

        /* SIDEBAR IZQUIERDO (ROJO) */
        #sidebar-wrapper {
            background: linear-gradient(180deg, #b71c1c 0%, #5f0000 100%);
            padding: 20px; overflow-y: auto; z-index: 50;
            box-shadow: 4px 0 20px rgba(0,0,0,0.6);
        }

        /* √ÅREA CENTRAL (MAPA) */
        #stage-area { height: 100%; position: relative; border-left: 2px solid var(--serena-gold); border-right: 2px solid var(--serena-gold); }

        /* PANEL DERECHO (NEGRO) */
        #form-panel { background: var(--panel); padding: 20px; overflow-y: auto; }

        .rdmls-sigla { font-family: 'Oswald'; font-size: 42px; margin: 5px 0; text-align: center; text-shadow: 2px 2px 0 #000; color: white; }
        .clock { font-family: 'Oswald'; font-size: 26px; color: var(--serena-gold); text-align: center; margin-bottom: 20px; }
        
        /* RADIO CONTROLES */
        .radio-card { background: rgba(0,0,0,0.4); padding: 15px; border-radius: 12px; text-align: center; border: 1px solid var(--serena-gold); margin-bottom: 20px; }
        .btn-play { background: white; color: var(--serena-red); border: none; width: 60px; height: 60px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; margin: 0 auto; font-size: 24px; box-shadow: 0 0 15px rgba(255,255,255,0.3); }
        .vol-label { font-size: 10px; color: var(--serena-gold); font-weight: bold; margin-top: 10px; display: block; }
        .vol-slider { width: 100%; accent-color: var(--serena-gold); cursor: pointer; }

        /* PLANIFICADOR Y TABLA DE RESULTADOS */
        .route-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-left: 4px solid var(--serena-gold); }
        .search-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .city-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; font-size: 14px; }
        .go-btn { background: var(--serena-gold); color: black; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .route-header { color: var(--serena-gold); font-weight: bold; font-size: 14px; text-align: center; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 5px; }
        .trans-row { display: flex; justify-content: space-between; align-items: center; padding: 8px; background: rgba(0,0,0,0.5); border-radius: 6px; font-size: 12px; margin-bottom: 4px; }
        .trans-icon { width: 20px; text-align: center; color: var(--serena-gold); margin-right: 10px; }

        /* BOTONES AMARILLOS */
        .btn-yellow { background: var(--serena-gold); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; border: 2px solid white; cursor: pointer; font-size: 13px; display: flex; align-items: center; gap: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.5); }
        .btn-tour { position: absolute; bottom: 20px; left: 20px; z-index: 20; }
        .btn-selfie { position: absolute; top: 20px; right: 20px; z-index: 20; }

        /* CABINA FOTOGR√ÅFICA */
        #modal-camara { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 30000; align-items: center; justify-content: center; flex-direction: column; }
        #camera-wrapper { position: relative; width: 400px; height: 500px; border: 3px solid var(--serena-gold); overflow: hidden; background: #000; background-size: cover; background-position: center; }
        #cam-video { width: 100%; height: 100%; object-fit: cover; transform: scaleX(-1); }
        #serenito-selfie { position: absolute; cursor: move; z-index: 10; filter: drop-shadow(0 0 10px black); transition: transform 0.1s ease; }
        
        .cabina-tools { width: 400px; background: #222; padding: 15px; border: 1px solid #444; border-radius: 0 0 10px 10px; }
        .tool-row { margin-bottom: 10px; font-size: 11px; color: gold; font-weight: bold; }
        .tool-row input, .tool-row select { width: 100%; accent-color: gold; cursor: pointer; }

        /* PASEO 3D */
        #modal-3d { display: none; position: fixed; inset: 0; background: black; z-index: 20000; }
        #canvas3d { width: 100%; height: 100%; }

        #map { width: 100%; height: 100%; z-index: 1; }
    </style>
</head>
<body onload="initApp()">

    <div id="main-layout">
        <div id="sidebar-wrapper">
            <div id="sidebar-header">
                <img src="escudo.png" class="escudo-img" onerror="this.src='https://upload.wikimedia.org/wikipedia/commons/thumb/1/1c/Escudo_de_La_Serena.svg/1200px-Escudo_de_La_Serena.svg.png'">
                <h1 class="rdmls-sigla">RDMLS</h1>
                <div class="clock" id="clock">00:00:00</div>
            </div>

            <div class="radio-card">
                <button onclick="toggleRadio()" class="btn-play">
                    <i class="fas fa-play" id="play-icon"></i>
                </button>
                <span class="vol-label">VOLUMEN</span>
                <input type="range" class="vol-slider" min="0" max="1" step="0.1" value="0.5" oninput="setVolume(this.value)">
            </div>

            <div class="route-box">
                <div style="font-size:11px; color:var(--serena-gold); font-weight:bold; margin-bottom:10px;">PLANIFICADOR DE TRAYECTOS</div>
                <div class="search-row">
                    <input type="text" id="city-input" class="city-input" placeholder="¬øHacia d√≥nde?">
                    <button class="go-btn" onclick="buscarYCalcular()"><i class="fas fa-search"></i></button>
                </div>
                <div id="route-output"></div>
            </div>
        </div>

        <div id="stage-area">
            <div id="map"></div>
            <button class="btn-yellow btn-tour" onclick="abrirPaseo3D()"><i class="fas fa-street-view"></i> PASEO 3D HIST√ìRICO</button>
            <button class="btn-yellow btn-selfie" onclick="abrirCabina()"><i class="fas fa-camera"></i> CABINA SELFIE SERENITO</button>
        </div>

        <div id="form-panel">
            <h4 style="color:var(--serena-gold); border-bottom: 1px solid #333; padding-bottom: 10px;">GESTI√ìN RDMLS</h4>
            <div id="crm-status" style="font-size: 12px; color: #666;">Conectando con base de datos municipal...</div>
            <div id="history-list" style="margin-top: 20px;"></div>
        </div>
    </div>

    <div id="modal-camara">
        <div id="camera-wrapper">
            <video id="cam-video" autoplay playsinline></video>
            <img id="serenito-selfie" src="serenito.png" style="width:150px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3660/3660358.png'"> 
        </div>
        <div class="cabina-tools">
            <div class="tool-row">TAMA√ëO (ZOOM)
                <input type="range" min="50" max="400" value="150" oninput="ajustarSerenito('width', this.value + 'px')">
            </div>
            <div class="tool-row">√ÅNGULO (ROTACI√ìN)
                <input type="range" min="-180" max="180" value="0" oninput="ajustarSerenito('transform', 'rotate('+this.value+'deg)')">
            </div>
            <div class="tool-row">FONDOS CIUDAD
                <select onchange="cambiarFondoCabina(this.value)">
                    <option value="none">C√°mara Real</option>
                    <option value="faro.jpg">Faro Monumental</option>
                    <option value="plaza.jpg">Plaza de Armas</option>
                    <option value="recova.jpg">La Recova</option>
                </select>
            </div>
            <button onclick="tomarFoto()" style="width:100%; background:gold; color:black; border:none; padding:12px; border-radius:5px; font-weight:bold; cursor:pointer;">CAPTURAR FOTO</button>
            <button onclick="cerrarCabina()" style="width:100%; background:none; border:none; color:white; margin-top:10px; cursor:pointer; font-size:12px;">Cerrar</button>
        </div>
    </div>

    <div id="modal-3d">
        <button style="position:absolute; top:20px; right:20px; z-index:100; background:red; color:white; border:none; padding:10px 20px; border-radius:30px; cursor:pointer;" onclick="cerrarPaseo3D()">SALIR</button>
        <div style="position:absolute; bottom:20px; left:20px; z-index:100; background:rgba(0,0,0,0.8); color:lime; padding:10px; font-family:monospace; font-size:12px; border:1px solid #333;">
            MOTOR TANQUE V.2.1 | WASD: MOVER | MOUSE: MIRAR
        </div>
        <canvas id="canvas3d"></canvas>
    </div>

    <audio id="radio" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <script>
        let map, routePolyline, videoStream, engine3d, scene3d;
        const LS = [-29.9027, -71.2520];
        const radio = document.getElementById('radio');

        function initApp() {
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'), 1000);
            map = L.map('map', {zoomControl:false}).setView(LS, 16);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
            L.marker(LS).addTo(map).bindPopup("<b>RDMLS La Serena</b>");
            dragElement(document.getElementById("serenito-selfie"));
        }

        // --- RADIO ---
        function toggleRadio() {
            const icon = document.getElementById('play-icon');
            if (radio.paused) { radio.play(); icon.className = "fas fa-pause"; } 
            else { radio.pause(); icon.className = "fas fa-play"; }
        }
        function setVolume(v) { radio.volume = v; }

        // --- TRAYECTOS (RECUPERADOS) ---
        function buscarYCalcular() {
            const q = document.getElementById('city-input').value;
            if(!q) return;
            fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${q}&limit=1`)
                .then(r => r.json()).then(data => {
                    if(data.length) {
                        const dest = [parseFloat(data[0].lat), parseFloat(data[0].lon)];
                        mostrarResultados(dest, data[0].display_name.split(',')[0]);
                    }
                });
        }

        function mostrarResultados(dest, nombre) {
            if(routePolyline) map.removeLayer(routePolyline);
            routePolyline = L.polyline([LS, dest], {color: 'red', weight: 4, dashArray: '10, 15'}).addTo(map);
            map.fitBounds(routePolyline.getBounds(), {padding: [50, 50]});

            const R = 6371;
            const dLat = (dest[0]-LS[0])*Math.PI/180; const dLon = (dest[1]-LS[1])*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(LS[0]*Math.PI/180)*Math.cos(dest[0]*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1.3;

            document.getElementById('route-output').innerHTML = `
                <div class="route-header">Ruta a ${nombre} (${dist.toFixed(0)} km)</div>
                <div class="trans-row"><i class="fas fa-plane trans-icon"></i> Avi√≥n <span>${(dist/800).toFixed(2)} h</span></div>
                <div class="trans-row"><i class="fas fa-bus trans-icon"></i> Bus Municipal <span>${(dist/60).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-car trans-icon"></i> Autom√≥vil <span>${(dist/80).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-bicycle trans-icon"></i> Bicicleta <span>${(dist/16).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-walking trans-icon"></i> Caminando <span>${(dist/5).toFixed(1)} h</span></div>
            `;
        }

        // --- CABINA SELFIE ---
        async function abrirCabina() {
            document.getElementById('modal-camara').style.display = 'flex';
            videoStream = await navigator.mediaDevices.getUserMedia({video: true});
            document.getElementById('cam-video').srcObject = videoStream;
        }

        function ajustarSerenito(prop, val) { document.getElementById('serenito-selfie').style[prop] = val; }

        function cambiarFondoCabina(img) {
            const wrap = document.getElementById('camera-wrapper');
            const video = document.getElementById('cam-video');
            if(img === 'none') { wrap.style.backgroundImage = 'none'; video.style.opacity = '1'; }
            else { wrap.style.backgroundImage = `url('${img}')`; video.style.opacity = '0.5'; }
        }

        function cerrarCabina() {
            document.getElementById('modal-camara').style.display = 'none';
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        }

        function tomarFoto() { alert("üåü ¬°RECIBIDO Y GRACIAS! Captura RDMLS guardada."); cerrarCabina(); }

        // --- PASEO 3D (MOTOR TANQUE) ---
        function abrirPaseo3D() {
            document.getElementById('modal-3d').style.display = 'block';
            const canvas = document.getElementById('canvas3d');
            if(!engine3d) {
                engine3d = new BABYLON.Engine(canvas, true);
                scene3d = new BABYLON.Scene(engine3d);
                scene3d.clearColor = new BABYLON.Color3(0.5, 0.7, 1);
                const cam = new BABYLON.FreeCamera("tankCam", new BABYLON.Vector3(0, 5, -50), scene3d);
                cam.attachControl(canvas, true); cam.keysUp = [87]; cam.keysDown = [83]; cam.keysLeft = [65]; cam.keysRight = [68]; cam.speed = 1.5;
                new BABYLON.HemisphericLight("sun", new BABYLON.Vector3(0, 1, 0), scene3d);
                BABYLON.MeshBuilder.CreateGround("ground", {width:1000, height:1000}, scene3d);
                BABYLON.MeshBuilder.CreateBox("muni", {width:30, height:20, depth:50}, scene3d).position = new BABYLON.Vector3(40, 10, 0);
            }
            engine3d.runRenderLoop(() => scene3d.render());
        }

        function cerrarPaseo3D() { document.getElementById('modal-3d').style.display = 'none'; engine3d.stopRenderLoop(); }

        function dragElement(elmnt) {
            let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
            elmnt.onmousedown = dragMouseDown;
            function dragMouseDown(e) { e.preventDefault(); pos3 = e.clientX; pos4 = e.clientY; document.onmouseup = closeDragElement; document.onmousemove = elementDrag; }
            function elementDrag(e) { e.preventDefault(); pos1 = pos3 - e.clientX; pos2 = pos4 - e.clientY; pos3 = e.clientX; pos4 = e.clientY; elmnt.style.top = (elmnt.offsetTop - pos2) + "px"; elmnt.style.left = (elmnt.offsetLeft - pos1) + "px"; }
            function closeDragElement() { document.onmouseup = null; document.onmousemove = null; }
        }
    </script>
</body>
</html>
