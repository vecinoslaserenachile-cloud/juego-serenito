<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Radio Digital Municipal La Serena - Vecinos RDMLS</title>
    <style>
        /* CSS DEL SITIO MARAVILLOSO RECAPITULADO */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; }
        #contenedor-principal { max-width: 1200px; margin: 0 auto; background: white; min-height: 100vh; }
        
        /* LOGIN DISCRETO */
        .login-box { padding: 40px; text-align: center; max-width: 400px; margin: 0 auto; }
        .staff-access-piola { margin-top: 50px; font-size: 11px; color: #ccc; border-top: 1px solid #eee; padding-top: 15px; }
        .staff-access-piola a { color: #bbb; text-decoration: none; cursor: pointer; }

        /* PASEO 3D Y MOTOR TIPO TANQUE */
        #motor-3d { width: 100%; height: 500px; background: #000; position: relative; }
        .edificio { position: absolute; background: #888; border: 1px solid #555; }
        
        /* CUADRO DE DISTANCIAS Y MAPA */
        #cuadro-distancias { background: white; border: 2px solid #007bff; padding: 15px; border-radius: 10px; }
        .btn-pastilla { display: inline-block; padding: 8px 15px; margin: 5px; background: #e1f5fe; border-radius: 20px; cursor: pointer; }

        /* CMARA Y SELFIE */
        #camara-full { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:black; z-index:1000; }
        #video-preview { width: 100%; height: 100%; object-fit: cover; }
        #serenito-sticker { position: absolute; bottom: 20px; right: 20px; width: 180px; pointer-events: none; }
    </style>
</head>
<body>

<div id="contenedor-principal">
    <div id="pantalla-login" class="login-box">
        <h2>Vecinos La Serena</h2>
        <input type="text" id="rutInput" placeholder="RUT (11111111-1)">
        <button onclick="validarIngreso()" style="background:#007bff; color:white; width:100%; padding:10px;">Ingresar</button>
        
        <div class="staff-access-piola">
            <a onclick="abrirAccesoStaff()">Gesti贸n Municipal</a>
            <div id="form-staff-oculto" style="display:none; margin-top:10px;">
                <input type="text" id="userStaff" placeholder="Usuario" style="width:80px;">
                <input type="password" id="passStaff" placeholder="Clave" style="width:80px;">
                <button onclick="loginFuncionario()">Entrar</button>
            </div>
        </div>
    </div>

    <div id="pantalla-app" style="display:none;">
        <header style="background:#007bff; color:white; padding:10px; display:flex; justify-content:space-between;">
            <span>Radio Digital Municipal (RDMLS)</span>
            <button onclick="salir()" style="background:red; color:white;">Salir</button>
        </header>

        <div id="aviso-bloqueo" style="display:none; background:#fff3cd; padding:15px; color:#856404; text-align:center;">
            <strong>CUENTA RESTRINGIDA:</strong> Solo puedes consultar el historial y el Paseo 3D.
        </div>

        <section id="paseo-historico">
            <h3>Paseo 3D Hist贸rico</h3>
            <div id="motor-3d">
                <div class="edificio" style="width:50px; height:100px; left:200px; bottom:0;"></div>
            </div>
        </section>

        <section id="cuadro-distancias">
            <h3>Distancias desde La Serena</h3>
            <div id="botones-ciudades">
                <div class="btn-pastilla" onclick="verDistancia('Vicu帽a')">Vicu帽a</div>
                <div class="btn-pastilla" onclick="verDistancia('Andacollo')">Andacollo</div>
                <div class="btn-pastilla" onclick="verDistancia('Punta de Choros')">Punta de Choros</div>
                <div class="btn-pastilla" onclick="verDistancia('Ovalle')">Ovalle</div>
                <div class="btn-pastilla" onclick="verDistancia('Coquimbo')">Coquimbo</div>
            </div>
            <div id="resultado-distancia" style="margin-top:10px; font-weight:bold;"></div>
            <button onclick="cerrarCuadro()" style="display:none;" id="btn-cerrar-dist">Cerrar Resultados</button> </section>

        <button onclick="activarCamara()" style="width:100%; padding:20px; background:orange; font-weight:bold;"> SELFIE CON SERENITO</button>
        
        <section id="seccion-historial">
            <h3>Historial de Requerimientos</h3>
            <div id="lista-historial"></div>
        </section>

        <footer id="footer-stats" style="margin-top:20px; border-top:1px solid #ccc;">
            <div id="clima">Cargando tiempo La Serena...</div>
            <div id="chat-status">Chat: Conectado</div>
        </footer >
    </div>

    <div id="pantalla-gestion" style="display:none; padding:20px;">
        <h2>Panel de Gesti贸n - Vecinos La Serena spa</h2>
        <div id="requerimientos-pendientes">
            </div>
    </div>
</div>

<div id="camara-full">
    <video id="video-preview" autoplay playsinline></video>
    <img src="serenito.png" id="serenito-sticker" alt="Serenito">
    <div style="position:absolute; bottom:30px; width:100%; text-align:center;">
        <button onclick="capturarFoto()" style="width:70px; height:70px; border-radius:50%; border:5px solid white;"></button>
        <button onclick="cerrarCamara()" style="background:red; color:white; margin-left:20px;">X</button>
    </div>
</div>

<script>
    // ESTADO DEL USUARIO
    const usuarioSimulado = {
        rut: "11111111-1",
        nombre: "Rodrigo Godoy",
        bloqueado: true, // Prueba para ver historial bloqueado
        historial: [
            { id: 501, tipo: "Luminaria", status: "Recibido" }
        ]
    };

    function validarIngreso() {
        const input = document.getElementById('rutInput').value;
        if(input === usuarioSimulado.rut) {
            document.getElementById('pantalla-login').style.display = 'none';
            document.getElementById('pantalla-app').style.display = 'block';
            
            // PARCHE 2: SI EST BLOQUEADO, MOSTRAR AVISO PERO NO CERRAR LA APP
            if(usuarioSimulado.bloqueado) {
                document.getElementById('aviso-bloqueo').style.display = 'block';
                // Deshabilitar funciones de env铆o de reporte
            }
            cargarHistorial();
        }
    }

    // ACCESO PIOLA FUNCIONARIO
    function abrirAccesoStaff() {
        document.getElementById('form-staff-oculto').style.display = 'block';
    }

    function loginFuncionario() {
        // L贸gica de acceso directo a gesti贸n
        document.getElementById('pantalla-login').style.display = 'none';
        document.getElementById('pantalla-gestion').style.display = 'block';
    }

    // CUADRO DISTANCIAS
    function verDistancia(ciudad) {
        document.getElementById('resultado-distancia').innerText = "Distancia a " + ciudad + ": Calculando...";
        document.getElementById('btn-cerrar-dist').style.display = 'inline-block';
    }
    
    function cerrarCuadro() {
        document.getElementById('resultado-distancia').innerText = "";
        document.getElementById('btn-cerrar-dist').style.display = 'none';
    }

    // SELFIE CON SERENITO (PARCHE)
    async function activarCamara() {
        const camara = document.getElementById('camara-full');
        camara.style.display = 'block';
        const stream = await navigator.mediaDevices.getUserMedia({ video: true });
        document.getElementById('video-preview').srcObject = stream;
    }

    function capturarFoto() {
        alert("隆Foto con Serenito capturada! Se guardar谩 en registros");
        cerrarCamara();
    }

    function cerrarCamara() {
        document.getElementById('camara-full').style.display = 'none';
        const stream = document.getElementById('video-preview').srcObject;
        stream.getTracks().forEach(track => track.stop());
    }

    function cargarHistorial() {
        const lista = document.getElementById('lista-historial');
        usuarioSimulado.historial.forEach(h => {
            lista.innerHTML += `<div>REQ #${h.id} - ${h.tipo} - <b>${h.status}</b></div>`;
        });
    }

    function salir() {
        location.reload(); // Salida perfecta
    }
</script>
</body>
</html>
