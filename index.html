<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>RDMLS | La Serena 2026</title>
    
    <link rel="icon" id="dynamic-favicon" type="image/png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.babylonjs.com/babylon.js"></script>
    <script src="https://cdn.babylonjs.com/loaders/babylonjs.loaders.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@400;700&family=Roboto:wght@300;400;700&display=swap" rel="stylesheet">

    <style>
        :root { --serena-red: #b71c1c; --serena-gold: #ffd700; --dark: #0f0f0f; --panel: #111; }
        body, html { margin: 0; padding: 0; font-family: 'Roboto', sans-serif; background: var(--dark); color: white; width: 100%; height: 100%; }

        @media (min-width: 1024px) {
            body { overflow: hidden; } 
            #main-layout { display: grid; width: 100vw; height: 100vh; grid-template-columns: 360px 1fr 360px; grid-template-rows: 100%; }
            #sidebar-wrapper { background: linear-gradient(180deg, #b71c1c 0%, #5f0000 100%); padding: 20px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: var(--serena-gold) #222; box-shadow: 4px 0 20px rgba(0,0,0,0.6); z-index: 50; }
            #stage-area { height: 100%; position: relative; }
            #form-panel { background: var(--panel); padding: 20px; overflow-y: auto; border-left: 1px solid #333; scrollbar-width: thin; scrollbar-color: var(--serena-gold) #222; }
            #mobile-footer { display: none; }
        }

        @media (max-width: 1023px) {
            body { overflow-y: auto; overflow-x: hidden; }
            #main-layout { display: flex; flex-direction: column; width: 100%; min-height: 100vh; }
            #sidebar-header { padding: 15px; background: linear-gradient(180deg, #b71c1c 0%, #8e0000 100%); text-align: center; }
            #stage-area { height: 50vh !important; border-top: 2px solid var(--serena-gold); border-bottom: 2px solid var(--serena-gold); }
            #form-panel { padding: 20px; background: var(--panel); padding-bottom: 80px; }
            #mobile-footer { display: block; padding: 30px; text-align: center; background: #0f0f0f; border-top: 1px solid #333; }
        }

        .escudo-img { width: 120px; margin: 0 auto; display: block; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.6)); }
        .rdmls-sigla { font-family: 'Oswald'; font-size: 42px; margin: 5px 0; text-align: center; text-shadow: 2px 2px 0 #000; }
        .clock { font-family: 'Oswald'; font-size: 26px; color: var(--serena-gold); text-align: center; margin-bottom: 15px; }
        
        .route-box { background: rgba(0,0,0,0.3); padding: 15px; border-radius: 12px; border-left: 4px solid var(--serena-gold); }
        .search-row { display: flex; gap: 5px; margin-bottom: 10px; }
        .city-input { flex: 1; padding: 10px; border-radius: 4px; border: 1px solid #555; background: #222; color: white; }
        .go-btn { background: var(--serena-gold); color: black; border: none; padding: 0 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .chip { background: #333; padding: 6px 12px; font-size: 11px; border-radius: 20px; cursor: pointer; border: 1px solid #555; color: #ccc; margin: 2px; display: inline-block; white-space: nowrap; }
        .chip:hover { border-color: var(--serena-gold); color: white; }

        .trans-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: rgba(0,0,0,0.5); border-radius: 6px; font-size: 13px; margin-top: 5px; border-bottom: 1px solid #444; }
        .trans-icon { color: var(--serena-gold); margin-right: 10px; width: 20px; text-align: center; }

        #map { width: 100%; height: 100%; z-index: 1; }
        #renderCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; pointer-events: none; }
        .btn-tour { position: absolute; bottom: 20px; left: 20px; z-index: 20; background: var(--serena-gold); color: black; font-weight: bold; padding: 10px 20px; border-radius: 8px; border: 2px solid white; cursor: pointer; }

        /* MODALES */
        #modal-camara { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 30000; align-items: center; justify-content: center; flex-direction: column; }
        #camera-wrapper { position: relative; width: 90%; max-width: 400px; border: 2px solid gold; border-radius: 10px; overflow: hidden; background: #000; }
        #cam-video { width: 100%; display: block; transform: scaleX(-1); }
        #cam-overlay { position: absolute; bottom: 0; right: 0; width: 50%; pointer-events: none; z-index: 10; filter: drop-shadow(0 0 10px rgba(0,0,0,0.5)); }
        
        .zoom-control { margin-top: 15px; width: 80%; text-align: center; }
        .zoom-control input { width: 100%; cursor: pointer; accent-color: var(--serena-gold); }

        .close-btn { position: absolute; top: 30px; right: 30px; font-size: 40px; color: white; cursor: pointer; background: var(--serena-red); width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid white; }
    </style>
</head>
<body>

    <div id="main-layout">
        <div id="sidebar-wrapper">
            <div id="sidebar-header">
                <img src="escudo.png" class="escudo-img">
                <h1 class="rdmls-sigla">RDMLS</h1>
                <div class="clock" id="clock">00:00:00</div>
                <div style="text-align:center;">
                    <button onclick="toggleRadio()" style="background:white; color:var(--serena-red); border:none; width:60px; height:60px; border-radius:50%; cursor:pointer; display:flex; align-items:center; justify-content:center; margin:0 auto;"><i class="fas fa-play" id="play-icon" style="margin-left:4px;"></i></button>
                </div>
            </div>

            <div id="sidebar-tools" style="margin-top:20px;">
                <div class="route-box">
                    <div style="font-size:11px; color:var(--serena-gold); font-weight:bold; margin-bottom:10px;">PLANIFICADOR DE VIAJES</div>
                    <div class="search-row">
                        <input type="text" id="city-input" class="city-input" placeholder="¿A dónde vamos hoy?">
                        <button class="go-btn" onclick="buscarYCalcular()"><i class="fas fa-search"></i></button>
                    </div>
                    <div class="chip-container">
                        <div class="chip" onclick="calcDirect(-30.0330, -70.7081, 'Vicuña')">Vicuña</div>
                        <div class="chip" onclick="calcDirect(-30.2292, -71.0851, 'Andacollo')">Andacollo</div>
                        <div class="chip" onclick="calcDirect(-29.9533, -71.3395, 'Coquimbo')">Coquimbo</div>
                        <div class="chip" onclick="calcDirect(-30.6046, -71.2045, 'Ovalle')">Ovalle</div>
                    </div>
                    <div class="route-list" id="route-output"></div>
                    <button id="btn-reset-route" style="width:100%; background:#ff3d00; color:white; border:none; padding:8px; border-radius:5px; margin-top:10px; cursor:pointer; font-weight:bold; display:none;" onclick="resetRoute()">CERRAR RUTA</button>
                </div>

                <div style="margin-top:20px;">
                    <button onclick="abrirCamara()" style="width:100%; background:#222; border:1px solid gold; color:gold; padding:12px; border-radius:8px; cursor:pointer; font-weight:bold;">
                        <i class="fas fa-camera"></i> SELFIE CON SERENITO
                    </button>
                </div>
            </div>
        </div>

        <div id="stage-area">
            <div id="map"></div>
            <canvas id="renderCanvas"></canvas>
            <button class="btn-tour" onclick="abrirTourReal()"><i class="fas fa-street-view"></i> PASEO 3D</button>
        </div>

        <div id="form-panel">
            <h4 style="color:var(--serena-gold);">CENTRAL DE REQUERIMIENTOS</h4>
            <input type="text" id="r-dir" class="city-input" style="width:100%; margin-bottom:10px;" readonly placeholder="Ubicación detectada...">
            <input type="text" id="r-asunto" class="city-input" style="width:100%; margin-bottom:10px;" placeholder="Asunto">
            <textarea id="r-desc" class="city-input" style="width:100%; height:80px;" placeholder="Descripción..."></textarea>
            <button onclick="alert('Enviado a Municipalidad')" style="width:100%; background:var(--serena-red); color:white; padding:12px; border:none; border-radius:8px; font-weight:bold; margin-top:10px; cursor:pointer;">ENVIAR REPORTE</button>
        </div>
    </div>

    <div id="modal-camara">
        <div class="close-btn" onclick="cerrarCamara()">&times;</div>
        <div id="camera-wrapper">
            <video id="cam-video" autoplay playsinline></video>
            <img id="cam-overlay" src="serenito.png" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3660/3660358.png'"> 
        </div>
        <div class="zoom-control">
            <label style="color:gold; font-size:12px;">ACERCAR / ALEJAR SERENITO</label><br>
            <input type="range" id="serenito-zoom" min="20" max="90" value="50" oninput="ajustarZoomSerenito(this.value)">
        </div>
        <button onclick="tomarFoto()" style="margin-top:20px; background:gold; color:black; border:none; padding:15px 40px; border-radius:50px; font-weight:bold; cursor:pointer;"><i class="fas fa-camera"></i> CAPTURAR</button>
        <canvas id="foto-canvas" style="display:none;"></canvas>
    </div>

    <audio id="radio" src="https://az11.yesstreaming.net:8590/radio.mp3" crossorigin="anonymous"></audio>

    <script>
        const LS = [-29.9027, -71.2520];
        let map = L.map('map', {zoomControl:false}).setView(LS, 16);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(map);
        
        let serenitoMarker = L.marker(LS, {
            icon: L.divIcon({ 
                html: `<img src="serenito.png" style="width:50px; filter:drop-shadow(0 5px 5px rgba(0,0,0,0.5));" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3660/3660358.png'">`, 
                className: 'custom-serenito', iconSize: [50, 50], iconAnchor: [25, 50] 
            })
        }).addTo(map);

        let routePolyline = null, destMarker = null, videoStream = null;

        function initApp() {
            setInterval(() => document.getElementById('clock').innerText = new Date().toLocaleTimeString('en-GB'), 1000);
            fetchWeather();
        }

        // --- RADIO FIX ---
        function toggleRadio() {
            const r = document.getElementById('radio');
            const icon = document.getElementById('play-icon');
            if (r.paused) {
                r.play();
                icon.className = "fas fa-pause";
            } else {
                r.pause();
                icon.className = "fas fa-play";
            }
        }

        // --- RUTAS E ICONOS ASOCIADOS ---
        function calcDirect(lat, lon, name) {
            if(routePolyline) map.removeLayer(routePolyline);
            if(destMarker) map.removeLayer(destMarker);

            const start = LS, end = [lat, lon];
            routePolyline = L.polyline([start, end], {color: 'red', weight: 4, dashArray: '10, 10'}).addTo(map);
            destMarker = L.marker(end).addTo(map);
            map.fitBounds(routePolyline.getBounds(), {padding: [50, 50]});

            const R = 6371;
            const dLat = (lat-LS[0])*Math.PI/180;
            const dLon = (lon-LS[1])*Math.PI/180;
            const a = Math.sin(dLat/2)**2 + Math.cos(LS[0]*Math.PI/180)*Math.cos(lat*Math.PI/180)*Math.sin(dLon/2)**2;
            const dist = R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)) * 1.3;

            document.getElementById('route-output').innerHTML = `
                <div style="text-align:center; color:gold; margin:10px 0;"><b>Destino: ${name} (${dist.toFixed(0)} km)</b></div>
                <div class="trans-row"><i class="fas fa-car trans-icon"></i> Auto <span>${(dist/70).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-bus trans-icon"></i> Bus <span>${(dist/50).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-bicycle trans-icon"></i> Bici <span>${(dist/15).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-walking trans-icon"></i> Caminando <span>${(dist/5).toFixed(1)} h</span></div>
                <div class="trans-row"><i class="fas fa-plane trans-icon"></i> Avión <span>${(dist/800).toFixed(2)} h</span></div>
            `;
            document.getElementById('btn-reset-route').style.display = 'block';
        }

        function resetRoute() {
            if(routePolyline) map.removeLayer(routePolyline);
            if(destMarker) map.removeLayer(destMarker);
            document.getElementById('route-output').innerHTML = "";
            document.getElementById('btn-reset-route').style.display = 'none';
            map.flyTo(LS, 16);
        }

        // --- SELFIE CON ZOOM ---
        async function abrirCamara() {
            document.getElementById('modal-camara').style.display = 'flex';
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" } });
                document.getElementById('cam-video').srcObject = videoStream;
            } catch (err) { alert("Cámara no disponible"); cerrarCamara(); }
        }

        function ajustarZoomSerenito(val) {
            document.getElementById('cam-overlay').style.width = val + "%";
        }

        function cerrarCamara() {
            document.getElementById('modal-camara').style.display = 'none';
            if(videoStream) videoStream.getTracks().forEach(t => t.stop());
        }

        function tomarFoto() {
            const v = document.getElementById('cam-video'), c = document.getElementById('foto-canvas'), overlay = document.getElementById('cam-overlay');
            c.width = v.videoWidth; c.height = v.videoHeight;
            const ctx = c.getContext('2d');
            ctx.translate(c.width, 0); ctx.scale(-1, 1);
            ctx.drawImage(v, 0, 0, c.width, c.height);
            ctx.setTransform(1, 0, 0, 1, 0, 0);

            // Dibujar a Serenito con el tamaño ajustado
            const zoomPorcentaje = parseInt(document.getElementById('serenito-zoom').value) / 100;
            const oW = c.width * zoomPorcentaje;
            const aspect = overlay.naturalWidth / overlay.naturalHeight;
            const oH = oW / aspect;
            ctx.drawImage(overlay, c.width - oW - 10, c.height - oH, oW, oH);

            const link = document.createElement('a');
            link.download = 'selfie-serenito.png';
            link.href = c.toDataURL();
            link.click();
            cerrarCamara();
        }

        function fetchWeather() {
            fetch('https://api.open-meteo.com/v1/forecast?latitude=-29.90&longitude=-71.25&current_weather=true')
                .then(r => r.json()).then(d => {
                    // Actualización de clima...
                });
        }

        window.onload = initApp;
    </script>
</body>
</html>
