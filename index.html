<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vecinos La Serena - App Completa</title>
    <style>
        body { font-family: sans-serif; margin: 0; padding: 0; background-color: #f4f4f4; }
        .container { max-width: 480px; margin: 0 auto; background: white; min-height: 100vh; position: relative; }
        .pantalla { display: none; padding: 20px; }
        .activa { display: block; }
        
        /* Estilos Generales de Botones */
        button { width: 100%; padding: 12px; margin-top: 10px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; }
        .btn-primary { background-color: #007bff; color: white; }
        .btn-danger { background-color: #dc3545; color: white; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-staff { background-color: #2c3e50; color: white; border: 1px solid #1a252f; }
        .btn-camara { background-color: #ff9800; color: white; font-weight: bold; }

        /* Estilos de Listas y Tarjetas */
        .card-req { border: 1px solid #ddd; padding: 10px; margin-bottom: 10px; border-radius: 5px; background: #fff; }
        .estado-pendiente { color: orange; font-weight: bold; }
        .estado-resuelto { color: green; font-weight: bold; }

        /* Estilos C치mara y Overlay */
        #camara-container { position: relative; width: 100%; height: 400px; background: black; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        video { width: 100%; height: 100%; object-fit: cover; }
        #overlay-serenito {
            position: absolute;
            bottom: 0;
            right: 0;
            width: 150px; /* Tama침o del personaje */
            height: auto;
            z-index: 10;
            pointer-events: none; /* Permite hacer clic a trav칠s de la imagen */
        }
        .controles-camara { position: absolute; bottom: 20px; z-index: 20; width: 100%; text-align: center; }
        .btn-shoot { width: 60px; height: 60px; border-radius: 50%; background: white; border: 4px solid #ccc; display: inline-block; }

        /* Estilos Login Funcionario */
        .staff-login-area { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ccc; }
        
        /* Input Styles */
        input { width: 90%; padding: 10px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">

    <div id="vista-login" class="pantalla activa">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2>Vecinos La Serena</h2>
            <p>Bienvenido a tu plataforma vecinal</p>
        </div>

        <div id="form-vecino">
            <label>Ingreso Vecinos</label>
            <input type="text" id="rutUser" placeholder="RUT (ej: 11111111-1)">
            <button class="btn-primary" onclick="ingresarVecino()">Ingresar</button>
            <p style="font-size: 12px; color: #666;">* Usa 11111111-1 para probar usuario BLOQUEADO</p>
        </div>

        <div class="staff-login-area">
            <p style="text-align: center; font-size: 14px; font-weight: bold; color: #2c3e50;">Zona Administrativa</p>
            
            <button id="btn-toggle-staff" class="btn-staff" onclick="mostrarLoginStaff()">Soy Funcionario Municipal</button>

            <div id="form-staff" style="display: none; background: #eef2f5; padding: 15px; border-radius: 8px; margin-top: 10px;">
                <input type="text" id="staffUser" placeholder="Usuario Admin">
                <input type="password" id="staffPass" placeholder="Contrase침a">
                <button class="btn-success" style="background: green; color: white;" onclick="ingresarStaff()">Entrar al Sistema</button>
                <button class="btn-secondary" onclick="ocultarLoginStaff()" style="margin-top: 5px; font-size: 12px;">Cancelar</button>
            </div>
        </div>
    </div>

    <div id="vista-dashboard" class="pantalla">
        <h2>Hola, <span id="dash-nombre">Vecino</span></h2>
        
        <button class="btn-camara" onclick="abrirCamara()">游닞 Selfie con Serenito</button>
        
        <hr>
        <h3>Tus Requerimientos</h3>
        <div id="lista-reqs-activos"></div>
        
        <button class="btn-primary" onclick="alert('Funci칩n de nuevo reporte...')">Crear Nuevo Reporte</button>
        <button class="btn-danger" style="margin-top: 30px;" onclick="cerrarSesion()">Salir</button>
    </div>

    <div id="vista-bloqueado" class="pantalla" style="background-color: #fff3cd;">
        <h2 style="color: #856404;">丘멆잺 Cuenta Restringida</h2>
        <p>Estimado/a <span id="bloq-nombre"></span>, su cuenta se encuentra moment치neamente bloqueada para ingresar nuevas solicitudes.</p>
        
        <hr style="border-color: #856404;">
        <h3 style="color: #856404;">Tu Historial de Solicitudes:</h3>
        <div id="lista-reqs-bloqueado" style="max-height: 300px; overflow-y: auto; background: rgba(255,255,255,0.5); padding: 10px; border-radius: 5px;">
            </div>

        <button class="btn-danger" style="margin-top: 20px;" onclick="cerrarSesion()">Cerrar Sesi칩n</button>
    </div>

    <div id="vista-camara" class="pantalla" style="padding: 0; background: black; height: 100vh;">
        <div id="camara-container">
            <video id="videoElement" autoplay playsinline></video>
            
            <img src="serenito.png" id="overlay-serenito" alt="Serenito">
        </div>
        
        <div class="controles-camara">
            <button class="btn-shoot" onclick="tomarFoto()"></button>
            <br>
            <button class="btn-secondary" style="width: auto; margin-top: 10px;" onclick="volverDeCamara()">Volver</button>
        </div>
        <canvas id="canvasFoto" style="display: none;"></canvas>
    </div>

    <div id="vista-gestion" class="pantalla">
        <h2 style="color: #2c3e50;">Panel de Gesti칩n</h2>
        <p>Bienvenido, Funcionario.</p>
        
        <div style="background: #eef; padding: 10px; border-radius: 5px;">
            <h4>Requerimientos Entrantes</h4>
            <div id="lista-gestion-admin">
                <div class="card-req">
                    <strong>Usuario Bloqueado (Rodrigo)</strong><br>
                    <small>Solicitud de desbloqueo / Luminaria</small><br>
                    <button style="width:auto; font-size: 12px; background: green; color: white;">Responder</button>
                </div>
            </div>
        </div>

        <button class="btn-danger" style="margin-top: 20px;" onclick="cerrarSesion()">Cerrar Sistema</button>
    </div>

</div>

<script>
    // --- DATOS DE EJEMPLO ---
    const DB = {
        usuarios: [
            { 
                rut: "11111111-1", 
                nombre: "Rodrigo Godoy", 
                bloqueado: true, 
                historial: [
                    { fecha: "20-02-2026", tipo: "Luminaria", estado: "Resuelto", detalle: "Poste apagado en la plaza" },
                    { fecha: "21-02-2026", tipo: "Aseo", estado: "Pendiente", detalle: "Basura acumulada" }
                ] 
            },
            { 
                rut: "22222222-2", 
                nombre: "Vecino Activo", 
                bloqueado: false, 
                historial: [
                    { fecha: "23-02-2026", tipo: "Seguridad", estado: "En Proceso", detalle: "Ronda solicitada" }
                ] 
            }
        ],
        funcionarios: [
            { user: "admin", pass: "1234", nombre: "Gesti칩n Municipal" }
        ]
    };

    let usuarioActual = null;
    let stream = null;

    // --- NAVEGACI칍N ---
    function mostrarPantalla(idPantalla) {
        // Ocultar todas
        document.querySelectorAll('.pantalla').forEach(p => p.classList.remove('activa'));
        // Mostrar la deseada
        document.getElementById(idPantalla).classList.add('activa');
    }

    // --- FUNCIONES DE LOGIN ---
    
    // Toggle para mostrar/ocultar login de funcionarios
    function mostrarLoginStaff() {
        document.getElementById('btn-toggle-staff').style.display = 'none';
        document.getElementById('form-staff').style.display = 'block';
    }
    
    function ocultarLoginStaff() {
        document.getElementById('form-staff').style.display = 'none';
        document.getElementById('btn-toggle-staff').style.display = 'block';
    }

    function ingresarVecino() {
        const rut = document.getElementById('rutUser').value;
        const usuario = DB.usuarios.find(u => u.rut === rut);

        if (usuario) {
            usuarioActual = usuario;
            if (usuario.bloqueado) {
                // Si est치 bloqueado, vamos a la pantalla de bloqueo
                cargarDatosBloqueado(); // <--- Cargar historial
                mostrarPantalla('vista-bloqueado');
            } else {
                // Si est치 activo, vamos al dashboard
                document.getElementById('dash-nombre').innerText = usuario.nombre;
                cargarHistorial('lista-reqs-activos');
                mostrarPantalla('vista-dashboard');
            }
        } else {
            alert('Usuario no encontrado. Intente con 11111111-1');
        }
    }

    function ingresarStaff() {
        const u = document.getElementById('staffUser').value;
        const p = document.getElementById('staffPass').value;
        const funcionario = DB.funcionarios.find(f => f.user === u && f.pass === p);

        if (funcionario) {
            usuarioActual = funcionario;
            mostrarPantalla('vista-gestion');
        } else {
            alert('Credenciales incorrectas (Prueba: admin / 1234)');
        }
    }

    function cerrarSesion() {
        usuarioActual = null;
        detenerCamara(); // Por si acaso qued칩 encendida
        
        // Limpiar inputs
        document.getElementById('rutUser').value = '';
        document.getElementById('staffUser').value = '';
        document.getElementById('staffPass').value = '';
        
        // Resetear visualizaci칩n de staff
        ocultarLoginStaff();
        
        mostrarPantalla('vista-login');
    }

    // --- CARGA DE DATOS E HISTORIAL ---
    
    function cargarDatosBloqueado() {
        document.getElementById('bloq-nombre').innerText = usuarioActual.nombre;
        // Aqu칤 es donde mostramos el historial al usuario bloqueado
        cargarHistorial('lista-reqs-bloqueado');
    }

    function cargarHistorial(contenedorId) {
        const contenedor = document.getElementById(contenedorId);
        contenedor.innerHTML = ''; // Limpiar

        if (!usuarioActual.historial || usuarioActual.historial.length === 0) {
            contenedor.innerHTML = '<p>No hay requerimientos registrados.</p>';
            return;
        }

        usuarioActual.historial.forEach(req => {
            const div = document.createElement('div');
            div.className = 'card-req';
            div.innerHTML = `
                <div style="display:flex; justify-content:space-between;">
                    <strong>${req.tipo}</strong>
                    <span class="${req.estado === 'Resuelto' ? 'estado-resuelto' : 'estado-pendiente'}">${req.estado}</span>
                </div>
                <small>${req.fecha}</small><br>
                <span style="color:#555;">${req.detalle}</span>
            `;
            contenedor.appendChild(div);
        });
    }

    // --- C츼MARA Y SELFIE ---

    async function abrirCamara() {
        mostrarPantalla('vista-camara');
        const video = document.getElementById('videoElement');
        try {
            stream = await navigator.mediaDevices.getUserMedia({ 
                video: { facingMode: "user" }, // "user" para c치mara frontal
                audio: false 
            });
            video.srcObject = stream;
        } catch (err) {
            console.error(err);
            alert("No se pudo acceder a la c치mara. Revisa permisos o conexi칩n HTTPS.");
            volverDeCamara();
        }
    }

    function detenerCamara() {
        if (stream) {
            stream.getTracks().forEach(track => track.stop());
            stream = null;
        }
    }

    function volverDeCamara() {
        detenerCamara();
        // Volver a donde corresponda (en este caso Dashboard porque solo activos pueden tomar fotos)
        mostrarPantalla('vista-dashboard');
    }

    function tomarFoto() {
        const video = document.getElementById('videoElement');
        const canvas = document.getElementById('canvasFoto');
        const imgOverlay = document.getElementById('overlay-serenito');
        const ctx = canvas.getContext('2d');

        // Configurar tama침o del canvas igual al video
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;

        // 1. Dibujar Video
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

        // 2. Dibujar Overlay (Serenito)
        // Calculamos posici칩n relativa para que se vea igual que en pantalla
        // El CSS dice width: 150px. Calculamos proporci칩n respecto al ancho visual del container
        // Para simplificar en este ejemplo, lo pondremos fijo en la esquina inferior derecha del canvas
        
        const anchoPersonaje = canvas.width * 0.35; // 35% del ancho de la foto
        const altoPersonaje = (imgOverlay.naturalHeight / imgOverlay.naturalWidth) * anchoPersonaje;
        
        const x = canvas.width - anchoPersonaje - 20;
        const y = canvas.height - altoPersonaje - 20;

        ctx.drawImage(imgOverlay, x, y, anchoPersonaje, altoPersonaje);

        // Notificaci칩n
        alert("춰Foto capturada con Serenito! (Aqu칤 se enviar칤a al servidor)");
        
        // Opcional: Volver al dashboard
        volverDeCamara();
    }

</script>

</body>
</html>
